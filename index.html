<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta name="theme-color" content="#070a10" />
  <title>LIVE CHAT | SCARRY DEATH</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet" />

  <style>
    :root{
      --text:#f2f6ff;
      --muted:#8ea0bf;
      --muted2:#5a6a86;

      --panel: rgba(12, 16, 24, .66);
      --panel2: rgba(18, 22, 32, .70);
      --border: rgba(120,200,255,.16);

      --glow: 0 0 18px rgba(40,160,255,.25);
      --glow2: 0 0 36px rgba(40,160,255,.28);

      --fontH:'Orbitron',sans-serif;
      --fontB:'Share Tech Mono',monospace;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:var(--fontB);-webkit-tap-highlight-color:transparent}
    body{
      height:100dvh;
      color:var(--text);
      overflow:hidden;
      display:flex;
      justify-content:center;
      background:
        radial-gradient(1200px 650px at 18% 5%, rgba(25,120,255,.24), transparent 62%),
        radial-gradient(900px 600px at 82% 12%, rgba(0,255,255,.12), transparent 58%),
        radial-gradient(950px 700px at 45% 102%, rgba(0,90,255,.18), transparent 60%),
        linear-gradient(180deg, #05070d 0%, #070a10 100%);
    }

    /* ===== Ultra Premium 3D BG ===== */
    .bg-anim{position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:0;}
    .bg-grid{
      position:absolute;
      inset:-25%;
      transform: perspective(900px) rotateX(58deg) rotateZ(-18deg);
      transform-origin:center;
      opacity:.75;
      animation: drift 14s ease-in-out infinite;
      will-change: transform;
      filter: drop-shadow(0 30px 70px rgba(0,0,0,.75));
    }
    @keyframes drift{
      0%   { transform: perspective(900px) rotateX(58deg) rotateZ(-18deg) translate3d(0,0,0); }
      50%  { transform: perspective(900px) rotateX(60deg) rotateZ(-16deg) translate3d(-26px, 30px, 0); }
      100% { transform: perspective(900px) rotateX(58deg) rotateZ(-18deg) translate3d(0,0,0); }
    }

    .cube{
      position:absolute;
      border-radius: 16px;
      background:
        linear-gradient(135deg, rgba(30,170,255,.46), rgba(0,110,255,.18)),
        radial-gradient(140px 110px at 25% 20%, rgba(120,220,255,.35), transparent 58%),
        radial-gradient(160px 140px at 70% 80%, rgba(0,160,255,.12), transparent 60%);
      border: 1px solid rgba(140,220,255,.18);
      box-shadow:
        0 0 0 1px rgba(0,0,0,.20) inset,
        0 18px 40px rgba(0,0,0,.60),
        0 0 30px rgba(40,160,255,.18);
      backdrop-filter: blur(2px);
      transform-style: preserve-3d;
      animation: floaty var(--dur) ease-in-out infinite;
      opacity: var(--op);
      will-change: transform, opacity;
    }
    .cube::before{
      content:"";
      position:absolute; inset:10px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,0));
      transform: translateZ(18px);
      box-shadow: 0 0 22px rgba(40,160,255,.18);
    }
    .cube::after{
      content:"";
      position:absolute; inset:-2px;
      border-radius: 16px;
      background: radial-gradient(180px 140px at 30% 25%, rgba(40,160,255,.24), transparent 62%);
      filter: blur(12px);
      opacity:.85;
    }
    @keyframes floaty{
      0%   { transform: translate3d(var(--x), var(--y), 0) rotateZ(var(--rz)) rotateX(10deg) rotateY(14deg); }
      50%  { transform: translate3d(calc(var(--x) + var(--dx)), calc(var(--y) + var(--dy)), 0) rotateZ(calc(var(--rz) + 10deg)) rotateX(14deg) rotateY(20deg); }
      100% { transform: translate3d(var(--x), var(--y), 0) rotateZ(var(--rz)) rotateX(10deg) rotateY(14deg); }
    }

    /* Subtle stars */
    .stars{
      position:absolute; inset:0;
      background-image: radial-gradient(rgba(120,200,255,.10) 1px, transparent 1px);
      background-size: 24px 24px;
      opacity:.55;
      mix-blend-mode: screen;
    }

    /* App */
    .app-container{display:flex;width:100%;height:100%;max-width:1600px;position:relative;z-index:1}

    /* Scrollbar */
    ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14);border-radius:999px}
    ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.22)}

    /* Sidebar */
    .sidebar{
      width:310px;height:100%;
      background: var(--panel);
      border-right:1px solid rgba(255,255,255,.08);
      display:flex;flex-direction:column;flex-shrink:0;
      transition:transform .3s cubic-bezier(.4,0,.2,1);z-index:50;
      backdrop-filter: blur(16px);
      box-shadow: 22px 0 70px rgba(0,0,0,.38);
    }

    .user-card{
      background: var(--panel2);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:22px 18px;
      display:flex;flex-direction:column;align-items:center;
      box-shadow: inset 0 -1px 0 rgba(255,255,255,.06);
    }

    /* Avatar (supports image) */
    .user-avatar{
      width:76px;height:76px;margin-bottom:12px;border-radius:18px;
      background: radial-gradient(110px 80px at 30% 20%, rgba(60,200,255,.22), rgba(0,0,0,.92));
      border: 1px solid rgba(140,220,255,.18);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--fontH);font-size:22px;color:#fff;font-weight:800;
      box-shadow: 0 18px 45px rgba(0,0,0,.55), 0 0 26px rgba(40,160,255,.18);
      position:relative; overflow:hidden;
    }
    .user-avatar img{
      width:100%;height:100%;object-fit:cover;border-radius:18px;display:block;
    }
    .avatar-edit{
      position:absolute; bottom:8px; right:8px;
      width:28px; height:28px;
      border-radius:10px;
      border:1px solid rgba(120,200,255,.20);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      display:flex;align-items:center;justify-content:center;
      color:rgba(200,235,255,.95);
      box-shadow: 0 12px 22px rgba(0,0,0,.45), var(--glow);
      cursor:pointer;
    }
    .avatar-edit:active{transform:scale(.98)}

    .user-name{
      font-family:var(--fontH);
      font-size:18px;
      letter-spacing:1.4px;
      margin-bottom:8px;
      text-shadow: 0 0 22px rgba(40,160,255,.16);
    }

    .user-role{
      font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:1.8px;
      padding:7px 12px;border-radius:999px;margin-bottom:12px;display:inline-block;
      border:1px solid rgba(120,200,255,.16);
      background: rgba(0,0,0,.25);
      box-shadow: 0 0 18px rgba(40,160,255,.10);
      color:#cfe7ff;
    }

    .user-status{
      font-size:12px;color:rgba(180,200,235,.72);
      display:flex;align-items:center;gap:8px
    }
    .status-dot{width:8px;height:8px;background:#4ade80;border-radius:50%;box-shadow:0 0 10px rgba(74,222,128,.45)}

    /* Profile actions (Logout) */
    .profile-actions{
      width:100%;
      display:flex;
      gap:10px;
      margin-top:14px;
    }
    .btn-mini{
      flex:1;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(120,200,255,.14);
      background: rgba(0,0,0,.30);
      color: rgba(210,235,255,.92);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:8px;
      box-shadow: 0 14px 26px rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
      letter-spacing:1px;
      font-size:12px;
      text-transform:uppercase;
      font-family: var(--fontH);
    }
    .btn-mini:hover{background: rgba(40,160,255,.10); box-shadow: 0 18px 40px rgba(0,0,0,.45), var(--glow);}
    .btn-danger{border-color: rgba(248,113,113,.25); color: rgba(255,190,190,.95);}
    .btn-danger:hover{background: rgba(248,113,113,.10);}

    /* Online list */
    .online-users{flex:1;overflow:hidden;display:flex;flex-direction:column}
    .section-header{
      padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08);
      font-family:var(--fontH);font-size:12px;color:rgba(170,195,235,.85);
      text-transform:uppercase;letter-spacing:2px;display:flex;justify-content:space-between;
      background: rgba(0,0,0,.10);backdrop-filter: blur(16px);
    }
    .users-list{flex:1;overflow-y:auto;padding:10px}
    .user-item{
      display:flex;align-items:center;gap:12px;
      padding:12px;border-radius:14px;margin-bottom:6px;
      transition: transform .15s, background .15s, border-color .15s;
      cursor:pointer;border:1px solid transparent;
      background: rgba(0,0,0,.12);
    }
    .user-item:hover{
      background: rgba(40,160,255,.10);
      border-color: rgba(120,200,255,.20);
      transform: translateY(-2px);
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .item-avatar{
      width:34px;height:34px;border-radius:12px;
      background: radial-gradient(60px 60px at 30% 25%, rgba(120,220,255,.18), rgba(0,0,0,.55));
      border:1px solid rgba(120,220,255,.14);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--fontH);font-size:12px;color:#bfe9ff;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
    }
    .item-info h4{font-size:13px;color:var(--text)}
    .item-info span{font-size:11px;color:rgba(140,160,200,.70);text-transform:uppercase;letter-spacing:1px}

    /* Chat */
    .chat-area{flex:1;display:flex;flex-direction:column;position:relative;width:100%}
    .chat-header{
      padding:15px 18px;border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;justify-content:space-between;align-items:center;
      background: rgba(10, 12, 18, .58);
      backdrop-filter: blur(16px);
      z-index:10;flex-shrink:0;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .menu-toggle{display:none;background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;margin-right:12px;padding:5px}
    .brand-title{
      font-family:var(--fontH);font-size:18px;font-weight:800;
      letter-spacing:2px;display:flex;align-items:center;
      text-shadow: 0 0 24px rgba(40,160,255,.18);
    }
    .brand-chip{
      margin-left:10px;font-size:10px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(120,200,255,.20);
      background: rgba(40,160,255,.10);
      color:#cfe7ff;
      letter-spacing:1.6px;
      text-transform:uppercase;
      box-shadow: 0 0 18px rgba(40,160,255,.16);
    }
    .stats-container{display:flex;gap:18px;font-size:13px;color:rgba(140,160,200,.75)}
    .stats-item i{margin-right:6px;color:rgba(120,200,255,.75)}

    .messages-container{
      flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:16px;
      min-height:0;
    }

    .system-message{
      align-self:center;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(120,200,255,.15);
      padding:8px 16px;border-radius:999px;font-size:11px;color:rgba(185,205,235,.92);
      text-transform:uppercase;letter-spacing:1.6px;
      box-shadow: 0 0 22px rgba(40,160,255,.12);
      backdrop-filter: blur(10px);
      display:flex; align-items:center; gap:10px;
    }

    .message{max-width:75%;display:flex;flex-direction:column;animation:fadeIn .25s ease}
    .message.own{align-self:flex-end;align-items:flex-end}
    .message.other{align-self:flex-start;align-items:flex-start}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    .msg-meta{
      margin-bottom:6px;font-size:11px;color:rgba(140,160,200,.80);
      font-family:var(--fontH);display:flex;gap:8px;align-items:center
    }
    .msg-role-badge{font-size:9px;font-weight:900;padding:3px 7px;border-radius:7px;margin-left:6px;letter-spacing:.9px;text-shadow:0 1px 2px rgba(0,0,0,.55)}
    .badge-owner{background:linear-gradient(135deg,#ffd700,#ffaa00);color:#000;box-shadow:0 0 10px rgba(255,215,0,.35)}
    .badge-admin{background:linear-gradient(135deg,#00e5ff,#0077ff);color:#000;box-shadow:0 0 10px rgba(0,229,255,.35)}
    .badge-user{background:rgba(0,0,0,.35);color:#bfe9ff;border:1px solid rgba(120,200,255,.14)}

    .msg-bubble{
      padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.55;
      position:relative;word-break:break-word;
      box-shadow: 0 14px 30px rgba(0,0,0,.30);
      backdrop-filter: blur(12px);
    }
    .message.own .msg-bubble{background: rgba(255,255,255,.92);color:#00121f;border-radius:16px 16px 0 16px}
    .message.other .msg-bubble{background: rgba(18, 24, 36, .72);color:#fff;border:1px solid rgba(120,200,255,.12);border-radius:16px 16px 16px 0}
    .msg-bubble img{max-width:100%;border-radius:14px;margin-top:10px;cursor:pointer;border:1px solid rgba(255,255,255,.12);display:block;box-shadow:0 18px 45px rgba(0,0,0,.55)}

    /* Input */
    .input-area{
      padding:14px 16px;border-top:1px solid rgba(255,255,255,.08);
      background: rgba(10, 12, 18, .58);
      display:flex;gap:12px;align-items:flex-end;flex-shrink:0;
      backdrop-filter: blur(16px);
    }
    .input-wrapper{flex:1;display:flex;flex-direction:column;gap:8px;min-width:0;overflow:hidden;max-height:130px}
    .file-preview{
      display:none;background:rgba(0,0,0,.35);
      border:1px solid rgba(120,200,255,.12);
      padding:8px 12px;border-radius:14px;align-items:center;gap:10px;
      font-size:12px;color:rgba(180,200,235,.85);flex-shrink:0;width:100%;
      box-shadow: 0 0 18px rgba(40,160,255,.08);
    }
    .file-preview.active{display:flex}
    .file-preview i{color:rgba(120,200,255,.9);flex-shrink:0}
    #fileName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .remove-file{margin-left:auto;cursor:pointer;color:rgba(255,255,255,.45);flex-shrink:0}

    textarea#messageInput{
      width:100%;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(120,200,255,.16);
      border-radius:16px;color:#fff;padding:14px;
      font-size:14px;resize:none;min-height:52px;
      transition:border .2s, box-shadow .2s;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    textarea#messageInput:focus{outline:none;border-color: rgba(120,200,255,.85); box-shadow: 0 0 0 3px rgba(120,200,255,.12);}

    .btn-group{display:flex;gap:10px;flex-shrink:0;align-self:flex-end}
    .icon-btn{
      width:52px;height:52px;border-radius:16px;
      border:1px solid rgba(120,200,255,.14);
      background: rgba(0,0,0,.35);
      color: rgba(170,210,255,.95);
      cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;
      transition:transform .15s, background .15s, box-shadow .15s;
      box-shadow: 0 14px 26px rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
    }
    .icon-btn:hover{background: rgba(40,160,255,.12); transform: translateY(-2px); box-shadow: 0 18px 40px rgba(0,0,0,.45), var(--glow);}
    .btn-send{
      background: linear-gradient(135deg, rgba(140,230,255,.95), rgba(60,160,255,.95));
      color:#00121f;border:none;font-weight:900;
      box-shadow: 0 18px 40px rgba(0,0,0,.45), 0 0 26px rgba(40,160,255,.18);
    }

    /* Overlays */
    .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:40;backdrop-filter:blur(2px)}
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.95);z-index:1000;justify-content:center;align-items:center}
    .modal-overlay.active{display:flex}
    .modal-img{max-width:95%;max-height:90vh;object-fit:contain;border-radius:14px;border:1px solid rgba(120,200,255,.14);cursor:zoom-out;box-shadow:0 30px 80px rgba(0,0,0,.65)}

    /* Connection badge */
    .connection-badge{
      position:fixed;top:18px;right:18px;padding:8px 12px;border-radius:999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(120,200,255,.14);
      font-size:10px;font-family:var(--fontH);
      display:flex;align-items:center;gap:7px;
      z-index:999;
      box-shadow: 0 18px 45px rgba(0,0,0,.45), var(--glow);
      backdrop-filter: blur(16px);
      letter-spacing:1.6px;
      text-transform:uppercase;
    }
    .connection-badge.connected{border-color:rgba(74,222,128,.45);color:#9dffbf}
    .connection-badge.disconnected{border-color:rgba(248,113,113,.55);color:#ffb2b2}
    .connection-badge.connecting{border-color:rgba(250,204,21,.55);color:#ffeaa0}

    /* LOGIN */
    .login-overlay{position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px}
    .login-overlay.active{display:flex}
    .login-card{
      width:100%;max-width:460px;
      background: rgba(12, 16, 24, .70);
      border: 1px solid rgba(120,200,255,.16);
      border-radius:20px;
      padding:22px;
      box-shadow: 0 30px 90px rgba(0,0,0,.65), var(--glow2);
      backdrop-filter: blur(18px);
    }
    .login-title{font-family:var(--fontH);letter-spacing:2px;font-size:18px;margin-bottom:8px}
    .login-sub{color:rgba(190,205,235,.85);font-size:12px;line-height:1.6;margin-bottom:16px}
    .login-row{display:flex;gap:10px}
    .login-input{
      flex:1;background: rgba(0,0,0,.55);
      border:1px solid rgba(120,200,255,.16);
      border-radius:16px;color:#fff;padding:12px 12px;font-size:14px
    }
    .login-input:focus{outline:none;border-color:rgba(120,200,255,.85);box-shadow:0 0 0 3px rgba(120,200,255,.12)}
    .login-btn{
      padding:12px 14px;border-radius:16px;border:none;
      background: linear-gradient(135deg, rgba(140,230,255,.95), rgba(60,160,255,.95));
      color:#00121f;font-weight:900;cursor:pointer;
      font-family:var(--fontH);letter-spacing:1.6px;text-transform:uppercase;
      box-shadow: 0 18px 40px rgba(0,0,0,.45), 0 0 26px rgba(40,160,255,.18);
    }
    .login-hint{margin-top:12px;color:rgba(140,160,200,.70);font-size:11px}

    /* Music floating button */
    .music-btn{
      position: fixed;
      left: 18px;
      bottom: 18px;
      z-index: 1100;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(120,200,255,.16);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(16px);
      box-shadow: 0 18px 45px rgba(0,0,0,.45), var(--glow);
      display:flex; align-items:center; gap:8px;
      font-family: var(--fontH);
      font-size: 10px;
      letter-spacing: 1.6px;
      text-transform: uppercase;
      color: rgba(210,235,255,.95);
      cursor: pointer;
      user-select:none;
    }
    .music-btn[hidden]{display:none}
    .music-btn i{color: rgba(120,200,255,.95)}
    .music-dot{
      width:7px;height:7px;border-radius:999px;background:#4ade80;
      box-shadow:0 0 10px rgba(74,222,128,.45);
    }
    .music-dot.off{background:#f87171; box-shadow:0 0 10px rgba(248,113,113,.45);}

    /* Mobile */
    @media (max-width:900px){
      .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);width:290px;box-shadow: 18px 0 60px rgba(0,0,0,.85)}
      .sidebar.active{transform:translateX(0)}
      .sidebar-overlay.active{display:block}
      .menu-toggle{display:block}
      .stats-container{display:none}
      .message{max-width:90%}
      .input-area{padding:10px 12px;gap:8px}
      .icon-btn{width:46px;height:46px}
    }
  </style>
</head>

<body>
  <div class="bg-anim" aria-hidden="true">
    <div class="stars"></div>
    <div class="bg-grid" id="bgGrid"></div>
  </div>

  <!-- LOGIN -->
  <div class="login-overlay" id="loginOverlay" aria-hidden="true">
    <div class="login-card">
      <div class="login-title">LOGIN USERNAME</div>
      <div class="login-sub">
        Masukin username dulu biar nama kamu tampil di chat.<br/>
        (Disimpan di browser kamu)
      </div>
      <div class="login-row">
        <input id="loginUsername" class="login-input" maxlength="20" placeholder="contoh: rezaxd" autocomplete="off" />
        <button id="loginBtn" class="login-btn">Masuk</button>
      </div>
      <div class="login-hint">Tip: hanya huruf/angka/underscore, 3–20 karakter.</div>
    </div>
  </div>

  <!-- Music Button (fallback kalau autoplay diblok) -->
  <button class="music-btn" id="musicBtn" type="button" hidden>
    <span class="music-dot off" id="musicDot"></span>
    <i class="fa-solid fa-music"></i>
    <span id="musicText">TAP TO PLAY</span>
  </button>

  <div class="connection-badge connecting" id="connectionStatus">
    <i class="fas fa-wifi"></i><span>Connecting...</span>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Modal Preview -->
  <div class="modal-overlay" id="imageModal">
    <img id="modalImage" class="modal-img" src="" alt="Full Size" />
  </div>

  <div class="app-container">
    <div class="sidebar" id="sidebar">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">
          <span id="avatarText">ME</span>
          <img id="avatarImg" alt="avatar" style="display:none;">
          <button class="avatar-edit" id="avatarEdit" type="button" title="Ubah foto">
            <i class="fa-solid fa-camera"></i>
          </button>
        </div>

        <div class="user-name" id="myUsername">Loading...</div>
        <div class="user-role" id="myRoleBadge">USER</div>

        <div class="user-status">
          <div class="status-dot"></div>
          <span id="connectionText">Connecting...</span>
        </div>

        <div class="profile-actions">
          <button class="btn-mini" id="btnChangeName" type="button">
            <i class="fa-solid fa-pen-to-square"></i> NAME
          </button>
          <button class="btn-mini btn-danger" id="btnLogout" type="button">
            <i class="fa-solid fa-right-from-bracket"></i> LOGOUT
          </button>
        </div>
      </div>

      <div class="online-users">
        <div class="section-header">
          <span>Online Users</span>
          <span id="onlineCount">0</span>
        </div>
        <div class="users-list" id="userList"></div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header">
        <div style="display:flex;align-items:center;">
          <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
          <div class="brand-title">LIVE <span style="color:#6e7fa2">CHAT</span><span class="brand-chip">PREMIUM</span></div>
        </div>
        <div class="stats-container">
          <div class="stats-item"><i class="fas fa-users"></i> <span id="totalOnline">0</span></div>
          <div class="stats-item"><i class="fas fa-signal"></i> <span id="ping">0ms</span></div>
        </div>
      </div>

      <div class="messages-container" id="messages">
        <div class="system-message" id="welcomeMessage">
          <i class="fas fa-circle-notch fa-spin"></i> Waiting for login...
        </div>
      </div>

      <div class="typing-area" id="typingIndicator" style="display:none;">
        <div class="dots"><span></span><span></span><span></span></div>
        <span id="typingText">Someone is typing...</span>
      </div>

      <div class="input-area">
        <div class="input-wrapper">
          <div class="file-preview" id="filePreview">
            <i class="fas fa-image"></i>
            <span id="fileName">image.jpg</span>
            <i class="fas fa-times remove-file" id="removeFile"></i>
          </div>
          <textarea id="messageInput" placeholder="Type message (or select image)..." disabled></textarea>
        </div>
        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;">
        <input type="file" id="avatarFile" accept="image/*" style="display:none;">
        <div class="btn-group">
          <button class="icon-btn" id="attachButton" disabled><i class="fas fa-paperclip"></i></button>
          <button class="icon-btn btn-send" id="sendButton" disabled><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- SOCKET URL -->
  <script>
    // ganti ke domain https kamu kalau sudah dibuat reverse proxy
    // window.SOCKET_URL = "https://livechatscarrydeath.raraaprivate.my.id";
  </script>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <script>
    const MUSIC_URL = "https://files.catbox.moe/wlny2m.mp3";
    const SOCKET_URL = window.SOCKET_URL || window.location.origin;

    const STORAGE_KEY_USER = "ic_username";
    const STORAGE_KEY_AVATAR = "ic_avatar_dataurl";

    const els = {
      messages: document.getElementById("messages"),
      messageInput: document.getElementById("messageInput"),
      sendButton: document.getElementById("sendButton"),
      attachButton: document.getElementById("attachButton"),
      fileInput: document.getElementById("fileInput"),
      connectionStatus: document.getElementById("connectionStatus"),
      welcomeMessage: document.getElementById("welcomeMessage"),
      typingIndicator: document.getElementById("typingIndicator"),
      typingText: document.getElementById("typingText"),
      userList: document.getElementById("userList"),
      onlineCount: document.getElementById("onlineCount"),
      totalOnline: document.getElementById("totalOnline"),
      myUsername: document.getElementById("myUsername"),
      myRoleBadge: document.getElementById("myRoleBadge"),
      userAvatar: document.getElementById("userAvatar"),
      avatarText: document.getElementById("avatarText"),
      avatarImg: document.getElementById("avatarImg"),
      avatarEdit: document.getElementById("avatarEdit"),
      avatarFile: document.getElementById("avatarFile"),
      btnLogout: document.getElementById("btnLogout"),
      btnChangeName: document.getElementById("btnChangeName"),
      connectionText: document.getElementById("connectionText"),
      imageModal: document.getElementById("imageModal"),
      modalImage: document.getElementById("modalImage"),
      ping: document.getElementById("ping"),
      filePreview: document.getElementById("filePreview"),
      fileName: document.getElementById("fileName"),
      removeFile: document.getElementById("removeFile"),
      menuToggle: document.getElementById("menuToggle"),
      sidebar: document.getElementById("sidebar"),
      sidebarOverlay: document.getElementById("sidebarOverlay"),
      loginOverlay: document.getElementById("loginOverlay"),
      loginUsername: document.getElementById("loginUsername"),
      loginBtn: document.getElementById("loginBtn"),
      bgGrid: document.getElementById("bgGrid"),

      musicBtn: document.getElementById("musicBtn"),
      musicDot: document.getElementById("musicDot"),
      musicText: document.getElementById("musicText"),
    };

    let socket = null;
    let isConnected = false;
    let typingTimeout = null;
    let lastPing = Date.now();
    let pingInterval = null;
    let currentFile = null;
    let currentFileData = null;

    const myUser = { username: null, role: "user" };

    // ===== Music engine (loop forever) =====
    const audio = new Audio(MUSIC_URL);
    audio.loop = true;          // kunci: loop
    audio.preload = "auto";
    audio.volume = 0.7;

    function setMusicUI(isOn){
      els.musicBtn.hidden = false;
      els.musicDot.classList.toggle("off", !isOn);
      els.musicText.textContent = isOn ? "MUSIC ON" : "TAP TO PLAY";
    }

    async function tryAutoplayMusic(){
      try{
        await audio.play();
        setMusicUI(true);
      }catch(e){
        // autoplay diblok -> tampilkan tombol
        setMusicUI(false);
      }
    }

    els.musicBtn.addEventListener("click", async () => {
      try{
        await audio.play();
        setMusicUI(true);
      }catch(e){
        setMusicUI(false);
      }
    });

    // ===== Premium 3D blocks =====
    function buildBackgroundCubes(){
      const count = 16;
      const W = 1400, H = 980;
      els.bgGrid.innerHTML = "";
      for(let i=0;i<count;i++){
        const c = document.createElement("div");
        c.className = "cube";

        const x = Math.floor(Math.random() * W) - W/2;
        const y = Math.floor(Math.random() * H) - H/2;
        const dx = (Math.random()*80 - 40).toFixed(1) + "px";
        const dy = (Math.random()*80 - 40).toFixed(1) + "px";
        const rz = (Math.random()*46 - 23).toFixed(1) + "deg";
        const dur = (12 + Math.random()*10).toFixed(1) + "s";
        const op = (0.35 + Math.random()*0.50).toFixed(2);

        const size = 70 + Math.random()*110;
        c.style.width = size + "px";
        c.style.height = size + "px";

        c.style.setProperty("--x", x + "px");
        c.style.setProperty("--y", y + "px");
        c.style.setProperty("--dx", dx);
        c.style.setProperty("--dy", dy);
        c.style.setProperty("--rz", rz);
        c.style.setProperty("--dur", dur);
        c.style.setProperty("--op", op);
        c.style.animationDelay = (-Math.random()*12).toFixed(2) + "s";

        els.bgGrid.appendChild(c);
      }
    }

    function init() {
      buildBackgroundCubes();
      setupMobileListeners();
      setupEventListeners();
      autoresizeTextarea();

      // Try autoplay music when page opens
      tryAutoplayMusic();

      // Restore session
      const saved = (localStorage.getItem(STORAGE_KEY_USER) || "").trim();
      if (isValidUsername(saved)) {
        myUser.username = saved;
        afterLogin();
      } else {
        requireLogin();
      }
    }

    function requireLogin() {
      updateConnectionStatus("disconnected", "LOGIN REQUIRED");
      enableInput(false);
      els.welcomeMessage.style.display = "block";
      els.welcomeMessage.innerHTML = `<i class="fas fa-user-lock"></i> Please login (username)`;
      els.loginOverlay.classList.add("active");
      els.loginOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => els.loginUsername.focus(), 50);
    }

    function afterLogin() {
      els.loginOverlay.classList.remove("active");
      els.loginOverlay.setAttribute("aria-hidden", "true");
      updateUserDisplay();
      els.welcomeMessage.style.display = "block";
      els.welcomeMessage.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Connecting to server...`;
      connectSocket();
    }

    function isValidUsername(name) {
      return /^[A-Za-z0-9_]{3,20}$/.test(name);
    }

    function updateUserDisplay() {
      // username
      els.myUsername.textContent = myUser.username;

      // role badge
      els.myRoleBadge.textContent = myUser.role.toUpperCase();

      // avatar
      const savedAvatar = localStorage.getItem(STORAGE_KEY_AVATAR);
      if (savedAvatar) {
        els.avatarImg.src = savedAvatar;
        els.avatarImg.style.display = "block";
        els.avatarText.style.display = "none";
      } else {
        els.avatarImg.style.display = "none";
        els.avatarText.style.display = "block";
        els.avatarText.textContent = myUser.username.substring(0, 2).toUpperCase();
      }
    }

    function connectSocket() {
      if (!window.io) {
        updateConnectionStatus("disconnected", "Socket.IO client not loaded");
        return;
      }

      updateConnectionStatus("connecting", "CONNECTING...");
      enableInput(false);

      socket = io(SOCKET_URL, { transports: ["websocket", "polling"] });

      socket.on("connect", () => {
        isConnected = true;
        updateConnectionStatus("connected", "CONNECTED");
        socket.emit("chat:login", { username: myUser.username, role: myUser.role });

        els.welcomeMessage.innerHTML = `<i class="fas fa-check"></i> Connected as ${escapeHtml(myUser.username)}`;
        setTimeout(() => (els.welcomeMessage.style.display = "none"), 1800);

        startPingMonitor();
        enableInput(true);
      });

      socket.on("disconnect", () => {
        isConnected = false;
        updateConnectionStatus("disconnected", "DISCONNECTED");
        els.welcomeMessage.style.display = "block";
        els.welcomeMessage.innerHTML = `<i class="fas fa-times"></i> Disconnected`;
        stopPingMonitor();
        enableInput(false);
      });

      socket.on("chat:history", (history) => {
        els.messages.innerHTML = "";
        history.forEach((data) => (data.image ? addImageMessage(data) : addMessage(data)));
        scrollToBottom();
      });

      socket.on("chat:newMessage", (msg) => { addMessage(msg); scrollToBottom(); });

      socket.on("chat:userJoin", (data) => {
        addSystemMessage(`${escapeHtml(data.username)} joined`);
        els.onlineCount.textContent = data.onlineCount;
        els.totalOnline.textContent = data.onlineCount;
      });

      socket.on("chat:userLeave", (data) => {
        addSystemMessage(`${escapeHtml(data.username)} left`);
        els.onlineCount.textContent = data.onlineCount;
        els.totalOnline.textContent = data.onlineCount;
      });

      socket.on("chat:onlineUsers", (data) => {
        renderUserList(data.users);
        els.onlineCount.textContent = data.count;
        els.totalOnline.textContent = data.count;
      });

      socket.on("chat:userTyping", (data) => {
        if (data.username !== myUser.username) showTyping(data.username, data.isTyping);
      });

      socket.on("chat:image", (data) => { addImageMessage(data); scrollToBottom(); });

      socket.on("pong", () => { els.ping.textContent = (Date.now() - lastPing) + "ms"; });

      socket.on("connect_error", () => {
        updateConnectionStatus("disconnected", "CONNECT ERROR");
        enableInput(false);
        els.welcomeMessage.style.display = "block";
        els.welcomeMessage.innerHTML = `<i class="fas fa-triangle-exclamation"></i> Cannot connect to Socket server`;
      });
    }

    function setupEventListeners() {
      // login
      els.loginBtn.addEventListener("click", doLogin);
      els.loginUsername.addEventListener("keydown", (e) => { if (e.key === "Enter") doLogin(); });

      // avatar edit
      els.avatarEdit.addEventListener("click", () => els.avatarFile.click());
      els.avatarFile.addEventListener("change", handleAvatarSelect);

      // change name
      els.btnChangeName.addEventListener("click", () => {
        const newName = prompt("Ganti username (3-20, huruf/angka/_):", myUser.username || "");
        if(!newName) return;
        const clean = newName.trim();
        if(!isValidUsername(clean)) return alert("Username tidak valid.");
        myUser.username = clean;
        localStorage.setItem(STORAGE_KEY_USER, clean);
        updateUserDisplay();

        // reconnect/login ulang supaya server tau nama baru
        if(socket){
          try{ socket.disconnect(); }catch(e){}
        }
        connectSocket();
      });

      // logout
      els.btnLogout.addEventListener("click", () => {
        if(confirm("Logout sekarang?")){
          logout();
        }
      });

      // chat input
      els.sendButton.addEventListener("click", sendMessage);
      els.messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });

      els.messageInput.addEventListener("input", () => {
        if (!socket || !isConnected) return;
        if (typingTimeout) clearTimeout(typingTimeout);
        socket.emit("chat:typing", true);
        typingTimeout = setTimeout(() => socket.emit("chat:typing", false), 1000);
      });

      // file
      els.attachButton.addEventListener("click", () => els.fileInput.click());
      els.fileInput.addEventListener("change", handleFileSelect);
      els.removeFile.addEventListener("click", clearFile);

      // image modal close
      els.modalImage.addEventListener("click", () => els.imageModal.classList.remove("active"));

      // IMPORTANT: On first user interaction, try play music again (autoplay block fix)
      const kick = async () => {
        document.removeEventListener("touchstart", kick);
        document.removeEventListener("click", kick);
        if(audio.paused){
          try{ await audio.play(); setMusicUI(true); }catch(e){ setMusicUI(false); }
        }
      };
      document.addEventListener("touchstart", kick, { passive:true });
      document.addEventListener("click", kick);
    }

    function logout(){
      localStorage.removeItem(STORAGE_KEY_USER);
      localStorage.removeItem(STORAGE_KEY_AVATAR);
      myUser.username = null;

      // stop socket
      if(socket){
        try{ socket.disconnect(); }catch(e){}
        socket = null;
      }
      isConnected = false;
      enableInput(false);

      // reset UI
      els.messages.innerHTML = `<div class="system-message" id="welcomeMessage"><i class="fas fa-user-lock"></i> Logged out</div>`;
      els.userList.innerHTML = "";
      els.onlineCount.textContent = "0";
      els.totalOnline.textContent = "0";

      // show login again
      requireLogin();
    }

    function doLogin() {
      const raw = (els.loginUsername.value || "").trim();
      if (!isValidUsername(raw)) {
        els.loginUsername.focus();
        els.loginUsername.select();
        return alert("Username harus 3–20 karakter dan hanya huruf/angka/underscore.");
      }
      myUser.username = raw;
      localStorage.setItem(STORAGE_KEY_USER, raw);
      afterLogin();
    }

    function handleAvatarSelect(e){
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      if(!file.type.startsWith("image/")) return alert("File harus gambar.");
      if(file.size > 2 * 1024 * 1024) return alert("Max avatar 2MB.");

      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        localStorage.setItem(STORAGE_KEY_AVATAR, String(dataUrl));
        updateUserDisplay();
      };
      reader.readAsDataURL(file);
      els.avatarFile.value = "";
    }

    function sendMessage() {
      const text = (els.messageInput.value || "").trim();
      if (!isConnected || !socket) return;

      if (currentFile) {
        socket.emit("chat:image", {
          image: currentFileData,
          filename: currentFile.name,
          message: text,
          username: myUser.username,
          role: myUser.role,
        });
        clearFile();
      } else if (text) {
        socket.emit("chat:message", { message: text, username: myUser.username, role: myUser.role });
      }
      els.messageInput.value = "";
      els.messageInput.style.height = "auto";
    }

    function handleFileSelect(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (!(file.type.match("image.*") || file.type.match("video.*"))) return alert("Hanya image/video");
      if (file.size > 10 * 1024 * 1024) return alert("Max 10MB");

      els.filePreview.classList.add("active");
      els.fileName.textContent = file.name;

      currentFile = file;
      const reader = new FileReader();
      reader.onload = (ev) => (currentFileData = ev.target.result);
      reader.readAsDataURL(file);
    }

    function clearFile() {
      currentFile = null; currentFileData = null;
      els.filePreview.classList.remove("active");
      els.fileInput.value = "";
    }

    function getBadgeHTML(role) {
      if (role === "owner") return '<span class="msg-role-badge badge-owner">OWNER</span>';
      if (role === "admin") return '<span class="msg-role-badge badge-admin">ADMIN</span>';
      return '<span class="msg-role-badge badge-user">USER</span>';
    }

    function addMessage(data) {
      const isOwn = data.username === myUser.username;
      const div = document.createElement("div");
      div.className = `message ${isOwn ? "own" : "other"}`;
      const time = new Date(data.timestamp || Date.now()).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

      let nameColor = "#f2f6ff";
      if (data.role === "owner") nameColor = "#ffd700";
      else if (data.role === "admin") nameColor = "#77f0ff";

      div.innerHTML = `
        <div class="msg-meta">
          <span style="color:${nameColor}">${escapeHtml(data.username || "")}</span>
          ${getBadgeHTML(data.role)}
          <span>${time}</span>
        </div>
        <div class="msg-bubble">${escapeHtml(data.message || "").replace(/\n/g, "<br>")}</div>
      `;
      els.messages.appendChild(div);
    }

    function addImageMessage(data) {
      const isOwn = data.username === myUser.username;
      const div = document.createElement("div");
      div.className = `message ${isOwn ? "own" : "other"}`;
      const time = new Date(data.timestamp || Date.now()).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

      let nameColor = "#f2f6ff";
      if (data.role === "owner") nameColor = "#ffd700";
      else if (data.role === "admin") nameColor = "#77f0ff";

      const captionHTML = data.message ? `<div style="margin-bottom:8px">${escapeHtml(data.message).replace(/\n/g, "<br>")}</div>` : "";
      const imgHTML = data.image ? `<img src="${data.image}" alt="Image" data-preview="1">` : "";

      div.innerHTML = `
        <div class="msg-meta">
          <span style="color:${nameColor}">${escapeHtml(data.username || "")}</span>
          ${getBadgeHTML(data.role)}
          <span>${time}</span>
        </div>
        <div class="msg-bubble">
          ${captionHTML}
          ${imgHTML}
        </div>
      `;
      els.messages.appendChild(div);

      const img = div.querySelector('img[data-preview="1"]');
      if (img) img.addEventListener("click", () => openPreview(data.image));
    }

    function openPreview(src) {
      els.modalImage.src = src;
      els.imageModal.classList.add("active");
    }

    function addSystemMessage(text) {
      const div = document.createElement("div");
      div.className = "system-message";
      div.innerHTML = text;
      els.messages.appendChild(div);
      scrollToBottom();
      setTimeout(() => div.remove(), 5000);
    }

    function renderUserList(users) {
      els.userList.innerHTML = "";
      (users || []).slice().sort((a,b) => {
        const order = { owner:0, admin:1, user:2 };
        return (order[a.role] ?? 99) - (order[b.role] ?? 99);
      }).forEach(u => {
        const div = document.createElement("div");
        div.className = "user-item";
        let roleColor = "#cfe7ff";
        if(u.role === "owner") roleColor = "#ffd700";
        else if(u.role === "admin") roleColor = "#77f0ff";

        div.innerHTML = `
          <div class="item-avatar">${String(u.username || "??").substring(0,2).toUpperCase()}</div>
          <div class="item-info">
            <h4 style="color:${roleColor}">${escapeHtml(u.username || "")}</h4>
            <span style="color:${(roleColor==="#ffd700"||roleColor==="#77f0ff")?roleColor:"rgba(140,160,200,.70)"}">${String(u.role||"user").toUpperCase()}</span>
          </div>
        `;
        els.userList.appendChild(div);
      });
    }

    function showTyping(name, isTyping) {
      els.typingIndicator.style.display = isTyping ? "flex" : "none";
      els.typingText.textContent = `${name} is typing...`;
    }

    function updateConnectionStatus(status, label) {
      els.connectionStatus.className = `connection-badge ${status}`;
      const icons = { connected: "fa-wifi", disconnected: "fa-wifi-slash", connecting: "fa-spinner fa-spin" };
      els.connectionStatus.innerHTML = `<i class="fas ${icons[status] || "fa-spinner fa-spin"}"></i> <span>${label || status.toUpperCase()}</span>`;
      els.connectionText.textContent = label || status.toUpperCase();
    }

    function enableInput(enable) {
      els.messageInput.disabled = !enable;
      els.sendButton.disabled = !enable;
      els.attachButton.disabled = !enable;
      if (enable) els.messageInput.focus();
    }

    function startPingMonitor() {
      stopPingMonitor();
      pingInterval = setInterval(() => {
        if (!socket || !isConnected) return;
        lastPing = Date.now();
        socket.emit("ping");
      }, 5000);
    }
    function stopPingMonitor() { if(pingInterval) clearInterval(pingInterval); pingInterval = null; }

    function escapeHtml(t) {
      const d = document.createElement("div");
      d.textContent = String(t ?? "");
      return d.innerHTML;
    }
    function scrollToBottom() { els.messages.scrollTop = els.messages.scrollHeight; }

    function autoresizeTextarea() {
      els.messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });
    }

    function setupMobileListeners() {
      function toggleSidebar(show) {
        if (show === undefined) show = !els.sidebar.classList.contains("active");
        if (show) { els.sidebar.classList.add("active"); els.sidebarOverlay.classList.add("active"); }
        else { els.sidebar.classList.remove("active"); els.sidebarOverlay.classList.remove("active"); }
      }
      els.menuToggle.addEventListener("click", () => toggleSidebar(true));
      els.sidebarOverlay.addEventListener("click", () => toggleSidebar(false));
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") { els.imageModal.classList.remove("active"); toggleSidebar(false); }
      });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
