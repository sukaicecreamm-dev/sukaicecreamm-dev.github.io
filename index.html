<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta name="theme-color" content="#081019" />
  <title>LIVE CHAT | PREMIUM</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg:#081019;
      --card:rgba(12, 18, 30, 0.72);
      --card2:rgba(10, 15, 25, 0.78);
      --line:rgba(140,180,255,0.16);
      --txt:#eaf2ff;
      --muted:rgba(220,235,255,0.55);
      --muted2:rgba(220,235,255,0.35);
      --accent:#5bd0ff;
      --good:#33e08e;
      --bad:#ff5b6b;

      --fontH:'Orbitron',sans-serif;
      --fontB:'Share Tech Mono',monospace;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --glass: blur(14px) saturate(130%);
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:var(--fontB);-webkit-tap-highlight-color:transparent}
    body{
      height:100dvh;
      overflow:hidden;
      background: radial-gradient(900px 600px at 30% 10%, rgba(90,180,255,.18), transparent 60%),
                  radial-gradient(900px 700px at 80% 20%, rgba(120,90,255,.12), transparent 55%),
                  radial-gradient(800px 600px at 40% 90%, rgba(70,255,210,.08), transparent 55%),
                  linear-gradient(180deg, #070f17, #060b10);
      color:var(--txt);
      display:flex;justify-content:center;
    }

    /* Meteor canvas */
    #meteorCanvas{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      opacity:1;
    }

    /* App wrapper */
    .app-container{
      position:relative;
      z-index:2;
      width:100%;
      max-width:1600px;
      height:100%;
      display:flex;
    }

    /* Connection badge */
    .connection-badge{
      position:fixed; top:16px; right:16px;
      z-index:50;
      display:flex; align-items:center; gap:8px;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(6,10,16,.55);
      border:1px solid rgba(120,170,255,.18);
      backdrop-filter: var(--glass);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      font-family:var(--fontH);
      letter-spacing:1px;
      font-size:11px;
      text-transform:uppercase;
    }
    .connection-badge.connected{border-color: rgba(60,255,170,.35); color: rgba(60,255,170,.9);}
    .connection-badge.connecting{border-color: rgba(255,210,80,.35); color: rgba(255,210,80,.9);}
    .connection-badge.disconnected{border-color: rgba(255,90,110,.35); color: rgba(255,90,110,.9);}

    /* Sidebar overlay (IMPORTANT: overlay is BELOW sidebar, ABOVE chat only) */
    .sidebar-overlay{
      position:fixed; inset:0;
      z-index:8; /* below sidebar (9) */
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
    }
    .sidebar-overlay.active{display:block;}

    /* Sidebar */
    .sidebar{
      width:310px;
      height:100%;
      z-index:9; /* above overlay */
      flex-shrink:0;
      border-right:1px solid rgba(120,170,255,.14);
      background: rgba(7,12,20,.55);
      backdrop-filter: var(--glass);
      box-shadow: 16px 0 60px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
      transform: translateX(0);
      transition: transform .28s ease;
    }

    .user-card{
      padding:20px;
      border-bottom:1px solid rgba(120,170,255,.14);
      background: linear-gradient(180deg, rgba(20,40,70,.25), rgba(10,14,22,.12));
    }

    .user-top{
      display:flex; align-items:center; gap:12px;
    }

    .avatar{
      width:56px;height:56px;border-radius:16px;
      border:1px solid rgba(140,190,255,.18);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      position:relative;
      flex-shrink:0;
      cursor:pointer;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:none;}
    .avatar .initials{
      font-family:var(--fontH);
      letter-spacing:1px;
      font-size:18px;
      color:rgba(235,245,255,.95);
      text-shadow: 0 6px 18px rgba(0,0,0,.65);
    }
    .user-meta{flex:1; min-width:0;}
    .user-name{
      font-family:var(--fontH);
      font-size:15px;
      letter-spacing:1px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .user-role{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(130,190,255,.18);
      background: rgba(12,18,30,.55);
      font-size:11px;
      letter-spacing:1px;
      color:rgba(225,245,255,.85);
      text-transform:uppercase;
    }
    .role-dot{
      width:8px;height:8px;border-radius:99px;
      background: rgba(90,210,255,.9);
      box-shadow: 0 0 14px rgba(90,210,255,.65);
    }

    .user-actions{
      margin-top:14px;
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      background: rgba(10,14,22,.55);
      border:1px solid rgba(120,170,255,.16);
      color: rgba(235,245,255,.88);
      box-shadow: 0 10px 25px rgba(0,0,0,.28);
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-family:var(--fontH);
      font-size:11px;
      letter-spacing:1.2px;
      text-transform:uppercase;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(160,220,255,.32); background: rgba(18,28,44,.6);}
    .btn.danger{border-color: rgba(255,90,110,.22); background: rgba(30,10,16,.42);}
    .btn.danger:hover{border-color: rgba(255,90,110,.38);}

    /* Online users */
    .online{
      flex:1; min-height:0;
      display:flex; flex-direction:column;
    }
    .online-head{
      padding:14px 18px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid rgba(120,170,255,.12);
      font-family:var(--fontH);
      letter-spacing:1.3px;
      font-size:11px;
      color: rgba(220,240,255,.68);
      text-transform:uppercase;
    }
    .users-list{padding:10px; overflow:auto; min-height:0;}
    .user-item{
      display:flex; align-items:center; gap:10px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(120,170,255,.10);
      background: rgba(8,12,18,.35);
      margin-bottom:8px;
    }
    .user-item .ua{
      width:34px;height:34px;border-radius:12px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(120,170,255,.14);
      display:flex; align-items:center; justify-content:center;
      font-family:var(--fontH);
      font-size:12px;
      color: rgba(220,240,255,.8);
      flex-shrink:0;
      overflow:hidden;
    }
    .user-item .ua img{width:100%;height:100%;object-fit:cover;display:none;}
    .user-item .ui{min-width:0; flex:1;}
    .user-item .ui h4{
      font-size:12px; font-family:var(--fontH); letter-spacing:1px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      color: rgba(235,245,255,.88);
    }
    .user-item .ui span{
      font-size:10px; letter-spacing:1px; text-transform:uppercase;
      color: rgba(220,240,255,.45);
    }

    /* Chat area */
    .chat-area{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .chat-header{
      height:64px;
      padding:0 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(120,170,255,.12);
      background: rgba(7,12,20,.55);
      backdrop-filter: var(--glass);
      z-index:6;
    }

    .left-head{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }

    .menu-toggle{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(120,170,255,.18);
      background: rgba(10,14,22,.55);
      color: rgba(235,245,255,.9);
      cursor:pointer;
      display:none;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .brand-title{
      font-family:var(--fontH);
      letter-spacing:2px;
      font-size:15px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .badge-premium{
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:1.8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(120,190,255,.20);
      background: linear-gradient(180deg, rgba(90,210,255,.18), rgba(90,210,255,.06));
      color: rgba(225,250,255,.9);
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      text-transform:uppercase;
    }

    /* Music button placed under menu area (still in header left) */
    .music-btn{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(120,190,255,.20);
      background: rgba(10,14,22,.55);
      color: rgba(225,250,255,.9);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
    }
    .music-btn:hover{transform: translateY(-1px); border-color: rgba(160,220,255,.32); background: rgba(18,28,44,.6);}
    .music-btn[data-on="1"]{
      border-color: rgba(70,255,170,.35);
    }
    .music-dot{
      position:absolute; top:7px; right:7px;
      width:8px;height:8px;border-radius:99px;
      background: rgba(70,255,170,.9);
      box-shadow: 0 0 14px rgba(70,255,170,.65);
      display:none;
    }
    .music-btn[data-on="1"] .music-dot{display:block;}

    .right-head{
      display:flex; align-items:center; gap:10px;
    }
    .stat{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(120,170,255,.18);
      background: rgba(10,14,22,.55);
      backdrop-filter: blur(10px);
      font-family:var(--fontH);
      letter-spacing:1.1px;
      font-size:11px;
      text-transform:uppercase;
      color: rgba(220,240,255,.75);
    }
    .stat i{color: rgba(120,210,255,.9);}
    #ping{opacity:.9}

    /* Messages */
    .messages{
      flex:1; min-height:0;
      overflow:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .system{
      align-self:center;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(120,170,255,.14);
      background: rgba(0,0,0,.25);
      color: rgba(220,240,255,.68);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      backdrop-filter: blur(8px);
    }

    .msg{
      max-width:80%;
      display:flex;
      gap:10px;
      align-items:flex-end;
      animation: fadeIn .2s ease;
    }
    .msg.own{align-self:flex-end; flex-direction:row-reverse;}
    .msg .pico{
      width:34px;height:34px;border-radius:14px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(120,170,255,.14);
      overflow:hidden;
      flex-shrink:0;
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .msg .pico img{width:100%;height:100%;object-fit:cover;display:none;}
    .msg .pico span{
      font-family:var(--fontH);
      font-size:12px;
      letter-spacing:1px;
      color: rgba(235,245,255,.9);
    }

    .bubble-wrap{display:flex; flex-direction:column; gap:6px; min-width:0;}
    .meta{
      display:flex; align-items:center; gap:8px;
      font-size:11px;
      color: rgba(220,240,255,.55);
      font-family:var(--fontH);
      letter-spacing:1px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .role-badge{
      font-size:9px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(120,190,255,.16);
      background: rgba(12,18,30,.5);
      color: rgba(225,250,255,.78);
      letter-spacing:1.3px;
    }

    .bubble{
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(120,170,255,.14);
      background: rgba(10,14,22,.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 40px rgba(0,0,0,.28);
      color: rgba(240,250,255,.92);
      line-height:1.45;
      word-break:break-word;
      position:relative;
    }
    .msg.own .bubble{
      background: linear-gradient(180deg, rgba(100,220,255,.16), rgba(10,14,22,.55));
      border-color: rgba(120,210,255,.18);
    }

    .bubble img{
      margin-top:10px;
      max-width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      cursor:pointer;
      display:block;
    }

    /* Typing */
    .typing{
      height:24px;
      padding:0 16px 10px;
      display:none;
      align-items:center;
      gap:8px;
      color: rgba(220,240,255,.55);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .dots span{
      width:4px;height:4px;border-radius:99px;
      background: rgba(220,240,255,.55);
      display:inline-block;
      animation:bounce 1.2s infinite;
    }
    .dots span:nth-child(2){animation-delay:.15s}
    .dots span:nth-child(3){animation-delay:.30s}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

    /* Input */
    .input{
      padding:14px;
      border-top:1px solid rgba(120,170,255,.12);
      background: rgba(7,12,20,.55);
      backdrop-filter: var(--glass);
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .input-wrap{flex:1; display:flex; flex-direction:column; gap:8px; min-width:0;}
    .file-preview{
      display:none;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(120,170,255,.14);
      background: rgba(10,14,22,.55);
      color: rgba(220,240,255,.75);
      font-size:12px;
    }
    .file-preview.active{display:flex;}
    #fileName{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1;}
    .remove-file{cursor:pointer; opacity:.8;}
    .remove-file:hover{opacity:1;}

    textarea{
      width:100%;
      min-height:52px;
      max-height:130px;
      resize:none;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(120,170,255,.16);
      background: rgba(0,0,0,.35);
      color: rgba(240,250,255,.92);
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
    }
    textarea::placeholder{color: rgba(220,240,255,.35);}
    textarea:focus{border-color: rgba(160,220,255,.35);}

    .btns{display:flex; gap:10px; flex-shrink:0;}
    .icon-btn{
      width:52px;height:52px;border-radius:18px;
      border:1px solid rgba(120,170,255,.16);
      background: rgba(10,14,22,.55);
      color: rgba(225,250,255,.88);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 16px 40px rgba(0,0,0,.28);
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .icon-btn:hover{transform: translateY(-1px); border-color: rgba(160,220,255,.32); background: rgba(18,28,44,.6);}
    .send{
      background: linear-gradient(180deg, rgba(110,220,255,.95), rgba(70,180,255,.75));
      border-color: rgba(160,220,255,.35);
      color: rgba(0,0,0,.85);
      font-weight:800;
    }
    .send:hover{filter: brightness(1.06);}

    /* Modals */
    .modal-overlay{
      position:fixed; inset:0;
      z-index:200;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(8px);
    }
    .modal-overlay.active{display:flex;}
    .modal-card{
      width:100%;
      max-width:520px;
      border-radius:18px;
      border:1px solid rgba(120,170,255,.16);
      background: rgba(7,12,20,.72);
      backdrop-filter: var(--glass);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .modal-title{
      font-family:var(--fontH);
      letter-spacing:1.5px;
      font-size:14px;
      text-transform:uppercase;
      margin-bottom:10px;
      color: rgba(235,245,255,.92);
    }
    .modal-sub{
      color: rgba(220,240,255,.55);
      font-size:12px;
      line-height:1.5;
      margin-bottom:14px;
    }

    /* Login */
    .login-row{display:flex; gap:10px;}
    .login-input{
      flex:1;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(120,170,255,.16);
      background: rgba(0,0,0,.35);
      color: rgba(240,250,255,.92);
      outline:none;
    }
    .login-input:focus{border-color: rgba(160,220,255,.35);}
    .login-btn{
      padding:14px 14px;
      border-radius:16px;
      border:none;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(110,220,255,.95), rgba(70,180,255,.75));
      color: rgba(0,0,0,.85);
      font-family:var(--fontH);
      letter-spacing:1.4px;
      text-transform:uppercase;
      font-weight:900;
      box-shadow: 0 16px 40px rgba(0,0,0,.28);
    }

    /* Profile modal */
    .profile-grid{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .pf-big{
      width:74px;height:74px;border-radius:22px;
      border:1px solid rgba(120,170,255,.18);
      background: rgba(0,0,0,.35);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 14px 35px rgba(0,0,0,.35);
    }
    .pf-big img{width:100%;height:100%;object-fit:cover;display:none;}
    .pf-big span{font-family:var(--fontH); font-size:18px; letter-spacing:1px;}
    .pf-actions{flex:1; min-width:240px; display:flex; gap:10px; flex-wrap:wrap;}
    .pf-actions .btn{flex:unset; padding:10px 12px;}

    /* Image preview modal */
    .img-full{
      max-width:96vw;
      max-height:90vh;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 20px 70px rgba(0,0,0,.6);
      cursor: zoom-out;
    }

    @keyframes fadeIn{from{opacity:0; transform: translateY(4px)}to{opacity:1; transform: translateY(0)}}

    /* Mobile behavior */
    @media (max-width: 900px){
      .menu-toggle{display:flex; align-items:center; justify-content:center;}
      .sidebar{
        position:fixed; left:0; top:0; bottom:0;
        width:290px;
        transform: translateX(-105%);
      }
      .sidebar.active{transform: translateX(0);}
    }
  </style>
</head>

<body>
  <!-- Meteor Background -->
  <canvas id="meteorCanvas"></canvas>

  <!-- Connection -->
  <div class="connection-badge connecting" id="connectionStatus">
    <i class="fa-solid fa-spinner fa-spin"></i>
    <span>CONNECTING</span>
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Login Modal -->
  <div class="modal-overlay active" id="loginOverlay" aria-hidden="false">
    <div class="modal-card">
      <div class="modal-title">LOGIN USERNAME</div>
      <div class="modal-sub">Masukin username dulu biar nama & profil kamu tampil di chat. (Tersimpan di browser)</div>
      <div class="login-row">
        <input id="loginUsername" class="login-input" maxlength="20" placeholder="contoh: raraa" autocomplete="off" />
        <button id="loginBtn" class="login-btn">Masuk</button>
      </div>
      <div class="modal-sub" style="margin-top:12px;color:rgba(220,240,255,.40)">
        Username: 3–20 karakter, hanya huruf/angka/underscore.
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="modal-overlay" id="profileOverlay" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-title">PROFILE SETTINGS</div>
      <div class="modal-sub">Klik “Upload Foto” buat ganti avatar. Klik “Logout” buat login ulang.</div>

      <div class="profile-grid">
        <div class="pf-big" id="pfBig">
          <img id="pfBigImg" alt="Profile"/>
          <span id="pfBigInitials">ME</span>
        </div>

        <div class="pf-actions">
          <button class="btn" id="btnUpload"><i class="fa-solid fa-image"></i> Upload Foto</button>
          <button class="btn" id="btnRemovePhoto"><i class="fa-solid fa-trash"></i> Hapus Foto</button>
          <button class="btn danger" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
          <button class="btn" id="btnCloseProfile"><i class="fa-solid fa-xmark"></i> Tutup</button>
        </div>
      </div>

      <input type="file" id="profileFile" accept="image/*" style="display:none" />
    </div>
  </div>

  <!-- Image Preview Modal -->
  <div class="modal-overlay" id="imageModal">
    <img id="modalImage" class="img-full" src="" alt="Preview" />
  </div>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="user-card">
        <div class="user-top">
          <div class="avatar" id="userAvatar" title="Klik untuk profile">
            <img id="avatarImg" alt="Avatar"/>
            <div class="initials" id="avatarInitials">ME</div>
          </div>

          <div class="user-meta">
            <div class="user-name" id="myUsername">Loading...</div>
            <div class="user-role" id="myRoleBadge"><span class="role-dot"></span> USER</div>
          </div>
        </div>

        <div class="user-actions">
          <button class="btn" id="openProfileBtn"><i class="fa-solid fa-user-gear"></i> Profile</button>
          <button class="btn danger" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>

      <div class="online">
        <div class="online-head">
          <span>Online Users</span>
          <span id="onlineCount">0</span>
        </div>
        <div class="users-list" id="userList"></div>
      </div>
    </aside>

    <!-- Chat -->
    <main class="chat-area">
      <header class="chat-header">
        <div class="left-head">
          <button class="menu-toggle" id="menuToggle" aria-label="Menu">
            <i class="fa-solid fa-bars"></i>
          </button>

          <div class="brand">
            <div class="brand-title">LIVE CHAT</div>
            <div class="badge-premium">PREMIUM</div>
          </div>

          <!-- Music button placed "under menu area" (still left section) -->
          <button class="music-btn" id="musicBtn" data-on="0" title="Music">
            <span class="music-dot"></span>
            <i class="fa-solid fa-music"></i>
          </button>
        </div>

        <div class="right-head">
          <div class="stat"><i class="fa-solid fa-users"></i> <span id="totalOnline">0</span></div>
          <div class="stat"><i class="fa-solid fa-signal"></i> <span id="ping">0ms</span></div>
        </div>
      </header>

      <section class="messages" id="messages">
        <div class="system" id="welcomeMessage"><i class="fa-solid fa-user-lock"></i> Waiting for login...</div>
      </section>

      <div class="typing" id="typingIndicator">
        <div class="dots"><span></span><span></span><span></span></div>
        <span id="typingText">Someone is typing...</span>
      </div>

      <footer class="input">
        <div class="input-wrap">
          <div class="file-preview" id="filePreview">
            <i class="fa-solid fa-image"></i>
            <span id="fileName">file</span>
            <i class="fa-solid fa-xmark remove-file" id="removeFile"></i>
          </div>

          <textarea id="messageInput" placeholder="Type message (or select image)..." disabled></textarea>
        </div>

        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none" />

        <div class="btns">
          <button class="icon-btn" id="attachButton" disabled><i class="fa-solid fa-paperclip"></i></button>
          <button class="icon-btn send" id="sendButton" disabled><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </footer>
    </main>
  </div>

  <!-- Audio (loop) -->
  <audio id="bgm" preload="auto" loop playsinline>
    <source src="https://files.catbox.moe/wlny2m.mp3" type="audio/mpeg" />
  </audio>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <script>
    /* ==========================
       1) SET SOCKET URL HERE
       ========================== */
    window.SOCKET_URL = "https://livechatscarrydeath.raraaprivate.my.id"; // <-- ini domain socket kamu

    const SOCKET_URL = window.SOCKET_URL || window.location.origin;

    /* ==========================
       STORAGE KEYS
       ========================== */
    const STORAGE_USER = "ic_username";
    const STORAGE_PHOTO = "ic_profile_photo"; // base64 dataURL

    const els = {
      sidebar: document.getElementById("sidebar"),
      sidebarOverlay: document.getElementById("sidebarOverlay"),
      menuToggle: document.getElementById("menuToggle"),

      connectionStatus: document.getElementById("connectionStatus"),
      welcomeMessage: document.getElementById("welcomeMessage"),

      messages: document.getElementById("messages"),
      typingIndicator: document.getElementById("typingIndicator"),
      typingText: document.getElementById("typingText"),

      messageInput: document.getElementById("messageInput"),
      sendButton: document.getElementById("sendButton"),
      attachButton: document.getElementById("attachButton"),
      fileInput: document.getElementById("fileInput"),
      filePreview: document.getElementById("filePreview"),
      fileName: document.getElementById("fileName"),
      removeFile: document.getElementById("removeFile"),

      onlineCount: document.getElementById("onlineCount"),
      totalOnline: document.getElementById("totalOnline"),
      ping: document.getElementById("ping"),
      userList: document.getElementById("userList"),

      myUsername: document.getElementById("myUsername"),
      myRoleBadge: document.getElementById("myRoleBadge"),

      // avatar sidebar
      userAvatar: document.getElementById("userAvatar"),
      avatarImg: document.getElementById("avatarImg"),
      avatarInitials: document.getElementById("avatarInitials"),

      // login
      loginOverlay: document.getElementById("loginOverlay"),
      loginUsername: document.getElementById("loginUsername"),
      loginBtn: document.getElementById("loginBtn"),

      // profile
      profileOverlay: document.getElementById("profileOverlay"),
      openProfileBtn: document.getElementById("openProfileBtn"),
      logoutBtn: document.getElementById("logoutBtn"),
      btnLogout: document.getElementById("btnLogout"),
      btnCloseProfile: document.getElementById("btnCloseProfile"),
      btnUpload: document.getElementById("btnUpload"),
      btnRemovePhoto: document.getElementById("btnRemovePhoto"),
      profileFile: document.getElementById("profileFile"),
      pfBig: document.getElementById("pfBig"),
      pfBigImg: document.getElementById("pfBigImg"),
      pfBigInitials: document.getElementById("pfBigInitials"),

      // image preview
      imageModal: document.getElementById("imageModal"),
      modalImage: document.getElementById("modalImage"),

      // music
      musicBtn: document.getElementById("musicBtn"),
      bgm: document.getElementById("bgm"),
    };

    const myUser = { username: null, role: "user" };
    let socket = null;
    let isConnected = false;
    let typingTimeout = null;
    let lastPing = Date.now();
    let pingInterval = null;
    let currentFile = null;
    let currentFileData = null;

    /* ==========================
       FIX BLUR PROBLEM NOTE:
       - We DO NOT apply filter blur to app container.
       - Overlay only dims chat, NOT sidebar (z-index fixed).
       ========================== */

    function init(){
      setupMeteorCanvas();
      setupMobileSidebar();
      setupUIEvents();
      autoresizeTextarea();

      const savedUser = (localStorage.getItem(STORAGE_USER) || "").trim();
      if(isValidUsername(savedUser)){
        myUser.username = savedUser;
        applyProfilePhotoFromStorage();
        updateUserDisplay();
        hideLogin();
        connectSocket();
        tryAutoPlayMusic(); // try; if blocked, we start on user interaction
      } else {
        showLogin();
      }
    }

    function showLogin(){
      els.loginOverlay.classList.add("active");
      els.loginOverlay.setAttribute("aria-hidden","false");
      setTimeout(()=>els.loginUsername.focus(), 50);

      setWelcome(`<i class="fa-solid fa-user-lock"></i> Please login (username)`);
      updateConnectionStatus("disconnected", "LOGIN REQUIRED");
      enableInput(false);
    }

    function hideLogin(){
      els.loginOverlay.classList.remove("active");
      els.loginOverlay.setAttribute("aria-hidden","true");
    }

    function doLogin(){
      const raw = (els.loginUsername.value||"").trim();
      if(!isValidUsername(raw)){
        alert("Username harus 3–20 karakter dan hanya huruf/angka/underscore.");
        els.loginUsername.focus();
        els.loginUsername.select();
        return;
      }
      myUser.username = raw;
      localStorage.setItem(STORAGE_USER, raw);

      // if no photo, keep initials
      applyProfilePhotoFromStorage();
      updateUserDisplay();
      hideLogin();

      setWelcome(`<i class="fa-solid fa-spinner fa-spin"></i> Connecting to server...`);
      connectSocket();

      // start music after login (user gesture)
      tryAutoPlayMusic(true);
    }

    function logoutAll(){
      localStorage.removeItem(STORAGE_USER);
      localStorage.removeItem(STORAGE_PHOTO);
      myUser.username = null;

      // disconnect socket clean
      try{ if(socket) socket.disconnect(); }catch(e){}

      // reset UI
      els.avatarImg.style.display = "none";
      els.avatarInitials.style.display = "block";
      els.pfBigImg?.style && (els.pfBigImg.style.display = "none");
      els.pfBigInitials && (els.pfBigInitials.style.display = "block");

      els.messages.innerHTML = '';
      setWelcome(`<i class="fa-solid fa-user-lock"></i> Waiting for login...`);
      enableInput(false);

      closeProfile();
      showLogin();
    }

    function isValidUsername(name){
      return /^[A-Za-z0-9_]{3,20}$/.test(name);
    }

    function updateUserDisplay(){
      const u = myUser.username || "Guest";
      els.myUsername.textContent = u;
      els.myRoleBadge.innerHTML = `<span class="role-dot"></span> ${String(myUser.role||"user").toUpperCase()}`;

      const initials = u.substring(0,2).toUpperCase();
      els.avatarInitials.textContent = initials;
      els.pfBigInitials.textContent = initials;
    }

    function setWelcome(html){
      els.welcomeMessage.style.display = "block";
      els.welcomeMessage.innerHTML = html;
    }

    /* ==========================
       PROFILE PHOTO
       ========================== */
    function applyProfilePhotoFromStorage(){
      const dataURL = localStorage.getItem(STORAGE_PHOTO);
      if(dataURL && dataURL.startsWith("data:image/")){
        els.avatarImg.src = dataURL;
        els.avatarImg.style.display = "block";
        els.avatarInitials.style.display = "none";

        els.pfBigImg.src = dataURL;
        els.pfBigImg.style.display = "block";
        els.pfBigInitials.style.display = "none";
      } else {
        els.avatarImg.style.display = "none";
        els.avatarInitials.style.display = "block";
        els.pfBigImg.style.display = "none";
        els.pfBigInitials.style.display = "block";
      }
    }

    function openProfile(){
      applyProfilePhotoFromStorage();
      els.profileOverlay.classList.add("active");
      els.profileOverlay.setAttribute("aria-hidden","false");
    }

    function closeProfile(){
      els.profileOverlay.classList.remove("active");
      els.profileOverlay.setAttribute("aria-hidden","true");
    }

    function uploadProfilePhoto(file){
      if(!file) return;
      if(!file.type.startsWith("image/")) return alert("File harus gambar.");
      if(file.size > 2 * 1024 * 1024) return alert("Max 2MB biar ringan.");

      const reader = new FileReader();
      reader.onload = (ev)=>{
        const dataURL = ev.target.result;
        localStorage.setItem(STORAGE_PHOTO, dataURL);
        applyProfilePhotoFromStorage();

        // re-render list (optional)
      };
      reader.readAsDataURL(file);
    }

    function removePhoto(){
      localStorage.removeItem(STORAGE_PHOTO);
      applyProfilePhotoFromStorage();
    }

    /* ==========================
       MUSIC
       ========================== */
    let musicOn = false;

    function setMusicUI(on){
      musicOn = !!on;
      els.musicBtn.setAttribute("data-on", musicOn ? "1":"0");
      els.musicBtn.innerHTML = `
        <span class="music-dot"></span>
        <i class="fa-solid ${musicOn ? "fa-volume-high" : "fa-music"}"></i>
      `;
    }

    async function startMusic(){
      try{
        els.bgm.volume = 0.65;
        await els.bgm.play();
        setMusicUI(true);
      }catch(e){
        // autoplay blocked
        setMusicUI(false);
      }
    }

    function stopMusic(){
      try{
        els.bgm.pause();
        els.bgm.currentTime = 0;
      }catch(e){}
      setMusicUI(false);
    }

    function toggleMusic(){
      if(musicOn) stopMusic();
      else startMusic();
    }

    // if user gesture happened, we can start music reliably
    function tryAutoPlayMusic(fromGesture=false){
      // some mobile browsers block unless user gesture => if fromGesture true, higher chance
      startMusic();
    }

    /* ==========================
       SOCKET
       ========================== */
    function connectSocket(){
      if(!window.io){
        updateConnectionStatus("disconnected","Socket.IO client not loaded");
        setWelcome(`<i class="fa-solid fa-triangle-exclamation"></i> Socket.IO client not loaded`);
        return;
      }

      updateConnectionStatus("connecting","CONNECTING");
      enableInput(false);

      socket = io(SOCKET_URL, { transports:["websocket","polling"] });

      socket.on("connect", ()=>{
        isConnected = true;
        updateConnectionStatus("connected","CONNECTED");
        socket.emit("chat:login", { username: myUser.username, role: myUser.role, photo: localStorage.getItem(STORAGE_PHOTO) || "" });

        setWelcome(`<i class="fa-solid fa-check"></i> Connected as ${escapeHtml(myUser.username)}`);
        setTimeout(()=>els.welcomeMessage.style.display="none", 1800);

        startPingMonitor();
        enableInput(true);
      });

      socket.on("disconnect", ()=>{
        isConnected = false;
        updateConnectionStatus("disconnected","DISCONNECTED");
        setWelcome(`<i class="fa-solid fa-xmark"></i> Disconnected`);
        stopPingMonitor();
        enableInput(false);
      });

      socket.on("connect_error", ()=>{
        isConnected = false;
        updateConnectionStatus("disconnected","CONNECT ERROR");
        enableInput(false);
        setWelcome(`<i class="fa-solid fa-triangle-exclamation"></i> Cannot connect to Socket server`);
      });

      socket.on("chat:history", (history)=>{
        els.messages.innerHTML = "";
        (history||[]).forEach(d => d.image ? addImageMessage(d) : addMessage(d));
        scrollToBottom();
      });

      socket.on("chat:newMessage", (msg)=>{
        addMessage(msg);
        scrollToBottom();
      });

      socket.on("chat:image", (data)=>{
        addImageMessage(data);
        scrollToBottom();
      });

      socket.on("chat:onlineUsers", (data)=>{
        renderUserList(data.users || []);
        els.onlineCount.textContent = data.count ?? (data.users||[]).length;
        els.totalOnline.textContent = data.count ?? (data.users||[]).length;
      });

      socket.on("chat:userJoin", (d)=>{
        addSystemMessage(`${escapeHtml(d.username)} joined`);
        els.onlineCount.textContent = d.onlineCount ?? els.onlineCount.textContent;
        els.totalOnline.textContent = d.onlineCount ?? els.totalOnline.textContent;
      });

      socket.on("chat:userLeave", (d)=>{
        addSystemMessage(`${escapeHtml(d.username)} left`);
        els.onlineCount.textContent = d.onlineCount ?? els.onlineCount.textContent;
        els.totalOnline.textContent = d.onlineCount ?? els.totalOnline.textContent;
      });

      socket.on("chat:userTyping", (d)=>{
        if(d.username !== myUser.username) showTyping(d.username, d.isTyping);
      });

      socket.on("pong", ()=>{
        els.ping.textContent = (Date.now() - lastPing) + "ms";
      });
    }

    function startPingMonitor(){
      stopPingMonitor();
      pingInterval = setInterval(()=>{
        if(!socket || !isConnected) return;
        lastPing = Date.now();
        socket.emit("ping");
      }, 5000);
    }

    function stopPingMonitor(){
      if(pingInterval) clearInterval(pingInterval);
      pingInterval = null;
    }

    function updateConnectionStatus(status,label){
      els.connectionStatus.className = `connection-badge ${status}`;
      const icon = status==="connected" ? "fa-wifi" : (status==="connecting" ? "fa-spinner fa-spin" : "fa-wifi-slash");
      els.connectionStatus.innerHTML = `<i class="fa-solid ${icon}"></i><span>${label||status.toUpperCase()}</span>`;
    }

    function enableInput(enable){
      els.messageInput.disabled = !enable;
      els.sendButton.disabled = !enable;
      els.attachButton.disabled = !enable;
      if(enable) els.messageInput.focus();
    }

    /* ==========================
       CHAT RENDER (with photo)
       ========================== */
    function getRoleLabel(role){
      const r = String(role||"user").toUpperCase();
      return r;
    }

    function addMessage(data){
      const isOwn = (data.username === myUser.username);
      const wrap = document.createElement("div");
      wrap.className = `msg ${isOwn ? "own":"other"}`;

      // photo from message (if backend sends) else use local photo for self
      let photo = data.photo || "";
      if(isOwn){
        photo = localStorage.getItem(STORAGE_PHOTO) || photo;
      }

      const pico = document.createElement("div");
      pico.className = "pico";
      const img = document.createElement("img");
      img.alt = "p";
      if(photo && photo.startsWith("data:image/")){
        img.src = photo;
        img.style.display = "block";
      }
      const ini = document.createElement("span");
      ini.textContent = String(data.username||"?").substring(0,2).toUpperCase();
      if(img.style.display === "block") ini.style.display = "none";
      pico.appendChild(img);
      pico.appendChild(ini);

      const bw = document.createElement("div");
      bw.className = "bubble-wrap";

      const time = new Date(data.timestamp || Date.now()).toLocaleTimeString("id-ID", {hour:"2-digit", minute:"2-digit"});

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <span>${escapeHtml(data.username||"")}</span>
        <span class="role-badge">${escapeHtml(getRoleLabel(data.role || "user"))}</span>
        <span style="opacity:.75">${time}</span>
      `;

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = escapeHtml(data.message||"").replace(/\n/g,"<br>");

      bw.appendChild(meta);
      bw.appendChild(bubble);

      wrap.appendChild(pico);
      wrap.appendChild(bw);
      els.messages.appendChild(wrap);
    }

    function addImageMessage(data){
      const isOwn = (data.username === myUser.username);
      const wrap = document.createElement("div");
      wrap.className = `msg ${isOwn ? "own":"other"}`;

      let photo = data.photo || "";
      if(isOwn){
        photo = localStorage.getItem(STORAGE_PHOTO) || photo;
      }

      const pico = document.createElement("div");
      pico.className = "pico";
      const img = document.createElement("img");
      img.alt = "p";
      if(photo && photo.startsWith("data:image/")){
        img.src = photo;
        img.style.display = "block";
      }
      const ini = document.createElement("span");
      ini.textContent = String(data.username||"?").substring(0,2).toUpperCase();
      if(img.style.display === "block") ini.style.display = "none";
      pico.appendChild(img);
      pico.appendChild(ini);

      const bw = document.createElement("div");
      bw.className = "bubble-wrap";

      const time = new Date(data.timestamp || Date.now()).toLocaleTimeString("id-ID", {hour:"2-digit", minute:"2-digit"});

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <span>${escapeHtml(data.username||"")}</span>
        <span class="role-badge">${escapeHtml(getRoleLabel(data.role || "user"))}</span>
        <span style="opacity:.75">${time}</span>
      `;

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const cap = (data.message||"").trim();
      if(cap){
        bubble.innerHTML = `<div>${escapeHtml(cap).replace(/\n/g,"<br>")}</div>`;
      } else {
        bubble.innerHTML = "";
      }

      if(data.image){
        const im = document.createElement("img");
        im.src = data.image;
        im.alt = "Image";
        im.addEventListener("click", ()=>openPreview(data.image));
        bubble.appendChild(im);
      }

      bw.appendChild(meta);
      bw.appendChild(bubble);

      wrap.appendChild(pico);
      wrap.appendChild(bw);
      els.messages.appendChild(wrap);
    }

    function addSystemMessage(text){
      const div = document.createElement("div");
      div.className = "system";
      div.innerHTML = text;
      els.messages.appendChild(div);
      scrollToBottom();
      setTimeout(()=>div.remove(), 4000);
    }

    function showTyping(name, isTyping){
      els.typingIndicator.style.display = isTyping ? "flex" : "none";
      els.typingText.textContent = `${name} is typing...`;
    }

    function scrollToBottom(){
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    function escapeHtml(t){
      const d = document.createElement("div");
      d.textContent = String(t ?? "");
      return d.innerHTML;
    }

    /* ==========================
       SEND / FILE
       ========================== */
    function sendMessage(){
      const text = (els.messageInput.value||"").trim();
      if(!socket || !isConnected) return;

      const photo = localStorage.getItem(STORAGE_PHOTO) || "";

      if(currentFile){
        socket.emit("chat:image", {
          image: currentFileData,
          filename: currentFile.name,
          message: text,
          username: myUser.username,
          role: myUser.role,
          photo
        });
        clearFile();
      } else if(text){
        socket.emit("chat:message", {
          message: text,
          username: myUser.username,
          role: myUser.role,
          photo
        });
      }

      els.messageInput.value = "";
      els.messageInput.style.height = "auto";
    }

    function handleFileSelect(e){
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      const okType = file.type.match("image.*") || file.type.match("video.*");
      if(!okType) return alert("Hanya boleh image/video");
      if(file.size > 10 * 1024 * 1024) return alert("Max 10MB");

      els.filePreview.classList.add("active");
      els.fileName.textContent = file.name;

      currentFile = file;
      const reader = new FileReader();
      reader.onload = (ev)=> currentFileData = ev.target.result;
      reader.readAsDataURL(file);
    }

    function clearFile(){
      currentFile = null;
      currentFileData = null;
      els.filePreview.classList.remove("active");
      els.fileInput.value = "";
    }

    function openPreview(src){
      els.modalImage.src = src;
      els.imageModal.classList.add("active");
    }

    /* ==========================
       USER LIST (supports photo if backend sends)
       ========================== */
    function renderUserList(users){
      els.userList.innerHTML = "";
      users.forEach(u=>{
        const item = document.createElement("div");
        item.className = "user-item";

        const ua = document.createElement("div");
        ua.className = "ua";
        const im = document.createElement("img");
        const s = document.createElement("span");
        s.textContent = String(u.username||"?").substring(0,2).toUpperCase();

        if(u.photo && String(u.photo).startsWith("data:image/")){
          im.src = u.photo;
          im.style.display = "block";
          s.style.display = "none";
          ua.appendChild(im);
        }
        ua.appendChild(s);

        const ui = document.createElement("div");
        ui.className = "ui";
        ui.innerHTML = `
          <h4>${escapeHtml(u.username||"")}</h4>
          <span>${escapeHtml(String(u.role||"user").toUpperCase())}</span>
        `;

        item.appendChild(ua);
        item.appendChild(ui);
        els.userList.appendChild(item);
      });
    }

    /* ==========================
       UI EVENTS
       ========================== */
    function setupUIEvents(){
      // login
      els.loginBtn.addEventListener("click", doLogin);
      els.loginUsername.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doLogin(); });

      // sidebar profile
      els.userAvatar.addEventListener("click", openProfile);
      els.openProfileBtn.addEventListener("click", openProfile);
      els.logoutBtn.addEventListener("click", logoutAll);

      // profile modal buttons
      els.btnCloseProfile.addEventListener("click", closeProfile);
      els.btnLogout.addEventListener("click", logoutAll);
      els.btnUpload.addEventListener("click", ()=> els.profileFile.click());
      els.profileFile.addEventListener("change", (e)=> uploadProfilePhoto(e.target.files && e.target.files[0]));
      els.btnRemovePhoto.addEventListener("click", removePhoto);

      // close modals
      els.profileOverlay.addEventListener("click", (e)=>{ if(e.target === els.profileOverlay) closeProfile(); });
      els.imageModal.addEventListener("click", (e)=>{ if(e.target === els.imageModal || e.target === els.modalImage) els.imageModal.classList.remove("active"); });

      // chat
      els.sendButton.addEventListener("click", sendMessage);
      els.messageInput.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          sendMessage();
        }
      });

      els.messageInput.addEventListener("input", ()=>{
        if(!socket || !isConnected) return;
        if(typingTimeout) clearTimeout(typingTimeout);
        socket.emit("chat:typing", true);
        typingTimeout = setTimeout(()=> socket.emit("chat:typing", false), 900);
      });

      els.attachButton.addEventListener("click", ()=> els.fileInput.click());
      els.fileInput.addEventListener("change", handleFileSelect);
      els.removeFile.addEventListener("click", clearFile);

      // music
      els.musicBtn.addEventListener("click", ()=>{
        toggleMusic();
      });

      // IMPORTANT: start music on first interaction if autoplay blocked
      const gesture = ()=>{
        if(!musicOn) startMusic();
        window.removeEventListener("pointerdown", gesture, {passive:true});
      };
      window.addEventListener("pointerdown", gesture, {passive:true});

      // ESC close
      document.addEventListener("keydown", (e)=>{
        if(e.key==="Escape"){
          els.imageModal.classList.remove("active");
          closeProfile();
          closeSidebar();
        }
      });
    }

    function autoresizeTextarea(){
      els.messageInput.addEventListener("input", function(){
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });
    }

    /* ==========================
       MOBILE SIDEBAR (NO BLUR BUG)
       ========================== */
    function setupMobileSidebar(){
      els.menuToggle.addEventListener("click", openSidebar);
      els.sidebarOverlay.addEventListener("click", closeSidebar);
    }
    function openSidebar(){
      els.sidebar.classList.add("active");
      els.sidebarOverlay.classList.add("active");
    }
    function closeSidebar(){
      els.sidebar.classList.remove("active");
      els.sidebarOverlay.classList.remove("active");
    }

    /* ==========================
       METEOR BACKGROUND (canvas)
       ========================== */
    function setupMeteorCanvas(){
      const canvas = document.getElementById("meteorCanvas");
      const ctx = canvas.getContext("2d", { alpha:true });

      let w=0,h=0, dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const stars = [];
      const meteors = [];

      function resize(){
        w = canvas.width = Math.floor(window.innerWidth * dpr);
        h = canvas.height = Math.floor(window.innerHeight * dpr);
        canvas.style.width = window.innerWidth + "px";
        canvas.style.height = window.innerHeight + "px";
      }
      window.addEventListener("resize", resize);
      resize();

      // soft starfield
      function initStars(){
        stars.length = 0;
        const count = Math.floor((window.innerWidth * window.innerHeight) / 6500);
        for(let i=0;i<count;i++){
          stars.push({
            x: Math.random()*w,
            y: Math.random()*h,
            r: (Math.random()*1.4 + 0.2) * dpr,
            a: Math.random()*0.6 + 0.1,
            tw: Math.random()*0.015 + 0.005
          });
        }
      }
      initStars();

      function spawnMeteor(){
        // spawn from upper-right-ish, falling to bottom-left-ish (nice angle)
        const startX = (Math.random()*0.6 + 0.35) * w;
        const startY = (Math.random()*0.25) * h;
        const len = (Math.random()*180 + 140) * dpr;
        const speed = (Math.random()*4 + 3) * dpr; // slowed aesthetic
        const angle = (Math.random()*0.18 + 0.82) * Math.PI; // ~148-180 deg direction
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed;

        meteors.push({
          x: startX,
          y: startY,
          vx, vy,
          len,
          life: 0,
          maxLife: Math.random()*70 + 70,
          glow: Math.random()*0.6 + 0.4
        });
      }

      // spawn many but not too heavy
      let meteorTimer = 0;

      function draw(){
        ctx.clearRect(0,0,w,h);

        // stars
        for(const s of stars){
          s.a += s.tw * (Math.random()>0.5 ? 1 : -1);
          s.a = Math.max(0.08, Math.min(0.75, s.a));
          ctx.beginPath();
          ctx.fillStyle = `rgba(180,220,255,${s.a})`;
          ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fill();

          // subtle glow
          ctx.beginPath();
          ctx.fillStyle = `rgba(90,210,255,${s.a*0.18})`;
          ctx.arc(s.x, s.y, s.r*3.2, 0, Math.PI*2);
          ctx.fill();
        }

        // meteors
        for(let i=meteors.length-1;i>=0;i--){
          const m = meteors[i];
          m.life++;

          m.x += m.vx;
          m.y += m.vy;

          const t = m.life / m.maxLife;
          const alpha = (t < 0.15) ? (t/0.15) : (t > 0.9 ? (1 - (t-0.9)/0.1) : 1);
          const a = Math.max(0, Math.min(1, alpha)) * 0.95;

          // tail
          const tx = m.x - (m.vx/Math.hypot(m.vx,m.vy))*m.len;
          const ty = m.y - (m.vy/Math.hypot(m.vx,m.vy))*m.len;

          ctx.save();
          ctx.lineCap = "round";
          ctx.globalCompositeOperation = "lighter";

          // main streak gradient
          const grad = ctx.createLinearGradient(m.x,m.y,tx,ty);
          grad.addColorStop(0, `rgba(210,245,255,${a})`);
          grad.addColorStop(0.35, `rgba(110,220,255,${a*0.65})`);
          grad.addColorStop(1, `rgba(110,220,255,0)`);

          ctx.strokeStyle = grad;
          ctx.lineWidth = 2.2 * dpr;
          ctx.beginPath();
          ctx.moveTo(m.x,m.y);
          ctx.lineTo(tx,ty);
          ctx.stroke();

          // glow core
          ctx.strokeStyle = `rgba(90,210,255,${a*0.35*m.glow})`;
          ctx.lineWidth = 6.5 * dpr;
          ctx.beginPath();
          ctx.moveTo(m.x,m.y);
          ctx.lineTo(tx,ty);
          ctx.stroke();

          // head glow
          ctx.fillStyle = `rgba(230,255,255,${a*0.85})`;
          ctx.beginPath();
          ctx.arc(m.x,m.y, 2.2*dpr, 0, Math.PI*2);
          ctx.fill();

          ctx.fillStyle = `rgba(90,210,255,${a*0.35})`;
          ctx.beginPath();
          ctx.arc(m.x,m.y, 10*dpr, 0, Math.PI*2);
          ctx.fill();

          ctx.restore();

          // remove if out or dead
          if(m.life > m.maxLife || m.x < -200 || m.y > h + 200){
            meteors.splice(i,1);
          }
        }

        // spawn controller (more frequent but smooth)
        meteorTimer++;
        if(meteorTimer % 18 === 0){
          if(meteors.length < 10 && Math.random() < 0.85) spawnMeteor();
        }

        requestAnimationFrame(draw);
      }
      draw();
    }

    /* ==========================
       START
       ========================== */
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
