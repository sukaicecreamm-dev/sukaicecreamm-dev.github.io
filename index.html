<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta name="theme-color" content="#141414" />
  <title>LIVE CHAT | SCARRY DEATH</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-body:#141414; --bg-card:#1e1e1e; --bg-input:#121212; --bg-sidebar:#181818;
      --text-primary:#f0f0f0; --text-secondary:#a0a0a0; --text-muted:#666666;
      --border-color:#333333; --border-focus:#ffffff;
      --msg-own-bg:#ffffff; --msg-own-text:#000000; --msg-other-bg:#2a2a2a; --msg-other-text:#ffffff;
      --font-header:'Orbitron',sans-serif; --font-body:'Share Tech Mono',monospace; --radius-card:16px;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:var(--font-body);-webkit-tap-highlight-color:transparent}
    body{
      height:100dvh;background:radial-gradient(circle at top center,#1f1f1f 0%,#141414 100%);
      color:var(--text-primary);overflow:hidden;display:flex;justify-content:center;
    }
    ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:#333;border-radius:3px}::-webkit-scrollbar-thumb:hover{background:#555}
    .app-container{display:flex;width:100%;height:100%;max-width:1600px;position:relative}

    /* SIDEBAR */
    .sidebar{
      width:300px;height:100%;background:var(--bg-sidebar);border-right:1px solid var(--border-color);
      display:flex;flex-direction:column;flex-shrink:0;transition:transform .3s cubic-bezier(.4,0,.2,1);z-index:50;
    }
    .user-card{
      background:var(--bg-card);border-bottom:1px solid var(--border-color);
      padding:25px;text-align:center;display:flex;flex-direction:column;align-items:center;
    }
    .user-avatar{
      width:70px;height:70px;margin-bottom:15px;border-radius:12px;background:#000;border:2px solid var(--border-color);
      display:flex;align-items:center;justify-content:center;font-family:var(--font-header);font-size:24px;color:#fff;font-weight:600;
      box-shadow:0 4px 15px rgba(0,0,0,.3);
    }
    .user-name{font-family:var(--font-header);font-size:18px;color:var(--text-primary);margin-bottom:5px;letter-spacing:.5px}
    .user-role{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;padding:5px 12px;border-radius:6px;margin-bottom:15px;display:inline-block}
    .role-owner{background:linear-gradient(135deg,#ffd700,#ffaa00);color:#000;border:1px solid rgba(255,255,255,.5);box-shadow:0 0 15px rgba(255,215,0,.4)}
    .role-admin{background:linear-gradient(135deg,#00e5ff,#0077ff);color:#000;border:1px solid rgba(255,255,255,.5);box-shadow:0 0 15px rgba(0,229,255,.4)}
    .role-user{background:#333;color:#ccc;border:1px solid #444}
    .user-status{font-size:12px;color:var(--text-muted);display:flex;align-items:center;gap:8px}
    .status-dot{width:8px;height:8px;background:#4ade80;border-radius:50%;box-shadow:0 0 8px rgba(74,222,128,.4)}

    .btn-dashboard{
      margin:20px;padding:14px;background:#1a1a1a;border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);
      font-family:var(--font-header);font-size:13px;display:flex;align-items:center;justify-content:center;gap:10px;cursor:pointer;
      transition:all .3s;text-transform:uppercase;letter-spacing:1px;
    }
    .btn-dashboard:hover{background:#252525;border-color:#fff;transform:translateY(-2px);box-shadow:0 5px 15px rgba(255,255,255,.05)}
    .online-users{flex:1;overflow:hidden;display:flex;flex-direction:column}
    .section-header{
      padding:15px 20px;border-bottom:1px solid var(--border-color);font-family:var(--font-header);font-size:12px;color:var(--text-secondary);
      text-transform:uppercase;letter-spacing:1.5px;display:flex;justify-content:space-between;
    }
    .users-list{flex:1;overflow-y:auto;padding:10px}
    .user-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;margin-bottom:4px;transition:background .2s;cursor:pointer}
    .user-item:hover{background:rgba(255,255,255,.05)}
    .item-avatar{
      width:32px;height:32px;background:#2a2a2a;border-radius:6px;display:flex;align-items:center;justify-content:center;
      font-family:var(--font-header);font-size:12px;color:#aaa;
    }
    .item-info h4{font-size:13px;color:var(--text-primary)}
    .item-info span{font-size:11px;color:var(--text-muted);text-transform:uppercase}

    /* CHAT */
    .chat-area{flex:1;display:flex;flex-direction:column;background:var(--bg-body);position:relative;width:100%}
    .chat-header{
      padding:15px 20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;
      background:rgba(20,20,20,.95);backdrop-filter:blur(10px);z-index:10;flex-shrink:0;
    }
    .menu-toggle{display:none;background:none;border:none;color:var(--text-primary);font-size:20px;cursor:pointer;margin-right:15px;padding:5px}
    .brand-title{font-family:var(--font-header);font-size:18px;font-weight:600;color:var(--text-primary);letter-spacing:1px;display:flex;align-items:center}
    .stats-container{display:flex;gap:20px;font-size:13px;color:var(--text-muted)}
    .stats-item i{margin-right:6px;color:var(--text-secondary)}

    .messages-container{
      flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:16px;
      background-image:radial-gradient(#222 1px,transparent 1px);background-size:20px 20px;min-height:0;
    }
    .system-message{
      align-self:center;background:rgba(0,0,0,.3);border:1px solid var(--border-color);
      padding:6px 16px;border-radius:20px;font-size:11px;color:var(--text-muted);
      text-transform:uppercase;letter-spacing:1px;
    }
    .message{max-width:75%;display:flex;flex-direction:column;animation:fadeIn .3s ease}
    .message.own{align-self:flex-end;align-items:flex-end}
    .message.other{align-self:flex-start;align-items:flex-start}
    .msg-meta{
      margin-bottom:6px;font-size:11px;color:var(--text-muted);font-family:var(--font-header);display:flex;gap:8px;align-items:center
    }
    .msg-role-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;margin-left:6px;letter-spacing:.5px;text-shadow:0 1px 2px rgba(0,0,0,.5)}
    .badge-owner{background:linear-gradient(135deg,#ffd700,#ffaa00);color:#000;box-shadow:0 0 6px rgba(255,215,0,.4)}
    .badge-admin{background:linear-gradient(135deg,#00e5ff,#0077ff);color:#000;box-shadow:0 0 6px rgba(0,229,255,.4)}
    .badge-user{background:#444;color:#bbb;border:1px solid #555;box-shadow:none;text-shadow:none}
    .msg-bubble{
      padding:12px 16px;border-radius:12px;font-size:14px;line-height:1.5;position:relative;word-break:break-word
    }
    .message.own .msg-bubble{background:var(--msg-own-bg);color:var(--msg-own-text);border-radius:12px 12px 0 12px}
    .message.other .msg-bubble{background:var(--msg-other-bg);color:var(--msg-other-text);border:1px solid var(--border-color);border-radius:12px 12px 12px 0}
    .msg-bubble img{max-width:100%;border-radius:8px;margin-top:10px;cursor:pointer;border:1px solid rgba(255,255,255,.1);display:block}

    /* INPUT */
    .input-area{
      padding:15px 20px;border-top:1px solid var(--border-color);background:#1a1a1a;display:flex;gap:12px;align-items:flex-end;flex-shrink:0
    }
    .input-wrapper{flex:1;display:flex;flex-direction:column;gap:8px;min-width:0;overflow:hidden;max-height:120px}
    .file-preview{
      display:none;background:#252525;border:1px solid #333;padding:8px 12px;border-radius:6px;align-items:center;gap:10px;
      font-size:12px;color:var(--text-secondary);flex-shrink:0;width:100%
    }
    .file-preview.active{display:flex}
    .file-preview i{color:var(--text-primary);flex-shrink:0}
    #fileName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .remove-file{margin-left:auto;cursor:pointer;color:#666;flex-shrink:0}
    textarea#messageInput{
      width:100%;background:#000;border:1px solid var(--border-color);border-radius:8px;color:#fff;padding:14px;
      font-family:var(--font-body);font-size:14px;resize:none;min-height:50px;transition:border .3s;flex:1
    }
    textarea#messageInput:focus{outline:none;border-color:var(--border-focus)}
    .btn-group{display:flex;gap:10px;flex-shrink:0;align-self:flex-end}
    .icon-btn{
      width:50px;height:50px;border-radius:8px;border:1px solid var(--border-color);background:#252525;color:var(--text-secondary);
      cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .2s;flex-shrink:0
    }
    .icon-btn:hover{background:#333;color:#fff;transform:translateY(-2px)}
    .btn-send{background:#fff;color:#000;border:none;font-weight:600}
    .btn-send:hover{background:#ddd}

    /* Typing */
    .typing-area{padding:0 20px 10px;height:20px;font-size:11px;color:var(--text-muted);display:flex;align-items:center;gap:6px;flex-shrink:0}
    .dots span{width:3px;height:3px;background:#666;border-radius:50%;display:inline-block;animation:bounce 1.4s infinite}
    .dots span:nth-child(2){animation-delay:.2s}.dots span:nth-child(3){animation-delay:.4s}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

    /* Overlay & Modal */
    .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:40;backdrop-filter:blur(2px)}
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.95);z-index:1000;justify-content:center;align-items:center}
    .modal-overlay.active{display:flex}
    .modal-img{max-width:95%;max-height:90vh;object-fit:contain;border-radius:8px;border:1px solid #333;cursor:zoom-out}

    /* Connection badge */
    .connection-badge{
      position:fixed;top:20px;right:20px;padding:6px 12px;border-radius:20px;background:#222;border:1px solid #333;font-size:10px;
      font-family:var(--font-header);display:flex;align-items:center;gap:6px;z-index:999;box-shadow:0 2px 10px rgba(0,0,0,.3)
    }
    .connection-badge.connected{border-color:#4ade80;color:#4ade80}
    .connection-badge.disconnected{border-color:#f87171;color:#f87171}
    .connection-badge.connecting{border-color:#facc15;color:#facc15}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

    /* LOGIN MODAL */
    .login-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px
    }
    .login-overlay.active{display:flex}
    .login-card{
      width:100%;max-width:460px;background:#171717;border:1px solid #2a2a2a;border-radius:14px;padding:22px;
      box-shadow:0 20px 60px rgba(0,0,0,.55)
    }
    .login-title{font-family:var(--font-header);letter-spacing:1px;font-size:18px;margin-bottom:8px}
    .login-sub{color:#a0a0a0;font-size:12px;line-height:1.5;margin-bottom:16px}
    .login-row{display:flex;gap:10px}
    .login-input{
      flex:1;background:#000;border:1px solid #333;border-radius:10px;color:#fff;padding:12px 12px;font-size:14px
    }
    .login-input:focus{outline:none;border-color:#fff}
    .login-btn{
      padding:12px 14px;border-radius:10px;border:none;background:#fff;color:#000;font-weight:800;cursor:pointer;
      font-family:var(--font-header);letter-spacing:1px;text-transform:uppercase
    }
    .login-hint{margin-top:12px;color:#666;font-size:11px}

    /* Mobile */
    @media (max-width:900px){
      .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);width:280px;box-shadow:10px 0 30px rgba(0,0,0,.8)}
      .sidebar.active{transform:translateX(0)}
      .sidebar-overlay.active{display:block}
      .menu-toggle{display:block}
      .chat-header{padding:15px}
      .brand-title{font-size:16px}
      .stats-container{display:none}
      .message{max-width:90%}
      .input-area{padding:10px 15px;gap:8px}
      .icon-btn{width:45px;height:45px}
    }
    @media (max-width:400px){.input-wrapper{max-height:100px}.menu-toggle{margin-right:10px}}
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div class="login-overlay" id="loginOverlay" aria-hidden="true">
    <div class="login-card">
      <div class="login-title">LOGIN USERNAME</div>
      <div class="login-sub">
        Masukin username dulu biar nama kamu tampil di chat.<br/>
        (Disimpan di browser kamu)
      </div>
      <div class="login-row">
        <input id="loginUsername" class="login-input" maxlength="20" placeholder="contoh: rezaxd" autocomplete="off" />
        <button id="loginBtn" class="login-btn">Masuk</button>
      </div>
      <div class="login-hint">Tip: hanya huruf/angka/underscore, 3–20 karakter.</div>
    </div>
  </div>

  <div class="connection-badge connecting" id="connectionStatus">
    <i class="fas fa-wifi"></i><span>Connecting...</span>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Modal Preview -->
  <div class="modal-overlay" id="imageModal">
    <img id="modalImage" class="modal-img" src="" alt="Full Size" />
  </div>

  <div class="app-container">
    <div class="sidebar" id="sidebar">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">ME</div>
        <div class="user-name" id="myUsername">Loading...</div>
        <div class="user-role role-user" id="myRoleBadge">USER</div>
        <div class="user-status">
          <div class="status-dot"></div>
          <span id="connectionText">Connecting...</span>
        </div>
      </div>

      <div class="btn-dashboard" onclick="window.location.href='/dashboard'">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="#00bff9" d="M13 9V3h8v6zM3 13V3h8v10zm10 8V11h8v10zM3 21v-6h8v6z"/></svg>
        <span>Dashboard</span>
      </div>

      <div class="online-users">
        <div class="section-header">
          <span>Online Users</span>
          <span id="onlineCount">0</span>
        </div>
        <div class="users-list" id="userList"></div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header">
        <div style="display:flex;align-items:center;">
          <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
          <div class="brand-title">LIVE <span style="color:#666">CHAT</span></div>
        </div>
        <div class="stats-container">
          <div class="stats-item"><i class="fas fa-users"></i> <span id="totalOnline">0</span></div>
          <div class="stats-item"><i class="fas fa-signal"></i> <span id="ping">0ms</span></div>
        </div>
      </div>

      <div class="messages-container" id="messages">
        <div class="system-message" id="welcomeMessage">
          <i class="fas fa-circle-notch fa-spin"></i> Waiting for login...
        </div>
      </div>

      <div class="typing-area" id="typingIndicator" style="display:none;">
        <div class="dots"><span></span><span></span><span></span></div>
        <span id="typingText">Someone is typing...</span>
      </div>

      <div class="input-area">
        <div class="input-wrapper">
          <div class="file-preview" id="filePreview">
            <i class="fas fa-image"></i>
            <span id="fileName">image.jpg</span>
            <i class="fas fa-times remove-file" id="removeFile"></i>
          </div>
          <textarea id="messageInput" placeholder="Type message (or select image)..." disabled></textarea>
        </div>
        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;">
        <div class="btn-group">
          <button class="icon-btn" id="attachButton" disabled><i class="fas fa-paperclip"></i></button>
          <button class="icon-btn btn-send" id="sendButton" disabled><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Socket.IO client via CDN (lebih aman untuk static deploy) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"
          integrity="sha384-HFz8oXnA4hC9o9p3o8u7+W1xUqgC2O2kqg4Y8mXWwGvQqz4fF4u7c5yO4g7bqj5Z"
          crossorigin="anonymous"></script>

  <script>
    /**
     * Konfigurasi:
     * - Kalau server Socket.IO kamu ada di domain lain, set:
     *   window.SOCKET_URL = "https://server-kamu.com"
     * - Default: sama dengan origin (window.location.origin)
     */
    const SOCKET_URL = window.SOCKET_URL || window.location.origin;

    const STORAGE_KEY = "ic_username";

    const els = {
      messages: document.getElementById("messages"),
      messageInput: document.getElementById("messageInput"),
      sendButton: document.getElementById("sendButton"),
      attachButton: document.getElementById("attachButton"),
      fileInput: document.getElementById("fileInput"),
      connectionStatus: document.getElementById("connectionStatus"),
      welcomeMessage: document.getElementById("welcomeMessage"),
      typingIndicator: document.getElementById("typingIndicator"),
      typingText: document.getElementById("typingText"),
      userList: document.getElementById("userList"),
      onlineCount: document.getElementById("onlineCount"),
      totalOnline: document.getElementById("totalOnline"),
      myUsername: document.getElementById("myUsername"),
      myRoleBadge: document.getElementById("myRoleBadge"),
      userAvatar: document.getElementById("userAvatar"),
      connectionText: document.getElementById("connectionText"),
      imageModal: document.getElementById("imageModal"),
      modalImage: document.getElementById("modalImage"),
      ping: document.getElementById("ping"),
      filePreview: document.getElementById("filePreview"),
      fileName: document.getElementById("fileName"),
      removeFile: document.getElementById("removeFile"),
      menuToggle: document.getElementById("menuToggle"),
      sidebar: document.getElementById("sidebar"),
      sidebarOverlay: document.getElementById("sidebarOverlay"),
      loginOverlay: document.getElementById("loginOverlay"),
      loginUsername: document.getElementById("loginUsername"),
      loginBtn: document.getElementById("loginBtn"),
    };

    let socket = null;
    let isConnected = false;
    let typingTimeout = null;
    let lastPing = Date.now();
    let pingInterval = null;
    let currentFile = null;
    let currentFileData = null;

    // user state
    const myUser = { username: null, role: "user" };

    function init() {
      setupMobileListeners();
      setupEventListeners();
      autoresizeTextarea();

      const saved = (localStorage.getItem(STORAGE_KEY) || "").trim();
      if (isValidUsername(saved)) {
        myUser.username = saved;
        afterLogin();
      } else {
        requireLogin();
      }
    }

    function requireLogin() {
      updateConnectionStatus("disconnected", "LOGIN REQUIRED");
      enableInput(false);

      els.welcomeMessage.style.display = "block";
      els.welcomeMessage.innerHTML = `<i class="fas fa-user-lock"></i> Please login (username)`;
      els.loginOverlay.classList.add("active");
      els.loginOverlay.setAttribute("aria-hidden", "false");

      // Focus input
      setTimeout(() => els.loginUsername.focus(), 50);
    }

    function afterLogin() {
      els.loginOverlay.classList.remove("active");
      els.loginOverlay.setAttribute("aria-hidden", "true");

      updateUserDisplay();

      els.welcomeMessage.style.display = "block";
      els.welcomeMessage.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Connecting to server...`;

      connectSocket();
    }

    function isValidUsername(name) {
      // 3-20 chars, only letters/numbers/underscore
      return /^[A-Za-z0-9_]{3,20}$/.test(name);
    }

    function updateUserDisplay() {
      els.myUsername.textContent = myUser.username;
      els.userAvatar.textContent = myUser.username.substring(0, 2).toUpperCase();

      els.myRoleBadge.textContent = myUser.role.toUpperCase();
      els.myRoleBadge.className = "user-role";
      if (myUser.role === "owner") els.myRoleBadge.classList.add("role-owner");
      else if (myUser.role === "admin") els.myRoleBadge.classList.add("role-admin");
      else els.myRoleBadge.classList.add("role-user");
    }

    function connectSocket() {
      if (!window.io) {
        updateConnectionStatus("disconnected", "Socket.IO client not loaded");
        return;
      }

      updateConnectionStatus("connecting", "CONNECTING...");
      enableInput(false);

      // connect to external socket server if needed
      socket = io(SOCKET_URL, {
        transports: ["websocket", "polling"],
      });

      socket.on("connect", () => {
        isConnected = true;
        updateConnectionStatus("connected", "CONNECTED");
        socket.emit("chat:login", { username: myUser.username, role: myUser.role });

        els.welcomeMessage.innerHTML = `<i class="fas fa-check"></i> Connected as ${escapeHtml(myUser.username)}`;
        setTimeout(() => (els.welcomeMessage.style.display = "none"), 2500);

        startPingMonitor();
        enableInput(true);
      });

      socket.on("disconnect", () => {
        isConnected = false;
        updateConnectionStatus("disconnected", "DISCONNECTED");
        els.welcomeMessage.style.display = "block";
        els.welcomeMessage.innerHTML = `<i class="fas fa-times"></i> Disconnected`;
        stopPingMonitor();
        enableInput(false);
      });

      socket.on("chat:history", (history) => {
        els.messages.innerHTML = "";
        history.forEach((data) => (data.image ? addImageMessage(data) : addMessage(data)));
        scrollToBottom();
      });

      socket.on("chat:newMessage", (msg) => {
        addMessage(msg);
        scrollToBottom();
      });

      socket.on("chat:userJoin", (data) => {
        addSystemMessage(`${escapeHtml(data.username)} joined`);
        els.onlineCount.textContent = data.onlineCount;
        els.totalOnline.textContent = data.onlineCount;
      });

      socket.on("chat:userLeave", (data) => {
        addSystemMessage(`${escapeHtml(data.username)} left`);
        els.onlineCount.textContent = data.onlineCount;
        els.totalOnline.textContent = data.onlineCount;
      });

      socket.on("chat:onlineUsers", (data) => {
        renderUserList(data.users);
        els.onlineCount.textContent = data.count;
        els.totalOnline.textContent = data.count;
      });

      socket.on("chat:userTyping", (data) => {
        if (data.username !== myUser.username) showTyping(data.username, data.isTyping);
      });

      socket.on("chat:image", (data) => {
        addImageMessage(data);
        scrollToBottom();
      });

      socket.on("pong", () => {
        els.ping.textContent = (Date.now() - lastPing) + "ms";
      });

      socket.on("connect_error", () => {
        // kalau server socket tidak reachable
        updateConnectionStatus("disconnected", "CONNECT ERROR");
        enableInput(false);
        els.welcomeMessage.style.display = "block";
        els.welcomeMessage.innerHTML = `<i class="fas fa-triangle-exclamation"></i> Cannot connect to Socket server`;
      });
    }

    function setupEventListeners() {
      // LOGIN
      els.loginBtn.addEventListener("click", doLogin);
      els.loginUsername.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doLogin();
      });

      // CHAT
      els.sendButton.addEventListener("click", sendMessage);
      els.messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      els.messageInput.addEventListener("input", () => {
        if (!socket || !isConnected) return;
        if (typingTimeout) clearTimeout(typingTimeout);
        socket.emit("chat:typing", true);
        typingTimeout = setTimeout(() => socket.emit("chat:typing", false), 1000);
      });

      els.attachButton.addEventListener("click", () => els.fileInput.click());
      els.fileInput.addEventListener("change", handleFileSelect);
      els.removeFile.addEventListener("click", clearFile);
      els.modalImage.addEventListener("click", () => els.imageModal.classList.remove("active"));
    }

    function doLogin() {
      const raw = (els.loginUsername.value || "").trim();
      if (!isValidUsername(raw)) {
        els.loginUsername.focus();
        els.loginUsername.select();
        return alert("Username harus 3–20 karakter dan hanya huruf/angka/underscore.");
      }
      myUser.username = raw;
      localStorage.setItem(STORAGE_KEY, raw);
      afterLogin();
    }

    function sendMessage() {
      const text = (els.messageInput.value || "").trim();
      if (!isConnected || !socket) return;

      if (currentFile) {
        socket.emit("chat:image", {
          image: currentFileData,
          filename: currentFile.name,
          message: text,
          username: myUser.username,
          role: myUser.role,
        });
        clearFile();
      } else if (text) {
        socket.emit("chat:message", {
          message: text,
          username: myUser.username,
          role: myUser.role,
        });
      }

      els.messageInput.value = "";
      els.messageInput.style.height = "auto";
    }

    function handleFileSelect(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const okType = file.type.match("image.*") || file.type.match("video.*");
      if (!okType) return alert("Hanya boleh image/video");
      if (file.size > 10 * 1024 * 1024) return alert("Max 10MB");

      els.filePreview.classList.add("active");
      els.fileName.textContent = file.name;

      currentFile = file;
      const reader = new FileReader();
      reader.onload = (ev) => (currentFileData = ev.target.result);
      reader.readAsDataURL(file);
    }

    function clearFile() {
      currentFile = null;
      currentFileData = null;
      els.filePreview.classList.remove("active");
      els.fileInput.value = "";
    }

    function getBadgeHTML(role) {
      if (role === "owner") return '<span class="msg-role-badge badge-owner">OWNER</span>';
      if (role === "admin") return '<span class="msg-role-badge badge-admin">ADMIN</span>';
      return '<span class="msg-role-badge badge-user">USER</span>';
    }

    function addMessage(data) {
      const isOwn = data.username === myUser.username;
      const div = document.createElement("div");
      div.className = `message ${isOwn ? "own" : "other"}`;

      const time = new Date(data.timestamp || Date.now()).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

      let nameColor = "#fff";
      if (data.role === "owner") nameColor = "#ffd700";
      else if (data.role === "admin") nameColor = "#00e5ff";

      div.innerHTML = `
        <div class="msg-meta">
          <span style="color:${nameColor}">${escapeHtml(data.username || "")}</span>
          ${getBadgeHTML(data.role)}
          <span>${time}</span>
        </div>
        <div class="msg-bubble">${escapeHtml(data.message || "").replace(/\n/g, "<br>")}</div>
      `;
      els.messages.appendChild(div);
    }

    function addImageMessage(data) {
      const isOwn = data.username === myUser.username;
      const div = document.createElement("div");
      div.className = `message ${isOwn ? "own" : "other"}`;

      const time = new Date(data.timestamp || Date.now()).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

      let nameColor = "#fff";
      if (data.role === "owner") nameColor = "#ffd700";
      else if (data.role === "admin") nameColor = "#00e5ff";

      const captionHTML = data.message ? `<div style="margin-bottom:8px">${escapeHtml(data.message).replace(/\n/g, "<br>")}</div>` : "";
      const imgHTML = data.image ? `<img src="${data.image}" alt="Image" data-preview="1">` : "";

      div.innerHTML = `
        <div class="msg-meta">
          <span style="color:${nameColor}">${escapeHtml(data.username || "")}</span>
          ${getBadgeHTML(data.role)}
          <span>${time}</span>
        </div>
        <div class="msg-bubble">
          ${captionHTML}
          ${imgHTML}
        </div>
      `;
      els.messages.appendChild(div);

      const img = div.querySelector('img[data-preview="1"]');
      if (img) img.addEventListener("click", () => openPreview(data.image));
    }

    function openPreview(src) {
      els.modalImage.src = src;
      els.imageModal.classList.add("active");
    }

    function addSystemMessage(text) {
      const div = document.createElement("div");
      div.className = "system-message";
      div.innerHTML = text;
      els.messages.appendChild(div);
      scrollToBottom();
      setTimeout(() => div.remove(), 5000);
    }

    function renderUserList(users) {
      els.userList.innerHTML = "";
      (users || [])
        .slice()
        .sort((a, b) => {
          const order = { owner: 0, admin: 1, user: 2 };
          return (order[a.role] ?? 99) - (order[b.role] ?? 99);
        })
        .forEach((u) => {
          const div = document.createElement("div");
          div.className = "user-item";
          let roleColor = "#ccc";
          if (u.role === "owner") roleColor = "#ffd700";
          else if (u.role === "admin") roleColor = "#00e5ff";

          div.innerHTML = `
            <div class="item-avatar">${String(u.username || "??").substring(0,2).toUpperCase()}</div>
            <div class="item-info">
              <h4 style="color:${roleColor}">${escapeHtml(u.username || "")}</h4>
              <span style="color:${(roleColor === "#ffd700" || roleColor === "#00e5ff") ? roleColor : "#666"}">${String(u.role || "user").toUpperCase()}</span>
            </div>
          `;
          els.userList.appendChild(div);
        });
    }

    function showTyping(name, isTyping) {
      els.typingIndicator.style.display = isTyping ? "flex" : "none";
      els.typingText.textContent = `${name} is typing...`;
    }

    function updateConnectionStatus(status, label) {
      els.connectionStatus.className = `connection-badge ${status}`;
      const icons = { connected: "fa-wifi", disconnected: "fa-wifi-slash", connecting: "fa-spinner fa-spin" };
      els.connectionStatus.innerHTML = `<i class="fas ${icons[status] || "fa-spinner fa-spin"}"></i> <span>${label || status.toUpperCase()}</span>`;
      els.connectionText.textContent = label || status.toUpperCase();
    }

    function enableInput(enable) {
      els.messageInput.disabled = !enable;
      els.sendButton.disabled = !enable;
      els.attachButton.disabled = !enable;
      if (enable) els.messageInput.focus();
    }

    function startPingMonitor() {
      stopPingMonitor();
      pingInterval = setInterval(() => {
        if (!socket || !isConnected) return;
        lastPing = Date.now();
        socket.emit("ping");
      }, 5000);
    }
    function stopPingMonitor() {
      if (pingInterval) clearInterval(pingInterval);
      pingInterval = null;
    }

    function escapeHtml(t) {
      const d = document.createElement("div");
      d.textContent = String(t ?? "");
      return d.innerHTML;
    }

    function scrollToBottom() {
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    function autoresizeTextarea() {
      els.messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });
    }

    function setupMobileListeners() {
      function toggleSidebar(show) {
        if (show === undefined) show = !els.sidebar.classList.contains("active");
        if (show) {
          els.sidebar.classList.add("active");
          els.sidebarOverlay.classList.add("active");
        } else {
          els.sidebar.classList.remove("active");
          els.sidebarOverlay.classList.remove("active");
        }
      }
      els.menuToggle.addEventListener("click", () => toggleSidebar(true));
      els.sidebarOverlay.addEventListener("click", () => toggleSidebar(false));
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          els.imageModal.classList.remove("active");
          toggleSidebar(false);
        }
      });
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
