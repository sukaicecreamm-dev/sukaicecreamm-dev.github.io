<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta name="theme-color" content="#0b1220" />
  <title>LIVE CHAT | SCARRY DEATH</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-body:#0b1220;
      --bg-card:rgba(13, 18, 32, .55);
      --bg-input:rgba(0,0,0,.55);
      --bg-sidebar:rgba(12, 16, 28, .62);

      --text-primary:#eaf2ff;
      --text-secondary:#9db4d8;
      --text-muted:#6b7a94;

      --border-color:rgba(140, 170, 220, .18);
      --border-strong:rgba(150, 200, 255, .35);

      --msg-own-bg:rgba(240, 248, 255, .9);
      --msg-own-text:#081018;

      --msg-other-bg:rgba(12, 16, 28, .58);
      --msg-other-text:#eaf2ff;

      --font-header:'Orbitron',sans-serif;
      --font-body:'Share Tech Mono',monospace;

      --radius-card:16px;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:var(--font-body);-webkit-tap-highlight-color:transparent}
    body{
      height:100dvh;
      background: radial-gradient(circle at top center, #0f1a2f 0%, #070b12 70%, #05070b 100%);
      color:var(--text-primary);
      overflow:hidden;
      display:flex;
      justify-content:center;
    }

    /* Scrollbar */
    ::-webkit-scrollbar{width:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:3px}
    ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.2)}

    /* ===== Animated BG ===== */
    .bg-anim{
      position:fixed;
      inset:0;
      pointer-events:none; /* penting biar UI bisa dipencet */
      z-index:0;
    }
    #starCanvas{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      filter: drop-shadow(0 0 10px rgba(120,190,255,.25));
    }

    /* ===== App Container ===== */
    .app-container{
      display:flex;width:100%;height:100%;max-width:1600px;position:relative;
      z-index:5; /* di atas background */
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:300px;height:100%;
      background: linear-gradient(180deg, rgba(20,30,55,.62) 0%, rgba(10,14,26,.58) 70%, rgba(8,10,16,.62) 100%);
      border-right:1px solid var(--border-color);
      display:flex;flex-direction:column;flex-shrink:0;
      transition:transform .3s cubic-bezier(.4,0,.2,1);
      z-index:50;
      backdrop-filter: blur(12px);
    }

    .user-card{
      position:relative;
      z-index:80;
      background: linear-gradient(180deg, rgba(10,18,36,.55) 0%, rgba(9,12,22,.45) 100%);
      border-bottom:1px solid var(--border-color);
      padding:22px 18px;
      text-align:center;
      display:flex;flex-direction:column;align-items:center;
    }

    .user-avatar{
      position:relative;
      z-index:90;
      width:74px;height:74px;margin-bottom:12px;border-radius:16px;
      background: radial-gradient(circle at 30% 30%, rgba(120,190,255,.35), rgba(0,0,0,.9));
      border:1px solid var(--border-strong);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--font-header);font-size:24px;color:#fff;font-weight:700;
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      overflow:hidden;
      cursor:pointer;
      user-select:none;
    }
    .user-avatar::after{
      content:"";
      position:absolute;inset:-40%;
      background: conic-gradient(from 180deg, rgba(110,200,255,.0), rgba(110,200,255,.35), rgba(110,200,255,.0));
      animation: spinGlow 6s linear infinite;
      opacity:.65;
    }
    @keyframes spinGlow{
      from{ transform:rotate(0deg); }
      to{ transform:rotate(360deg); }
    }
    .user-avatar span{
      position:relative;
      z-index:2;
      text-shadow:0 0 16px rgba(110,200,255,.55);
    }

    .avatar-edit{
      position:absolute;
      right:16px;
      top:16px;
      z-index:120;
      pointer-events:auto;
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--border-strong);
      background: rgba(0,0,0,.55);
      color:rgba(210,235,255,.95);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .avatar-edit:active{ transform:scale(.98); }

    .user-name{
      font-family:var(--font-header);
      font-size:18px;
      color:var(--text-primary);
      margin-bottom:6px;
      letter-spacing:.6px;
    }

    .user-role{
      font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:1px;
      padding:6px 12px;border-radius:999px;margin-bottom:14px;display:inline-block;
      border:1px solid var(--border-color);
      background: rgba(255,255,255,.06);
    }
    .role-owner{
      background:linear-gradient(135deg,#ffd700,#ffaa00);color:#000;
      border:1px solid rgba(255,255,255,.55);
      box-shadow:0 0 18px rgba(255,215,0,.35);
    }
    .role-admin{
      background:linear-gradient(135deg,#00e5ff,#0077ff);color:#000;
      border:1px solid rgba(255,255,255,.5);
      box-shadow:0 0 18px rgba(0,229,255,.3);
    }
    .role-user{ background:rgba(255,255,255,.06); color:#d5e5ff; }

    .user-status{
      font-size:12px;color:var(--text-muted);
      display:flex;align-items:center;gap:8px;
    }
    .status-dot{
      width:8px;height:8px;background:#4ade80;border-radius:50%;
      box-shadow:0 0 10px rgba(74,222,128,.35);
    }

    /* Logout */
    .logout-btn{
      margin-top:12px;
      width:100%;
      max-width:240px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border-color);
      background: rgba(0,0,0,.35);
      color: rgba(230,245,255,.9);
      font-family: var(--font-header);
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .logout-btn:hover{ border-color: rgba(180,220,255,.35); }
    .logout-btn:active{ transform: translateY(1px); }

    .online-users{flex:1;overflow:hidden;display:flex;flex-direction:column}
    .section-header{
      padding:15px 18px;border-bottom:1px solid var(--border-color);
      font-family:var(--font-header);font-size:12px;color:var(--text-secondary);
      text-transform:uppercase;letter-spacing:1.5px;display:flex;justify-content:space-between;
    }
    .users-list{flex:1;overflow-y:auto;padding:10px}
    .user-item{
      display:flex;align-items:center;gap:12px;padding:12px;border-radius:14px;margin-bottom:6px;
      transition:background .2s,border .2s;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.18);
    }
    .user-item:hover{ background: rgba(255,255,255,.06); border-color: rgba(180,220,255,.18); }
    .item-avatar{
      width:34px;height:34px;border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(120,190,255,.25), rgba(0,0,0,.75));
      border:1px solid rgba(180,220,255,.18);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--font-header);font-size:12px;color:#d8ecff;
    }
    .item-info h4{font-size:13px;color:var(--text-primary)}
    .item-info span{font-size:11px;color:var(--text-muted);text-transform:uppercase}

    /* ===== Chat ===== */
    .chat-area{flex:1;display:flex;flex-direction:column;position:relative;width:100%}

    .chat-header{
      position:relative;
      z-index:60;
      padding:14px 16px;
      border-bottom:1px solid var(--border-color);
      display:flex;justify-content:space-between;align-items:center;
      background: linear-gradient(90deg, rgba(10,16,30,.72), rgba(8,10,16,.62));
      backdrop-filter: blur(14px);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }

    .menu-toggle{
      display:none;
      background:none;border:none;color:rgba(230,245,255,.95);
      font-size:20px;cursor:pointer;margin-right:12px;padding:6px;border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.25);
    }
    .menu-toggle:active{ transform:scale(.98); }

    .brand-title{
      font-family:var(--font-header);
      font-size:18px;font-weight:600;
      letter-spacing:1px;
      display:flex;align-items:center;gap:10px;
    }
    .premium-pill{
      font-family:var(--font-header);
      font-size:10px;
      letter-spacing:2px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(120,190,255,.25);
      background: radial-gradient(circle at 30% 30%, rgba(120,190,255,.18), rgba(0,0,0,.18));
      color: rgba(215,240,255,.95);
      box-shadow:0 0 18px rgba(120,190,255,.15);
    }

    .stats-container{display:flex;gap:18px;font-size:13px;color:rgba(190,220,255,.7)}
    .stats-item i{margin-right:6px;color:rgba(160,210,255,.75)}

    /* Music button: taruh di bawah tombol menu */
    .music-btn{
      position:absolute;
      left:14px;
      top:62px;
      z-index:100;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(120,190,255,.22);
      background: rgba(0,0,0,.28);
      color: rgba(230,245,255,.92);
      font-family: var(--font-header);
      font-size: 9px;
      letter-spacing: 1.4px;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      box-shadow:0 14px 40px rgba(0,0,0,.35);
    }
    .music-btn:hover{ border-color: rgba(120,190,255,.4); }
    .music-btn:active{ transform: translateY(1px); }
    .music-dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(255,255,255,.18);
      box-shadow:none;
    }
    .music-dot.on{
      background:#22c55e;
      box-shadow:0 0 12px rgba(34,197,94,.55);
    }
    .music-dot.off{
      background:#ef4444;
      box-shadow:0 0 12px rgba(239,68,68,.35);
    }

    .messages-container{
      flex:1;
      padding:18px 16px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height:0;
      background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.18));
    }

    .system-message{
      align-self:center;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(180,220,255,.14);
      padding:8px 14px;
      border-radius:999px;
      font-size:11px;
      color: rgba(220,240,255,.75);
      letter-spacing:1px;
      text-transform:uppercase;
      backdrop-filter: blur(10px);
    }

    .message{max-width:75%;display:flex;flex-direction:column;animation:fadeIn .22s ease}
    .message.own{align-self:flex-end;align-items:flex-end}
    .message.other{align-self:flex-start;align-items:flex-start}

    .msg-meta{
      margin-bottom:6px;
      font-size:11px;
      color: rgba(220,240,255,.6);
      font-family:var(--font-header);
      display:flex;
      gap:8px;
      align-items:center;
      text-shadow: 0 0 14px rgba(0,0,0,.5);
    }

    .msg-role-badge{
      font-size:9px;font-weight:800;padding:3px 7px;border-radius:8px;
      letter-spacing:.8px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .badge-owner{background:linear-gradient(135deg,#ffd700,#ffaa00);color:#000;border:none}
    .badge-admin{background:linear-gradient(135deg,#00e5ff,#0077ff);color:#000;border:none}
    .badge-user{color:rgba(210,235,255,.9)}

    .msg-bubble{
      padding:12px 14px;
      border-radius:16px;
      font-size:14px;
      line-height:1.55;
      position:relative;
      word-break:break-word;
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 50px rgba(0,0,0,.24);
    }
    .message.own .msg-bubble{
      background: var(--msg-own-bg);
      color: var(--msg-own-text);
      border:1px solid rgba(255,255,255,.5);
      border-radius:16px 16px 6px 16px;
    }
    .message.other .msg-bubble{
      background: var(--msg-other-bg);
      color: var(--msg-other-text);
      border:1px solid rgba(180,220,255,.14);
      border-radius:16px 16px 16px 6px;
    }

    .msg-bubble img{
      max-width:100%;
      border-radius:12px;
      margin-top:10px;
      cursor:pointer;
      border:1px solid rgba(180,220,255,.18);
      display:block;
    }

    /* ===== Input ===== */
    .input-area{
      padding:12px 14px;
      border-top:1px solid var(--border-color);
      background: linear-gradient(180deg, rgba(8,10,16,.55), rgba(0,0,0,.45));
      display:flex;
      gap:10px;
      align-items:flex-end;
      flex-shrink:0;
      backdrop-filter: blur(14px);
    }
    .input-wrapper{
      flex:1;display:flex;flex-direction:column;gap:8px;
      min-width:0;overflow:hidden;max-height:120px;
    }
    .file-preview{
      display:none;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(180,220,255,.14);
      padding:8px 12px;
      border-radius:12px;
      align-items:center;gap:10px;
      font-size:12px;
      color: rgba(210,235,255,.8);
      width:100%;
      backdrop-filter: blur(10px);
    }
    .file-preview.active{display:flex}
    #fileName{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
    .remove-file{margin-left:auto;cursor:pointer;color:rgba(220,240,255,.55)}
    textarea#messageInput{
      width:100%;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(180,220,255,.14);
      border-radius:16px;
      color:#eaf2ff;
      padding:14px;
      font-size:14px;
      resize:none;
      min-height:52px;
      transition:border .2s;
      backdrop-filter: blur(10px);
    }
    textarea#messageInput:focus{outline:none;border-color:rgba(180,220,255,.35)}

    .btn-group{display:flex;gap:10px;flex-shrink:0;align-self:flex-end}
    .icon-btn{
      width:50px;height:50px;border-radius:16px;
      border:1px solid rgba(180,220,255,.14);
      background: rgba(0,0,0,.35);
      color: rgba(230,245,255,.75);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      font-size:16px;
      transition:transform .15s,border .15s, background .15s;
      backdrop-filter: blur(10px);
    }
    .icon-btn:hover{border-color:rgba(180,220,255,.32)}
    .icon-btn:active{transform:scale(.98)}
    .btn-send{
      background: radial-gradient(circle at 30% 30%, rgba(120,190,255,.9), rgba(30,90,180,.75));
      color:#06101c;
      border:none;
      font-weight:800;
      box-shadow:0 18px 50px rgba(30,90,180,.25);
    }
    .btn-send:hover{filter:brightness(1.05)}

    /* Typing */
    .typing-area{
      padding:0 16px 10px;height:20px;
      font-size:11px;color: rgba(200,230,255,.6);
      display:flex;align-items:center;gap:6px;flex-shrink:0;
    }
    .dots span{width:3px;height:3px;background:rgba(210,235,255,.55);border-radius:50%;display:inline-block;animation:bounce 1.4s infinite}
    .dots span:nth-child(2){animation-delay:.2s}
    .dots span:nth-child(3){animation-delay:.4s}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

    /* Overlay & Modal */
    .sidebar-overlay{
      display:none;position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,.65);z-index:40;backdrop-filter: blur(2px)
    }
    .modal-overlay{
      display:none;position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,.92);z-index:1000;justify-content:center;align-items:center
    }
    .modal-overlay.active{display:flex}
    .modal-img{max-width:95%;max-height:90vh;object-fit:contain;border-radius:14px;border:1px solid rgba(180,220,255,.14);cursor:zoom-out}

    /* Connection badge */
    .connection-badge{
      position:fixed;top:16px;right:16px;
      padding:8px 12px;border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(180,220,255,.14);
      font-size:10px;
      font-family:var(--font-header);
      display:flex;align-items:center;gap:8px;
      z-index:999;
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
      letter-spacing:1.2px;
      text-transform:uppercase;
    }
    .connection-badge.connected{border-color:rgba(34,197,94,.35);color:#22c55e}
    .connection-badge.disconnected{border-color:rgba(239,68,68,.35);color:#ef4444}
    .connection-badge.connecting{border-color:rgba(250,204,21,.35);color:#facc15}

    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    /* LOGIN MODAL */
    .login-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.86);
      z-index:2000;display:none;align-items:center;justify-content:center;padding:20px;
      backdrop-filter: blur(12px);
    }
    .login-overlay.active{display:flex}
    .login-card{
      width:100%;max-width:480px;
      background: linear-gradient(180deg, rgba(12,16,28,.75), rgba(0,0,0,.55));
      border:1px solid rgba(180,220,255,.16);
      border-radius:18px;
      padding:22px;
      box-shadow:0 24px 90px rgba(0,0,0,.65);
    }
    .login-title{font-family:var(--font-header);letter-spacing:1.2px;font-size:18px;margin-bottom:8px}
    .login-sub{color:rgba(210,235,255,.7);font-size:12px;line-height:1.6;margin-bottom:16px}
    .login-row{display:flex;gap:10px}
    .login-input{
      flex:1;background:rgba(0,0,0,.55);
      border:1px solid rgba(180,220,255,.16);
      border-radius:14px;
      color:#fff;padding:12px 12px;font-size:14px
    }
    .login-input:focus{outline:none;border-color:rgba(180,220,255,.35)}
    .login-btn{
      padding:12px 14px;border-radius:14px;border:none;
      background: radial-gradient(circle at 30% 30%, rgba(120,190,255,.95), rgba(30,90,180,.8));
      color:#06101c;font-weight:900;cursor:pointer;
      font-family:var(--font-header);letter-spacing:1px;text-transform:uppercase;
      box-shadow:0 18px 60px rgba(30,90,180,.25);
    }
    .login-hint{margin-top:12px;color:rgba(210,235,255,.45);font-size:11px}

    /* Profile modal */
    .profile-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.82);
      z-index:2100;display:none;align-items:center;justify-content:center;padding:20px;
      backdrop-filter: blur(12px);
    }
    .profile-overlay.active{display:flex}
    .profile-card{
      width:100%;max-width:520px;
      background: linear-gradient(180deg, rgba(12,16,28,.78), rgba(0,0,0,.58));
      border:1px solid rgba(180,220,255,.16);
      border-radius:18px;
      padding:18px;
      box-shadow:0 24px 90px rgba(0,0,0,.65);
    }
    .profile-top{
      display:flex;align-items:center;justify-content:space-between;
      padding-bottom:12px;margin-bottom:12px;border-bottom:1px solid rgba(180,220,255,.12)
    }
    .profile-top h3{
      font-family:var(--font-header);
      font-size:14px;
      letter-spacing:1.4px;
      text-transform:uppercase;
      color:rgba(230,245,255,.92);
    }
    .profile-close{
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(180,220,255,.14);
      background:rgba(0,0,0,.35);
      color:rgba(230,245,255,.85);
      cursor:pointer;
    }
    .profile-close:active{ transform:scale(.98); }
    .profile-grid{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:14px;
      align-items:center;
    }
    .profile-preview{
      width:120px;height:120px;border-radius:22px;
      border:1px solid rgba(180,220,255,.18);
      background: radial-gradient(circle at 30% 30%, rgba(120,190,255,.22), rgba(0,0,0,.8));
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 18px 70px rgba(0,0,0,.45);
    }
    .profile-preview img{
      width:100%;height:100%;object-fit:cover;display:none;
    }
    .profile-preview .pp-initials{
      font-family:var(--font-header);
      font-weight:900;
      font-size:34px;
      color:#eaf2ff;
      text-shadow:0 0 18px rgba(120,190,255,.45);
    }
    .profile-actions{
      display:flex;flex-direction:column;gap:10px;
    }
    .profile-actions .row{
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .btn{
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(180,220,255,.14);
      background:rgba(0,0,0,.35);
      color:rgba(230,245,255,.9);
      font-family:var(--font-header);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn:hover{ border-color: rgba(180,220,255,.3); }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      border:none;
      background: radial-gradient(circle at 30% 30%, rgba(120,190,255,.95), rgba(30,90,180,.8));
      color:#06101c;
      font-weight:900;
    }
    .small-note{
      font-size:11px;
      color:rgba(210,235,255,.55);
      line-height:1.6;
    }

    /* Mobile */
    @media (max-width:900px){
      .sidebar{
        position:fixed;left:0;top:0;bottom:0;
        transform:translateX(-100%);
        width:280px;
        box-shadow: 20px 0 80px rgba(0,0,0,.6);
      }
      .sidebar.active{transform:translateX(0)}
      .sidebar-overlay.active{display:block}
      .menu-toggle{display:block}
      .stats-container{display:none}
      .message{max-width:90%}
      .icon-btn{width:46px;height:46px;border-radius:16px}
      .music-btn{ top:56px; left:12px; }
    }
    @media (max-width:420px){
      .profile-grid{ grid-template-columns: 1fr; }
      .profile-preview{ margin: 0 auto; }
    }
  </style>
</head>

<body>
  <!-- Animated background -->
  <div class="bg-anim" aria-hidden="true">
    <canvas id="starCanvas"></canvas>
  </div>

  <!-- LOGIN -->
  <div class="login-overlay" id="loginOverlay" aria-hidden="true">
    <div class="login-card">
      <div class="login-title">LOGIN USERNAME</div>
      <div class="login-sub">
        Masukin username dulu biar nama kamu tampil di chat.<br/>
        (Disimpan di browser kamu)
      </div>
      <div class="login-row">
        <input id="loginUsername" class="login-input" maxlength="20" placeholder="contoh: rezaxd" autocomplete="off" />
        <button id="loginBtn" class="login-btn">Masuk</button>
      </div>
      <div class="login-hint">Tip: hanya huruf/angka/underscore, 3–20 karakter.</div>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div class="profile-overlay" id="profileOverlay" aria-hidden="true">
    <div class="profile-card">
      <div class="profile-top">
        <h3>Profile Settings</h3>
        <button class="profile-close" id="profileClose" type="button"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="profile-grid">
        <div class="profile-preview" id="profilePreview">
          <img id="profileImg" alt="Profile photo"/>
          <div class="pp-initials" id="ppInitials">ME</div>
        </div>

        <div class="profile-actions">
          <div class="row">
            <button class="btn" id="btnChangePhoto" type="button"><i class="fa-solid fa-camera"></i> Set Photo</button>
            <button class="btn" id="btnRemovePhoto" type="button"><i class="fa-solid fa-trash"></i> Remove</button>
          </div>
          <div class="row">
            <button class="btn btn-primary" id="btnLogout" type="button"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
            <button class="btn" id="btnCloseProfile" type="button"><i class="fa-regular fa-circle-xmark"></i> Close</button>
          </div>
          <div class="small-note">
            • Foto tersimpan di browser kamu (local).<br/>
            • Kalau logout, kamu bakal diminta login ulang.
          </div>
        </div>
      </div>

      <input type="file" id="ppFile" accept="image/*" style="display:none"/>
    </div>
  </div>

  <!-- Connection badge -->
  <div class="connection-badge connecting" id="connectionStatus">
    <i class="fas fa-spinner fa-spin"></i><span>CONNECTING...</span>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Modal Preview -->
  <div class="modal-overlay" id="imageModal">
    <img id="modalImage" class="modal-img" src="" alt="Full Size" />
  </div>

  <div class="app-container">
    <div class="sidebar" id="sidebar">
      <div class="user-card">
        <button class="avatar-edit" id="avatarEdit" type="button" title="Profile settings">
          <i class="fa-solid fa-user-gear"></i>
        </button>

        <div class="user-avatar" id="userAvatar" title="Klik untuk buka profile">
          <span id="avatarText">ME</span>
        </div>

        <div class="user-name" id="myUsername">Loading...</div>
        <div class="user-role role-user" id="myRoleBadge">USER</div>

        <div class="user-status">
          <div class="status-dot"></div>
          <span id="connectionText">Connecting...</span>
        </div>

        <button class="logout-btn" id="logoutBtn" type="button">
          <i class="fa-solid fa-right-from-bracket"></i> LOGOUT
        </button>
      </div>

      <div class="online-users">
        <div class="section-header">
          <span>Online Users</span>
          <span id="onlineCount">0</span>
        </div>
        <div class="users-list" id="userList"></div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header">
        <div style="display:flex;align-items:center;position:relative;">
          <button class="menu-toggle" id="menuToggle" type="button"><i class="fas fa-bars"></i></button>

          <!-- Music button (di bawah tombol menu) -->
          <button class="music-btn" id="musicBtn" type="button" hidden>
            <span class="music-dot off" id="musicDot"></span>
            <i class="fa-solid fa-music"></i>
            <span id="musicText">TAP TO PLAY</span>
          </button>

          <div class="brand-title">
            LIVE<span style="color:rgba(210,235,255,.6)">CHAT</span>
            <span class="premium-pill">PREMIUM</span>
          </div>
        </div>

        <div class="stats-container">
          <div class="stats-item"><i class="fas fa-users"></i> <span id="totalOnline">0</span></div>
          <div class="stats-item"><i class="fas fa-signal"></i> <span id="ping">0ms</span></div>
        </div>
      </div>

      <div class="messages-container" id="messages">
        <div class="system-message" id="welcomeMessage">
          <i class="fas fa-circle-notch fa-spin"></i> Waiting for login...
        </div>
      </div>

      <div class="typing-area" id="typingIndicator" style="display:none;">
        <div class="dots"><span></span><span></span><span></span></div>
        <span id="typingText">Someone is typing...</span>
      </div>

      <div class="input-area">
        <div class="input-wrapper">
          <div class="file-preview" id="filePreview">
            <i class="fas fa-image"></i>
            <span id="fileName">image.jpg</span>
            <i class="fas fa-times remove-file" id="removeFile"></i>
          </div>
          <textarea id="messageInput" placeholder="Type message (or select image)..." disabled></textarea>
        </div>

        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none;">
        <div class="btn-group">
          <button class="icon-btn" id="attachButton" disabled type="button"><i class="fas fa-paperclip"></i></button>
          <button class="icon-btn btn-send" id="sendButton" disabled type="button"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Audio (loop) -->
  <audio id="bgm" preload="auto" loop>
    <source src="https://files.catbox.moe/wlny2m.mp3" type="audio/mpeg" />
  </audio>

  <!-- Socket.IO client via CDN -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <script>
   window.SOCKET_URL = "https://livechatscarrydeath.raraaprivate.my.id";
    const SOCKET_URL = window.SOCKET_URL || window.location.origin;

    const STORAGE_KEY = "ic_username";
    const PHOTO_KEY   = "ic_profile_photo";

    const els = {
      // chat
      messages: document.getElementById("messages"),
      messageInput: document.getElementById("messageInput"),
      sendButton: document.getElementById("sendButton"),
      attachButton: document.getElementById("attachButton"),
      fileInput: document.getElementById("fileInput"),

      // UI status
      connectionStatus: document.getElementById("connectionStatus"),
      welcomeMessage: document.getElementById("welcomeMessage"),
      typingIndicator: document.getElementById("typingIndicator"),
      typingText: document.getElementById("typingText"),
      userList: document.getElementById("userList"),
      onlineCount: document.getElementById("onlineCount"),
      totalOnline: document.getElementById("totalOnline"),
      myUsername: document.getElementById("myUsername"),
      myRoleBadge: document.getElementById("myRoleBadge"),
      userAvatar: document.getElementById("userAvatar"),
      avatarText: document.getElementById("avatarText"),
      connectionText: document.getElementById("connectionText"),
      imageModal: document.getElementById("imageModal"),
      modalImage: document.getElementById("modalImage"),
      ping: document.getElementById("ping"),
      filePreview: document.getElementById("filePreview"),
      fileName: document.getElementById("fileName"),
      removeFile: document.getElementById("removeFile"),
      menuToggle: document.getElementById("menuToggle"),
      sidebar: document.getElementById("sidebar"),
      sidebarOverlay: document.getElementById("sidebarOverlay"),

      // login
      loginOverlay: document.getElementById("loginOverlay"),
      loginUsername: document.getElementById("loginUsername"),
      loginBtn: document.getElementById("loginBtn"),

      // profile
      avatarEdit: document.getElementById("avatarEdit"),
      profileOverlay: document.getElementById("profileOverlay"),
      profileClose: document.getElementById("profileClose"),
      btnCloseProfile: document.getElementById("btnCloseProfile"),
      btnLogout: document.getElementById("btnLogout"),
      logoutBtn: document.getElementById("logoutBtn"),
      btnChangePhoto: document.getElementById("btnChangePhoto"),
      btnRemovePhoto: document.getElementById("btnRemovePhoto"),
      ppFile: document.getElementById("ppFile"),
      profileImg: document.getElementById("profileImg"),
      ppInitials: document.getElementById("ppInitials"),
      profilePreview: document.getElementById("profilePreview"),

      // music
      musicBtn: document.getElementById("musicBtn"),
      musicDot: document.getElementById("musicDot"),
      musicText: document.getElementById("musicText"),
      bgm: document.getElementById("bgm"),

      // bg
      starCanvas: document.getElementById("starCanvas"),
    };

    let socket = null;
    let isConnected = false;
    let typingTimeout = null;
    let lastPing = Date.now();
    let pingInterval = null;
    let currentFile = null;
    let currentFileData = null;

    const myUser = { username: null, role: "user" };

    // ===== Init =====
    function init() {
      setupStars();
      setupMobileListeners();
      setupEventListeners();
      autoresizeTextarea();

      // show music button after DOM ready
      els.musicBtn.hidden = false;

      const saved = (localStorage.getItem(STORAGE_KEY) || "").trim();
      if (isValidUsername(saved)) {
        myUser.username = saved;
        afterLogin();
      } else {
        requireLogin();
      }
    }

    // ===== Username =====
    function isValidUsername(name) {
      return /^[A-Za-z0-9_]{3,20}$/.test(name);
    }

    function requireLogin() {
      updateConnectionStatus("disconnected", "LOGIN REQUIRED");
      enableInput(false);

      els.welcomeMessage.style.display = "block";
      els.welcomeMessage.innerHTML = `<i class="fas fa-user-lock"></i> Please login (username)`;

      els.loginOverlay.classList.add("active");
      els.loginOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => els.loginUsername.focus(), 50);
    }

    function afterLogin() {
      els.loginOverlay.classList.remove("active");
      els.loginOverlay.setAttribute("aria-hidden", "true");

      updateUserDisplay();
      loadProfilePhoto();

      els.welcomeMessage.style.display = "block";
      els.welcomeMessage.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Connecting to server...`;

      connectSocket();

      // coba autoplay music (browser sering blok sampai user tap)
      tryAutoplayMusic();
    }

    function doLogin() {
      const raw = (els.loginUsername.value || "").trim();
      if (!isValidUsername(raw)) {
        els.loginUsername.focus();
        els.loginUsername.select();
        return alert("Username harus 3–20 karakter dan hanya huruf/angka/underscore.");
      }
      myUser.username = raw;
      localStorage.setItem(STORAGE_KEY, raw);
      afterLogin();
    }

    function logout() {
      try { if (socket) socket.disconnect(); } catch(e){}
      localStorage.removeItem(STORAGE_KEY);
      // optional: foto biar ikut ke-reset (kalau mau tetap, hapus baris ini)
      // localStorage.removeItem(PHOTO_KEY);

      myUser.username = null;
      enableInput(false);
      els.messages.innerHTML = `<div class="system-message" id="welcomeMessage"><i class="fas fa-user-lock"></i> Logged out</div>`;
      requireLogin();
    }

    // ===== User Display =====
    function updateUserDisplay() {
      els.myUsername.textContent = myUser.username;
      els.myRoleBadge.textContent = myUser.role.toUpperCase();

      els.myRoleBadge.className = "user-role";
      if (myUser.role === "owner") els.myRoleBadge.classList.add("role-owner");
      else if (myUser.role === "admin") els.myRoleBadge.classList.add("role-admin");
      else els.myRoleBadge.classList.add("role-user");

      const initials = String(myUser.username).substring(0,2).toUpperCase();
      els.avatarText.textContent = initials;
      els.ppInitials.textContent = initials;
    }

    // ===== Socket =====
    function connectSocket() {
      if (!window.io) {
        updateConnectionStatus("disconnected", "Socket.IO client not loaded");
        return;
      }

      updateConnectionStatus("connecting", "CONNECTING...");
      enableInput(false);

      socket = io(SOCKET_URL, { transports: ["websocket","polling"] });

      socket.on("connect", () => {
        isConnected = true;
        updateConnectionStatus("connected", "CONNECTED");
        socket.emit("chat:login", { username: myUser.username, role: myUser.role });

        els.welcomeMessage.innerHTML = `<i class="fas fa-check"></i> Connected as ${escapeHtml(myUser.username)}`;
        setTimeout(() => (els.welcomeMessage.style.display = "none"), 2000);

        startPingMonitor();
        enableInput(true);
      });

      socket.on("disconnect", () => {
        isConnected = false;
        updateConnectionStatus("disconnected", "DISCONNECTED");
        els.welcomeMessage.style.display = "block";
        els.welcomeMessage.innerHTML = `<i class="fas fa-times"></i> Disconnected`;
        stopPingMonitor();
        enableInput(false);
      });

      socket.on("chat:history", (history) => {
        els.messages.innerHTML = "";
        (history || []).forEach((data) => (data.image ? addImageMessage(data) : addMessage(data)));
        scrollToBottom();
      });

      socket.on("chat:newMessage", (msg) => {
        addMessage(msg);
        scrollToBottom();
      });

      socket.on("chat:userJoin", (data) => {
        addSystemMessage(`${escapeHtml(data.username)} joined`);
        els.onlineCount.textContent = data.onlineCount;
        els.totalOnline.textContent = data.onlineCount;
      });

      socket.on("chat:userLeave", (data) => {
        addSystemMessage(`${escapeHtml(data.username)} left`);
        els.onlineCount.textContent = data.onlineCount;
        els.totalOnline.textContent = data.onlineCount;
      });

      socket.on("chat:onlineUsers", (data) => {
        renderUserList(data.users);
        els.onlineCount.textContent = data.count;
        els.totalOnline.textContent = data.count;
      });

      socket.on("chat:userTyping", (data) => {
        if (data.username !== myUser.username) showTyping(data.username, data.isTyping);
      });

      socket.on("chat:image", (data) => {
        addImageMessage(data);
        scrollToBottom();
      });

      socket.on("pong", () => {
        els.ping.textContent = (Date.now() - lastPing) + "ms";
      });

      socket.on("connect_error", () => {
        updateConnectionStatus("disconnected", "CONNECT ERROR");
        enableInput(false);
        els.welcomeMessage.style.display = "block";
        els.welcomeMessage.innerHTML = `<i class="fas fa-triangle-exclamation"></i> Cannot connect to Socket server`;
      });
    }

    // ===== Events =====
    function setupEventListeners() {
      // login
      els.loginBtn.addEventListener("click", doLogin);
      els.loginUsername.addEventListener("keydown", (e) => { if (e.key === "Enter") doLogin(); });

      // profile open
      els.avatarEdit.addEventListener("click", openProfile);
      els.userAvatar.addEventListener("click", openProfile);

      // profile close
      els.profileClose.addEventListener("click", closeProfile);
      els.btnCloseProfile.addEventListener("click", closeProfile);
      els.profileOverlay.addEventListener("click", (e) => { if (e.target === els.profileOverlay) closeProfile(); });

      // profile photo
      els.btnChangePhoto.addEventListener("click", () => els.ppFile.click());
      els.ppFile.addEventListener("change", onPickPhoto);
      els.btnRemovePhoto.addEventListener("click", removeProfilePhoto);

      // logout
      els.btnLogout.addEventListener("click", logout);
      els.logoutBtn.addEventListener("click", logout);

      // chat
      els.sendButton.addEventListener("click", sendMessage);
      els.messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      els.messageInput.addEventListener("input", () => {
        if (!socket || !isConnected) return;
        if (typingTimeout) clearTimeout(typingTimeout);
        socket.emit("chat:typing", true);
        typingTimeout = setTimeout(() => socket.emit("chat:typing", false), 1000);
      });

      els.attachButton.addEventListener("click", () => els.fileInput.click());
      els.fileInput.addEventListener("change", handleFileSelect);
      els.removeFile.addEventListener("click", clearFile);
      els.modalImage.addEventListener("click", () => els.imageModal.classList.remove("active"));

      // music
      els.musicBtn.addEventListener("click", toggleMusic);

      // allow autoplay after first tap anywhere
      document.addEventListener("pointerdown", unlockAutoplayOnce, { once:true });
      document.addEventListener("keydown", unlockAutoplayOnce, { once:true });
    }

    function openProfile() {
      loadProfilePhoto();
      els.profileOverlay.classList.add("active");
      els.profileOverlay.setAttribute("aria-hidden","false");
    }
    function closeProfile() {
      els.profileOverlay.classList.remove("active");
      els.profileOverlay.setAttribute("aria-hidden","true");
    }

    // ===== Profile Photo (local) =====
    function loadProfilePhoto() {
      const dataUrl = localStorage.getItem(PHOTO_KEY);
      if (dataUrl) {
        els.profileImg.src = dataUrl;
        els.profileImg.style.display = "block";
        els.ppInitials.style.display = "none";

        // apply to sidebar avatar too
        els.userAvatar.style.backgroundImage = `url(${dataUrl})`;
        els.userAvatar.style.backgroundSize = "cover";
        els.userAvatar.style.backgroundPosition = "center";
        els.avatarText.style.display = "none";
      } else {
        els.profileImg.removeAttribute("src");
        els.profileImg.style.display = "none";
        els.ppInitials.style.display = "block";

        // restore avatar
        els.userAvatar.style.backgroundImage = "";
        els.avatarText.style.display = "block";
      }
    }

    function onPickPhoto(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith("image/")) return alert("Pilih file gambar ya.");
      if (file.size > 3 * 1024 * 1024) return alert("Maks 3MB biar ringan.");

      const reader = new FileReader();
      reader.onload = (ev) => {
        const dataUrl = ev.target.result;
        localStorage.setItem(PHOTO_KEY, dataUrl);
        loadProfilePhoto();
      };
      reader.readAsDataURL(file);
      els.ppFile.value = "";
    }

    function removeProfilePhoto() {
      localStorage.removeItem(PHOTO_KEY);
      loadProfilePhoto();
    }

    // ===== Chat Send =====
    function sendMessage() {
      const text = (els.messageInput.value || "").trim();
      if (!isConnected || !socket) return;

      if (currentFile) {
        socket.emit("chat:image", {
          image: currentFileData,
          filename: currentFile.name,
          message: text,
          username: myUser.username,
          role: myUser.role,
        });
        clearFile();
      } else if (text) {
        socket.emit("chat:message", {
          message: text,
          username: myUser.username,
          role: myUser.role,
        });
      }

      els.messageInput.value = "";
      els.messageInput.style.height = "auto";
    }

    function handleFileSelect(e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const okType = file.type.match("image.*") || file.type.match("video.*");
      if (!okType) return alert("Hanya boleh image/video");
      if (file.size > 10 * 1024 * 1024) return alert("Max 10MB");

      els.filePreview.classList.add("active");
      els.fileName.textContent = file.name;

      currentFile = file;
      const reader = new FileReader();
      reader.onload = (ev) => (currentFileData = ev.target.result);
      reader.readAsDataURL(file);
    }

    function clearFile() {
      currentFile = null;
      currentFileData = null;
      els.filePreview.classList.remove("active");
      els.fileInput.value = "";
    }

    function getBadgeHTML(role) {
      if (role === "owner") return '<span class="msg-role-badge badge-owner">OWNER</span>';
      if (role === "admin") return '<span class="msg-role-badge badge-admin">ADMIN</span>';
      return '<span class="msg-role-badge badge-user">USER</span>';
    }

    function addMessage(data) {
      const isOwn = data.username === myUser.username;
      const div = document.createElement("div");
      div.className = `message ${isOwn ? "own" : "other"}`;

      const time = new Date(data.timestamp || Date.now()).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

      let nameColor = "#eaf2ff";
      if (data.role === "owner") nameColor = "#ffd700";
      else if (data.role === "admin") nameColor = "#00e5ff";

      div.innerHTML = `
        <div class="msg-meta">
          <span style="color:${nameColor}">${escapeHtml(data.username || "")}</span>
          ${getBadgeHTML(data.role)}
          <span>${time}</span>
        </div>
        <div class="msg-bubble">${escapeHtml(data.message || "").replace(/\n/g, "<br>")}</div>
      `;
      els.messages.appendChild(div);
    }

    function addImageMessage(data) {
      const isOwn = data.username === myUser.username;
      const div = document.createElement("div");
      div.className = `message ${isOwn ? "own" : "other"}`;

      const time = new Date(data.timestamp || Date.now()).toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

      let nameColor = "#eaf2ff";
      if (data.role === "owner") nameColor = "#ffd700";
      else if (data.role === "admin") nameColor = "#00e5ff";

      const captionHTML = data.message ? `<div style="margin-bottom:8px">${escapeHtml(data.message).replace(/\n/g, "<br>")}</div>` : "";
      const imgHTML = data.image ? `<img src="${data.image}" alt="Image" data-preview="1">` : "";

      div.innerHTML = `
        <div class="msg-meta">
          <span style="color:${nameColor}">${escapeHtml(data.username || "")}</span>
          ${getBadgeHTML(data.role)}
          <span>${time}</span>
        </div>
        <div class="msg-bubble">
          ${captionHTML}
          ${imgHTML}
        </div>
      `;
      els.messages.appendChild(div);

      const img = div.querySelector('img[data-preview="1"]');
      if (img) img.addEventListener("click", () => openPreview(data.image));
    }

    function openPreview(src) {
      els.modalImage.src = src;
      els.imageModal.classList.add("active");
    }

    function addSystemMessage(text) {
      const div = document.createElement("div");
      div.className = "system-message";
      div.innerHTML = text;
      els.messages.appendChild(div);
      scrollToBottom();
      setTimeout(() => div.remove(), 4000);
    }

    function renderUserList(users) {
      els.userList.innerHTML = "";
      (users || [])
        .slice()
        .sort((a, b) => {
          const order = { owner: 0, admin: 1, user: 2 };
          return (order[a.role] ?? 99) - (order[b.role] ?? 99);
        })
        .forEach((u) => {
          const div = document.createElement("div");
          div.className = "user-item";
          let roleColor = "rgba(210,235,255,.85)";
          if (u.role === "owner") roleColor = "#ffd700";
          else if (u.role === "admin") roleColor = "#00e5ff";

          div.innerHTML = `
            <div class="item-avatar">${String(u.username || "??").substring(0,2).toUpperCase()}</div>
            <div class="item-info">
              <h4 style="color:${roleColor}">${escapeHtml(u.username || "")}</h4>
              <span style="color:${(roleColor === "#ffd700" || roleColor === "#00e5ff") ? roleColor : "rgba(210,235,255,.45)"}">${String(u.role || "user").toUpperCase()}</span>
            </div>
          `;
          els.userList.appendChild(div);
        });
    }

    function showTyping(name, isTyping) {
      els.typingIndicator.style.display = isTyping ? "flex" : "none";
      els.typingText.textContent = `${name} is typing...`;
    }

    function updateConnectionStatus(status, label) {
      els.connectionStatus.className = `connection-badge ${status}`;
      const icons = { connected: "fa-wifi", disconnected: "fa-wifi-slash", connecting: "fa-spinner fa-spin" };
      els.connectionStatus.innerHTML = `<i class="fas ${icons[status] || "fa-spinner fa-spin"}"></i> <span>${label || status.toUpperCase()}</span>`;
      els.connectionText.textContent = label || status.toUpperCase();
    }

    function enableInput(enable) {
      els.messageInput.disabled = !enable;
      els.sendButton.disabled = !enable;
      els.attachButton.disabled = !enable;
      if (enable) els.messageInput.focus();
    }

    function startPingMonitor() {
      stopPingMonitor();
      pingInterval = setInterval(() => {
        if (!socket || !isConnected) return;
        lastPing = Date.now();
        socket.emit("ping");
      }, 5000);
    }
    function stopPingMonitor() {
      if (pingInterval) clearInterval(pingInterval);
      pingInterval = null;
    }

    function escapeHtml(t) {
      const d = document.createElement("div");
      d.textContent = String(t ?? "");
      return d.innerHTML;
    }

    function scrollToBottom() {
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    function autoresizeTextarea() {
      els.messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });
    }

    function setupMobileListeners() {
      function toggleSidebar(show) {
        if (show === undefined) show = !els.sidebar.classList.contains("active");
        if (show) {
          els.sidebar.classList.add("active");
          els.sidebarOverlay.classList.add("active");
        } else {
          els.sidebar.classList.remove("active");
          els.sidebarOverlay.classList.remove("active");
        }
      }
      els.menuToggle.addEventListener("click", () => toggleSidebar(true));
      els.sidebarOverlay.addEventListener("click", () => toggleSidebar(false));
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          els.imageModal.classList.remove("active");
          closeProfile();
          toggleSidebar(false);
        }
      });
    }

    // ===== Music =====
    function setMusicUI(isOn) {
      els.musicDot.classList.toggle("on", isOn);
      els.musicDot.classList.toggle("off", !isOn);
      els.musicText.textContent = isOn ? "MUSIC ON" : "MUSIC OFF";
    }

    async function tryAutoplayMusic() {
      // Attempt autoplay (might be blocked)
      try {
        els.bgm.volume = 0.75;
        await els.bgm.play();
        setMusicUI(true);
      } catch (e) {
        // blocked
        setMusicUI(false);
      }
    }

    async function toggleMusic() {
      try {
        if (els.bgm.paused) {
          els.bgm.volume = 0.75;
          await els.bgm.play();
          setMusicUI(true);
        } else {
          els.bgm.pause();
          setMusicUI(false);
        }
      } catch (e) {
        setMusicUI(false);
        alert("Browser kamu blok autoplay. Coba tap sekali lagi ya.");
      }
    }

    async function unlockAutoplayOnce() {
      // called once after user interaction; try play again
      if (els.bgm.paused) {
        try { await els.bgm.play(); setMusicUI(true); } catch(e){}
      }
    }

    // ===== Shooting Stars Background =====
    function setupStars(){
      const canvas = els.starCanvas;
      const ctx = canvas.getContext("2d", { alpha:true });

      let w=0,h=0,dpr=1;
      const stars = [];
      const shooters = [];

      function resize(){
        dpr = Math.max(1, window.devicePixelRatio || 1);
        w = canvas.clientWidth;
        h = canvas.clientHeight;
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        seed();
      }

      function seed(){
        stars.length = 0;
        shooters.length = 0;

        const count = Math.min(260, Math.floor((w*h)/7000));
        for(let i=0;i<count;i++){
          stars.push({
            x: Math.random()*w,
            y: Math.random()*h,
            r: Math.random()*1.4 + 0.3,
            a: Math.random()*0.6 + 0.25,
            tw: Math.random()*0.02 + 0.01,
            ph: Math.random()*Math.PI*2
          });
        }
      }

      function spawnShooter(){
        const fromTop = Math.random() < 0.55;

        const x = fromTop ? (Math.random()*w*1.2 - w*0.1) : (Math.random()*w*0.8);
        const y = fromTop ? (-20 - Math.random()*100) : (Math.random()*h*0.3);

        const speed = 5 + Math.random()*6;
        const angle = (Math.PI * (0.18 + Math.random()*0.22)); // turun serong kanan
        const vx = Math.cos(angle)*speed;
        const vy = Math.sin(angle)*speed;

        shooters.push({
          x, y, vx, vy,
          life: 0,
          maxLife: 40 + Math.random()*40,
          len: 120 + Math.random()*220,
          glow: 0.35 + Math.random()*0.35
        });
      }

      let lastSpawn = 0;

      function draw(t){
        ctx.clearRect(0,0,w,h);

        // vignette
        const g = ctx.createRadialGradient(w*0.5,h*0.45, 0, w*0.5,h*0.5, Math.max(w,h)*0.75);
        g.addColorStop(0, "rgba(0, 40, 80, 0.18)");
        g.addColorStop(0.55,"rgba(0, 0, 0, 0.15)");
        g.addColorStop(1, "rgba(0,0,0,0.52)");
        ctx.fillStyle = g;
        ctx.fillRect(0,0,w,h);

        // stars
        for(const s of stars){
          s.ph += s.tw;
          const alpha = s.a + Math.sin(s.ph)*0.12;
          ctx.beginPath();
          ctx.fillStyle = `rgba(185, 235, 255, ${Math.max(0.05, alpha)})`;
          ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fill();
        }

        // spawn shooters
        if (t - lastSpawn > (900 + Math.random()*700)){
          lastSpawn = t;
          for(let i=0;i< (1 + (Math.random()<0.35 ? 1:0)); i++) spawnShooter();
        }

        // shooters draw
        for (let i=shooters.length-1;i>=0;i--){
          const sh = shooters[i];
          sh.life += 1;

          sh.x += sh.vx;
          sh.y += sh.vy;

          const p = sh.life / sh.maxLife;
          const fade = (1 - p);
          const alpha = Math.max(0, fade) * sh.glow;

          // tail
          const tx = sh.x - sh.vx*12;
          const ty = sh.y - sh.vy*12;

          const grad = ctx.createLinearGradient(sh.x, sh.y, tx, ty);
          grad.addColorStop(0, `rgba(210,245,255, ${alpha})`);
          grad.addColorStop(0.35, `rgba(120,200,255, ${alpha*0.65})`);
          grad.addColorStop(1, `rgba(120,200,255, 0)`);

          ctx.strokeStyle = grad;
          ctx.lineWidth = 2.2;
          ctx.beginPath();
          ctx.moveTo(sh.x, sh.y);
          ctx.lineTo(sh.x - sh.vx* (sh.len/20), sh.y - sh.vy*(sh.len/20));
          ctx.stroke();

          // head glow
          ctx.beginPath();
          ctx.fillStyle = `rgba(220,250,255, ${alpha*0.9})`;
          ctx.arc(sh.x, sh.y, 2.2, 0, Math.PI*2);
          ctx.fill();

          // remove
          if (sh.life > sh.maxLife || sh.x > w+300 || sh.y > h+300) shooters.splice(i,1);
        }

        requestAnimationFrame(draw);
      }

      window.addEventListener("resize", resize, { passive:true });
      resize();
      requestAnimationFrame(draw);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
