<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#0a0f18" />
  <title>LIVE CHAT | PREMIUM</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#0a0f18;
      --card: rgba(16, 24, 38, .55);
      --card2: rgba(12, 18, 30, .75);
      --stroke: rgba(120, 190, 255, .18);
      --stroke2: rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted: rgba(234,242,255,.55);
      --muted2: rgba(234,242,255,.35);

      --good:#4ade80;
      --warn:#facc15;
      --bad:#fb7185;

      --cyan:#7dd3fc;
      --blue:#60a5fa;

      --fontH:'Orbitron',sans-serif;
      --fontB:'Share Tech Mono',monospace;

      --r12:12px;
      --r16:16px;
      --r20:20px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:var(--fontB); -webkit-tap-highlight-color:transparent; }
    html, body { height:100%; }
    body{
      background: radial-gradient(1200px 800px at 20% 0%, rgba(120,190,255,.12), transparent 60%),
                  radial-gradient(900px 900px at 80% 10%, rgba(96,165,250,.10), transparent 55%),
                  linear-gradient(180deg, #060a12, #0a0f18 45%, #060a12);
      color: var(--text);
      overflow:hidden;
    }

    /* ===== Background canvas ===== */
    .bg-wrap{
      position:fixed; inset:0; z-index:-2;
      pointer-events:none;
    }
    canvas#meteorCanvas{
      width:100%; height:100%;
      display:block;
      filter: drop-shadow(0 0 10px rgba(125,211,252,.25));
    }

    /* ===== Gloss overlay (NO blur on UI content) ===== */
    .glow{
      position:fixed; inset:0; z-index:-1;
      background:
        radial-gradient(900px 600px at 50% 0%, rgba(125,211,252,.10), transparent 70%),
        radial-gradient(800px 800px at 15% 80%, rgba(96,165,250,.08), transparent 60%),
        radial-gradient(700px 700px at 85% 85%, rgba(125,211,252,.06), transparent 55%);
      pointer-events:none;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,.16); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,.25); }

    .app{
      height:100dvh;
      width:100%;
      max-width:1600px;
      margin:0 auto;
      display:flex;
      position:relative;
    }

    /* ===== Sidebar ===== */
    .sidebar{
      width:300px;
      flex-shrink:0;
      border-right:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,15,24,.65), rgba(10,15,24,.35));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      z-index:50;
      transition: transform .28s cubic-bezier(.4,0,.2,1);
    }

    .user-card{
      padding:20px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(16,24,38,.70), rgba(10,15,24,.25));
    }

    .profile-top{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .avatar{
      width:64px; height:64px;
      border-radius:18px;
      border:1px solid rgba(125,211,252,.35);
      background: rgba(0,0,0,.35);
      box-shadow:
        0 12px 40px rgba(0,0,0,.35),
        0 0 0 1px rgba(255,255,255,.06) inset;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      position:relative;
    }
    .avatar img{
      width:100%; height:100%; object-fit:cover;
      display:none;
    }
    .avatar .initials{
      font-family:var(--fontH);
      font-weight:700;
      letter-spacing:1px;
      color:#eaf2ff;
      font-size:20px;
      opacity:.9;
    }

    .me-info{ min-width:0; flex:1; }
    .me-name{
      font-family:var(--fontH);
      font-size:15px;
      letter-spacing:1px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .me-sub{
      margin-top:6px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      user-select:none;
    }
    .pill strong{
      color: var(--text);
      font-weight:700;
      letter-spacing:1px;
      font-family:var(--fontH);
      font-size:10px;
    }

    .status-dot{
      width:7px; height:7px; border-radius:50%;
      background: var(--warn);
      box-shadow: 0 0 12px rgba(250,204,21,.35);
    }
    .status-dot.connected{ background: var(--good); box-shadow: 0 0 12px rgba(74,222,128,.35); }
    .status-dot.disconnected{ background: var(--bad); box-shadow: 0 0 12px rgba(251,113,133,.35); }

    .card-actions{
      margin-top:14px;
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      color: var(--text);
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-family:var(--fontH);
      letter-spacing:1px;
      text-transform:uppercase;
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.35); background: rgba(0,0,0,.32); }
    .btn.danger{ border-color: rgba(251,113,133,.25); }
    .btn.danger:hover{ border-color: rgba(251,113,133,.45); }

    /* Area under hamburger: Online count then Music button (as requested) */
    .mini-panel{
      padding:14px 20px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      flex-direction:column;
      gap:10px;
      background: linear-gradient(180deg, rgba(12,18,30,.35), rgba(12,18,30,.15));
    }
    .mini-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .mini-title{
      font-family:var(--fontH);
      letter-spacing:1px;
      font-size:11px;
      color: var(--muted);
      text-transform:uppercase;
    }
    .mini-value{
      font-family:var(--fontH);
      letter-spacing:1px;
      font-size:11px;
      color: var(--text);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      min-width:52px;
      text-align:center;
    }

    .music-btn{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(125,211,252,.22);
      background: linear-gradient(135deg, rgba(96,165,250,.20), rgba(125,211,252,.10));
      color: var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      font-family:var(--fontH);
      letter-spacing:1px;
      text-transform:uppercase;
      font-size:11px;
      user-select:none;
    }
    .music-btn:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.40); }
    .music-state-dot{
      width:8px; height:8px; border-radius:50%;
      background: rgba(234,242,255,.25);
      box-shadow: 0 0 14px rgba(125,211,252,.20);
    }
    .music-on .music-state-dot{ background: var(--good); box-shadow: 0 0 14px rgba(74,222,128,.35); }
    .music-off .music-state-dot{ background: rgba(234,242,255,.25); }

    .online-users{
      flex:1;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .section-header{
      padding:14px 20px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-family:var(--fontH);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      color: var(--muted);
    }
    .users-list{
      flex:1;
      overflow:auto;
      padding:10px;
      min-height:0;
    }
    .user-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px;
      border-radius:12px;
      border:1px solid transparent;
      background: rgba(0,0,0,.10);
      margin-bottom:8px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .15s ease;
    }
    .user-item:hover{
      transform: translateY(-1px);
      background: rgba(0,0,0,.18);
      border-color: rgba(125,211,252,.18);
    }
    .u-ava{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      display:flex;align-items:center;justify-content:center;
      font-family:var(--fontH);
      font-size:11px;
      letter-spacing:1px;
      color: var(--text);
      overflow:hidden;
      flex-shrink:0;
    }
    .u-ava img{ width:100%;height:100%;object-fit:cover; display:none; }
    .u-info{ min-width:0; }
    .u-name{ font-size:13px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .u-role{ font-size:10px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-top:2px; }

    /* ===== Chat area ===== */
    .chat{
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
      position:relative;
    }
    .chat-header{
      height:64px;
      flex-shrink:0;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(16,24,38,.65), rgba(10,15,24,.25));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      gap:10px;
      z-index:10;
    }
    .left-head{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .hamburger{
      width:42px;height:42px;border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color: var(--text);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
      flex-shrink:0;
    }
    .hamburger:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.35); }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .brand h1{
      font-family:var(--fontH);
      font-size:16px;
      letter-spacing:2px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .badge-prem{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(125,211,252,.25);
      background: linear-gradient(135deg, rgba(96,165,250,.18), rgba(125,211,252,.08));
      font-family:var(--fontH);
      font-size:10px;
      letter-spacing:2px;
      text-transform:uppercase;
      color: var(--text);
      white-space:nowrap;
    }

    .right-head{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    .conn-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(74,222,128,.25);
      background: rgba(0,0,0,.20);
      font-family:var(--fontH);
      letter-spacing:2px;
      font-size:10px;
      text-transform:uppercase;
      color: rgba(74,222,128,.95);
    }
    .conn-pill.disc{
      border-color: rgba(251,113,133,.25);
      color: rgba(251,113,133,.95);
    }
    .conn-pill.conn{
      border-color: rgba(250,204,21,.25);
      color: rgba(250,204,21,.95);
    }

    .messages{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .sys{
      align-self:center;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:10px;
      text-align:center;
      max-width:92%;
    }

    .msg{
      display:flex;
      flex-direction:column;
      max-width:82%;
      animation: pop .18s ease;
    }
    .msg.own{ align-self:flex-end; align-items:flex-end; }
    .msg.other{ align-self:flex-start; align-items:flex-start; }

    @keyframes pop{
      from{ transform: translateY(6px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .meta{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
      color: var(--muted2);
      font-size:11px;
      letter-spacing:1px;
      text-transform:uppercase;
    }
    .meta .name{
      font-family:var(--fontH);
      letter-spacing:2px;
      color: var(--text);
      font-size:10px;
    }
    .role-badge{
      font-family:var(--fontH);
      font-size:9px;
      letter-spacing:2px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--muted);
    }
    .bubble{
      border-radius: 16px;
      padding:12px 14px;
      line-height:1.5;
      font-size:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
    }
    .msg.own .bubble{
      background: linear-gradient(135deg, rgba(96,165,250,.18), rgba(125,211,252,.08));
      border-color: rgba(125,211,252,.22);
    }
    .bubble img{
      max-width:100%;
      display:block;
      margin-top:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
    }

    /* Input */
    .input{
      flex-shrink:0;
      border-top:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(10,15,24,.25), rgba(16,24,38,.55));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding:12px 14px;
      display:flex;
      align-items:flex-end;
      gap:10px;
    }
    .input .wrap{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .file-preview{
      display:none;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size:12px;
      align-items:center;
      gap:10px;
    }
    .file-preview.active{ display:flex; }
    .file-preview .remove{ margin-left:auto; cursor:pointer; opacity:.8; }
    textarea{
      width:100%;
      min-height:52px;
      max-height:120px;
      resize:none;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.32);
      color: var(--text);
      outline:none;
      font-size:14px;
      transition: border-color .15s ease, background .15s ease;
    }
    textarea:focus{ border-color: rgba(125,211,252,.35); background: rgba(0,0,0,.38); }

    .btns{
      display:flex;
      gap:10px;
      flex-shrink:0;
    }
    .icon{
      width:52px;height:52px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease;
    }
    .icon:hover{ transform: translateY(-1px); border-color: rgba(125,211,252,.25); }
    .send{
      background: linear-gradient(135deg, rgba(96,165,250,.85), rgba(125,211,252,.70));
      border-color: rgba(125,211,252,.35);
      color:#07101e;
      font-weight:900;
    }
    .send:disabled, .icon:disabled, textarea:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    /* Typing */
    .typing{
      height:18px;
      padding:0 16px 10px;
      color: var(--muted2);
      font-size:11px;
      display:none;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    .typing .dots span{
      width:4px;height:4px;border-radius:999px;
      background: rgba(234,242,255,.45);
      display:inline-block;
      animation: bounce 1.2s infinite;
      margin-right:3px;
    }
    .typing .dots span:nth-child(2){ animation-delay:.15s; }
    .typing .dots span:nth-child(3){ animation-delay:.3s; }
    @keyframes bounce{ 0%,80%,100%{ transform: scale(.2); opacity:.4; } 40%{ transform: scale(1); opacity:1; } }

    /* Modal image */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.88);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:18px;
    }
    .modal.active{ display:flex; }
    .modal img{
      max-width:95%;
      max-height:90vh;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
    }

    /* Overlay for mobile sidebar */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      z-index:40;
    }
    .overlay.active{ display:block; }

    /* LOGIN / PROFILE modal */
    .gate{
      position:fixed; inset:0;
      z-index:3000;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .gate.active{ display:flex; }
    .gate-card{
      width:100%;
      max-width:520px;
      border-radius:18px;
      border:1px solid rgba(125,211,252,.18);
      background: linear-gradient(180deg, rgba(16,24,38,.75), rgba(10,15,24,.55));
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .gate-head{
      padding:18px 18px 12px;
      border-bottom:1px solid rgba(125,211,252,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .gate-title{
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:14px;
    }
    .gate-sub{
      padding:0 18px 14px;
      color: var(--muted);
      font-size:12px;
      line-height:1.6;
    }
    .gate-body{
      padding:16px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .field{
      flex:1;
      min-width:180px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      color: var(--text);
      outline:none;
      font-size:14px;
    }
    .field:focus{ border-color: rgba(125,211,252,.35); }
    .upload{
      flex:1;
      min-width:180px;
      padding:12px 12px;
      border-radius:14px;
      border:1px dashed rgba(125,211,252,.22);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .gate-footer{
      padding:14px 18px 18px;
      display:flex;
      gap:10px;
    }
    .primary{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:none;
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(125,211,252,.80));
      color:#07101e;
      font-weight:900;
    }
    .secondary{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: var(--text);
      cursor:pointer;
      font-family:var(--fontH);
      letter-spacing:2px;
      text-transform:uppercase;
      font-size:12px;
    }
    .hint{
      padding:0 18px 16px;
      color: var(--muted2);
      font-size:11px;
    }

    /* Mobile */
    @media (max-width: 900px){
      .sidebar{
        position:fixed;
        top:0; bottom:0; left:0;
        transform: translateX(-105%);
        width:280px;
        box-shadow: 18px 0 60px rgba(0,0,0,.55);
      }
      .sidebar.active{ transform: translateX(0); }
    }
  </style>
</head>

<body>
  <!-- Background -->
  <div class="bg-wrap">
    <canvas id="meteorCanvas"></canvas>
  </div>
  <div class="glow"></div>

  <!-- LOGIN / PROFILE GATE -->
  <div class="gate" id="gate">
    <div class="gate-card">
      <div class="gate-head">
        <div class="gate-title" id="gateTitle">LOGIN</div>
        <span class="pill"><span class="status-dot disconnected"></span><strong>Profile</strong></span>
      </div>
      <div class="gate-sub" id="gateSub">
        Masukin <b>username</b> & (opsional) <b>foto profil</b> biar tampil di chat.<br/>
        Data disimpan di browser kamu (localStorage).
      </div>
      <div class="gate-body">
        <div class="row">
          <input id="gateUsername" class="field" maxlength="20" placeholder="username (3-20) contoh: raraa_01" autocomplete="off"/>
          <label class="upload" for="gatePhoto">
            <i class="fa-solid fa-image"></i>
            <span id="photoLabel">Upload foto profil (opsional)</span>
          </label>
          <input id="gatePhoto" type="file" accept="image/*" style="display:none"/>
        </div>
      </div>
      <div class="gate-footer">
        <button class="primary" id="gateGo">Masuk</button>
        <button class="secondary" id="gateReset" title="hapus data login">Reset</button>
      </div>
      <div class="hint">
        Username hanya huruf/angka/underscore. Autoplay musik kadang diblokir browser—kalau tidak bunyi, tekan tombol MUSIC.
      </div>
    </div>
  </div>

  <!-- Mobile overlay -->
  <div class="overlay" id="overlay"></div>

  <!-- Image modal -->
  <div class="modal" id="imgModal">
    <img id="imgModalEl" alt="preview"/>
  </div>

  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="user-card">
        <div class="profile-top">
          <div class="avatar" id="meAvatar" role="button" tabindex="0" title="Edit profile">
            <img id="meAvatarImg" alt="me"/>
            <div class="initials" id="meInitials">ME</div>
          </div>
          <div class="me-info">
            <div class="me-name" id="meName">Loading...</div>
            <div class="me-sub">
              <span class="pill"><span class="status-dot" id="connDot"></span><strong id="connText">CONNECTING</strong></span>
              <span class="pill"><i class="fa-solid fa-user-shield"></i><strong id="meRole">USER</strong></span>
            </div>
          </div>
        </div>

        <div class="card-actions">
          <button class="btn" id="btnEdit"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
          <button class="btn danger" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
        </div>
      </div>

      <!-- Under hamburger: online count then music button -->
      <div class="mini-panel">
        <div class="mini-row">
          <div class="mini-title"><i class="fa-solid fa-users"></i> Online</div>
          <div class="mini-value" id="onlineCount">0</div>
        </div>

        <button class="music-btn music-off" id="musicBtn">
          <span class="music-state-dot" id="musicDot"></span>
          <span id="musicText">MUSIC OFF</span>
        </button>
      </div>

      <div class="online-users">
        <div class="section-header">
          <span>Online Users</span>
          <span id="onlineCountTop">0</span>
        </div>
        <div class="users-list" id="userList"></div>
      </div>
    </aside>

    <!-- CHAT -->
    <main class="chat">
      <header class="chat-header">
        <div class="left-head">
          <button class="hamburger" id="hamburger" aria-label="menu">
            <i class="fa-solid fa-bars"></i>
          </button>
          <div class="brand">
            <h1>LIVE CHAT</h1>
            <span class="badge-prem">PREMIUM</span>
          </div>
        </div>
        <div class="right-head">
          <div class="conn-pill conn" id="connPill"><i class="fa-solid fa-wifi"></i> CONNECTING</div>
        </div>
      </header>

      <section class="messages" id="messages">
        <div class="sys" id="welcome">
          <i class="fa-solid fa-circle-notch fa-spin"></i>
          Waiting for login...
        </div>
      </section>

      <div class="typing" id="typing">
        <div class="dots"><span></span><span></span><span></span></div>
        <div id="typingText">Someone is typing...</div>
      </div>

      <footer class="input">
        <div class="wrap">
          <div class="file-preview" id="filePreview">
            <i class="fa-solid fa-paperclip"></i>
            <span id="fileName" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;">file</span>
            <i class="fa-solid fa-xmark remove" id="fileRemove"></i>
          </div>
          <textarea id="msgInput" placeholder="Type message (or select image)..." disabled></textarea>
        </div>
        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none"/>
        <div class="btns">
          <button class="icon" id="attachBtn" disabled><i class="fa-solid fa-paperclip"></i></button>
          <button class="icon send" id="sendBtn" disabled><i class="fa-solid fa-paper-plane"></i></button>
        </div>
      </footer>
    </main>
  </div>

  <!-- Audio (loop) -->
  <audio id="bgm" preload="auto" loop>
    <source src="https://files.catbox.moe/wlny2m.mp3" type="audio/mpeg"/>
  </audio>

  <!-- IMPORTANT:
       Kalau backend socket kamu beda domain, taruh ini SEBELUM script utama (di bawah ini) -->
  <script>
    // ✅ taruh di sini (atau langsung di bawah <body>) sebelum code connectSocket jalan
    window.SOCKET_URL = "https://livechatscarrydeath.raraaprivate.my.id";
  </script>

  <!-- Socket.IO client via CDN -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>

  <script>
    /* =========================
       CONFIG + STORAGE
    ========================== */
    const SOCKET_URL = window.SOCKET_URL || window.location.origin;
    const KEY_USER  = "ic_username";
    const KEY_PHOTO = "ic_profile_photo"; // base64
    const KEY_ROLE  = "ic_role"; // default user

    const els = {
      gate: document.getElementById("gate"),
      gateTitle: document.getElementById("gateTitle"),
      gateSub: document.getElementById("gateSub"),
      gateUsername: document.getElementById("gateUsername"),
      gatePhoto: document.getElementById("gatePhoto"),
      photoLabel: document.getElementById("photoLabel"),
      gateGo: document.getElementById("gateGo"),
      gateReset: document.getElementById("gateReset"),

      sidebar: document.getElementById("sidebar"),
      overlay: document.getElementById("overlay"),
      hamburger: document.getElementById("hamburger"),

      meAvatar: document.getElementById("meAvatar"),
      meAvatarImg: document.getElementById("meAvatarImg"),
      meInitials: document.getElementById("meInitials"),
      meName: document.getElementById("meName"),
      meRole: document.getElementById("meRole"),
      btnEdit: document.getElementById("btnEdit"),
      btnLogout: document.getElementById("btnLogout"),

      onlineCount: document.getElementById("onlineCount"),
      onlineCountTop: document.getElementById("onlineCountTop"),
      userList: document.getElementById("userList"),

      connDot: document.getElementById("connDot"),
      connText: document.getElementById("connText"),
      connPill: document.getElementById("connPill"),

      messages: document.getElementById("messages"),
      welcome: document.getElementById("welcome"),
      typing: document.getElementById("typing"),
      typingText: document.getElementById("typingText"),

      msgInput: document.getElementById("msgInput"),
      sendBtn: document.getElementById("sendBtn"),
      attachBtn: document.getElementById("attachBtn"),
      fileInput: document.getElementById("fileInput"),
      filePreview: document.getElementById("filePreview"),
      fileName: document.getElementById("fileName"),
      fileRemove: document.getElementById("fileRemove"),

      imgModal: document.getElementById("imgModal"),
      imgModalEl: document.getElementById("imgModalEl"),

      musicBtn: document.getElementById("musicBtn"),
      musicText: document.getElementById("musicText"),
      musicDot: document.getElementById("musicDot"),
      bgm: document.getElementById("bgm"),

      meteorCanvas: document.getElementById("meteorCanvas"),
    };

    const myUser = {
      username: null,
      role: (localStorage.getItem(KEY_ROLE) || "user"),
      photo: null, // base64
    };

    let socket = null;
    let isConnected = false;
    let typingTimeout = null;
    let pingInterval = null;
    let lastPing = Date.now();

    let currentFile = null;
    let currentFileData = null;

    /* =========================
       UTIL
    ========================== */
    function escapeHtml(t){
      const d = document.createElement("div");
      d.textContent = String(t ?? "");
      return d.innerHTML;
    }
    function isValidUsername(name){
      return /^[A-Za-z0-9_]{3,20}$/.test(String(name || "").trim());
    }
    function initials(name){
      const s = String(name || "").trim();
      return (s.substring(0,2).toUpperCase() || "ME");
    }
    function enableInput(on){
      els.msgInput.disabled = !on;
      els.sendBtn.disabled = !on;
      els.attachBtn.disabled = !on;
      if(on) els.msgInput.focus();
    }
    function setConn(status, label){
      // status: connected | connecting | disconnected
      els.connDot.classList.remove("connected","disconnected");
      els.connPill.classList.remove("disc","conn");
      if(status === "connected"){
        els.connDot.classList.add("connected");
        els.connPill.innerHTML = `<i class="fa-solid fa-wifi"></i> ${label || "CONNECTED"}`;
      } else if(status === "connecting"){
        els.connPill.classList.add("conn");
        els.connPill.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${label || "CONNECTING"}`;
      } else {
        els.connDot.classList.add("disconnected");
        els.connPill.classList.add("disc");
        els.connPill.innerHTML = `<i class="fa-solid fa-wifi-slash"></i> ${label || "DISCONNECTED"}`;
      }
      els.connText.textContent = (label || status).toUpperCase();
    }

    function applyProfileUI(){
      els.meName.textContent = myUser.username || "Guest";
      els.meRole.textContent = String(myUser.role || "user").toUpperCase();
      els.meInitials.textContent = initials(myUser.username);

      if(myUser.photo){
        els.meAvatarImg.src = myUser.photo;
        els.meAvatarImg.style.display = "block";
        els.meInitials.style.display = "none";
      }else{
        els.meAvatarImg.removeAttribute("src");
        els.meAvatarImg.style.display = "none";
        els.meInitials.style.display = "block";
      }
    }

    /* =========================
       SIDEBAR TOGGLE
    ========================== */
    function sidebarOpen(open){
      const show = (open === undefined) ? !els.sidebar.classList.contains("active") : open;
      if(show){
        els.sidebar.classList.add("active");
        els.overlay.classList.add("active");
      }else{
        els.sidebar.classList.remove("active");
        els.overlay.classList.remove("active");
      }
    }

    /* =========================
       LOGIN / EDIT PROFILE
    ========================== */
    function openGate(mode){
      // mode: "login" | "edit"
      els.gate.classList.add("active");
      if(mode === "edit"){
        els.gateTitle.textContent = "EDIT PROFILE";
        els.gateSub.innerHTML = `Ubah <b>username</b> / <b>foto profil</b>. Akan langsung dipakai di chat.`;
        els.gateUsername.value = myUser.username || "";
        els.photoLabel.textContent = myUser.photo ? "Ganti foto profil (sudah ada)" : "Upload foto profil (opsional)";
      } else {
        els.gateTitle.textContent = "LOGIN";
        els.gateSub.innerHTML = `Masukin <b>username</b> & (opsional) <b>foto profil</b> biar tampil di chat.<br/>Data disimpan di browser kamu (localStorage).`;
        els.gateUsername.value = "";
        els.photoLabel.textContent = "Upload foto profil (opsional)";
      }
      setTimeout(()=> els.gateUsername.focus(), 50);
    }

    function closeGate(){
      els.gate.classList.remove("active");
    }

    async function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function doGateSave(){
      const name = String(els.gateUsername.value || "").trim();
      if(!isValidUsername(name)){
        alert("Username harus 3–20 karakter dan hanya huruf/angka/underscore.");
        els.gateUsername.focus();
        els.gateUsername.select();
        return;
      }

      myUser.username = name;
      localStorage.setItem(KEY_USER, name);

      // photo (optional)
      if(els.gatePhoto.files && els.gatePhoto.files[0]){
        const f = els.gatePhoto.files[0];
        if(!f.type.startsWith("image/")){
          alert("Foto profil harus gambar.");
          return;
        }
        if(f.size > 2 * 1024 * 1024){
          alert("Foto profil max 2MB biar ringan.");
          return;
        }
        myUser.photo = await fileToBase64(f);
        localStorage.setItem(KEY_PHOTO, myUser.photo);
      } else {
        // keep existing photo if edit mode and already saved
        const savedPhoto = localStorage.getItem(KEY_PHOTO);
        myUser.photo = savedPhoto ? savedPhoto : null;
      }

      applyProfileUI();
      closeGate();

      // if not connected, connect now
      if(!socket){
        connectSocket();
      }else{
        // update backend with new profile
        if(isConnected) socket.emit("chat:login", { username: myUser.username, role: myUser.role, photo: myUser.photo });
      }
    }

    function doLogout(){
      localStorage.removeItem(KEY_USER);
      localStorage.removeItem(KEY_PHOTO);
      // role keep
      myUser.username = null;
      myUser.photo = null;

      try{ if(socket) socket.disconnect(); }catch(_){}
      socket = null;
      isConnected = false;

      els.messages.innerHTML = "";
      els.messages.appendChild(els.welcome);
      els.welcome.style.display = "flex";
      els.welcome.innerHTML = `<i class="fa-solid fa-user-lock"></i> Please login (username)`;

      enableInput(false);
      setConn("disconnected","LOGIN REQUIRED");
      applyProfileUI();

      sidebarOpen(false);
      openGate("login");
    }

    /* =========================
       MUSIC (best-effort autoplay)
       - Browser sering blok autoplay suara.
       - Kita coba play saat load, kalau gagal user tinggal klik tombol MUSIC.
    ========================== */
    let musicOn = false;

    async function tryPlayMusic(){
      try{
        els.bgm.volume = 0.75;
        await els.bgm.play();
        setMusicState(true);
      }catch(err){
        // autoplay blocked
        setMusicState(false);
      }
    }

    function setMusicState(on){
      musicOn = !!on;
      els.musicBtn.classList.toggle("music-on", musicOn);
      els.musicBtn.classList.toggle("music-off", !musicOn);
      els.musicText.textContent = musicOn ? "MUSIC ON" : "MUSIC OFF";
    }

    async function toggleMusic(){
      try{
        if(musicOn){
          els.bgm.pause();
          setMusicState(false);
        }else{
          await els.bgm.play();
          setMusicState(true);
        }
      }catch(_){
        setMusicState(false);
        alert("Browser kamu blok autoplay. Coba klik lagi / unmute perangkat.");
      }
    }

    // make first user tap anywhere unlock audio (iOS)
    function installAudioUnlock(){
      const unlock = async () => {
        if(!musicOn){
          try{ await els.bgm.play(); setMusicState(true); }catch(_){}
        }
        window.removeEventListener("touchstart", unlock);
        window.removeEventListener("click", unlock);
      };
      window.addEventListener("touchstart", unlock, { once:true });
      window.addEventListener("click", unlock, { once:true });
    }

    /* =========================
       SOCKET
    ========================== */
    function connectSocket(){
      if(!window.io){
        setConn("disconnected","SOCKET CLIENT MISSING");
        return;
      }

      setConn("connecting","CONNECTING");
      enableInput(false);

      socket = io(SOCKET_URL, { transports:["websocket","polling"] });

      socket.on("connect", ()=>{
        isConnected = true;
        setConn("connected","CONNECTED");

        socket.emit("chat:login", {
          username: myUser.username,
          role: myUser.role,
          photo: myUser.photo
        });

        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-check"></i> Connected as ${escapeHtml(myUser.username)}`;
        setTimeout(()=> els.welcome.style.display = "none", 2000);

        enableInput(true);

        startPing();
      });

      socket.on("disconnect", ()=>{
        isConnected = false;
        setConn("disconnected","DISCONNECTED");
        enableInput(false);

        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Disconnected`;
        stopPing();
      });

      socket.on("connect_error", ()=>{
        isConnected = false;
        setConn("disconnected","CONNECT ERROR");
        enableInput(false);

        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Cannot connect to Socket server`;
      });

      socket.on("chat:history", (history)=>{
        els.messages.innerHTML = "";
        (history || []).forEach(m => m.image ? addImageMessage(m) : addMessage(m));
        scrollBottom();
      });

      socket.on("chat:newMessage", (msg)=>{
        addMessage(msg);
        scrollBottom();
      });

      socket.on("chat:image", (msg)=>{
        addImageMessage(msg);
        scrollBottom();
      });

      socket.on("chat:userTyping", (data)=>{
        if(!data) return;
        if(data.username !== myUser.username){
          els.typing.style.display = data.isTyping ? "flex" : "none";
          els.typingText.textContent = `${data.username} is typing...`;
        }
      });

      socket.on("chat:onlineUsers", (data)=>{
        const count = Number(data?.count ?? 0);
        els.onlineCount.textContent = count;
        els.onlineCountTop.textContent = count;
        renderUserList(data?.users || []);
      });

      socket.on("chat:userJoin", (data)=>{
        const name = escapeHtml(data?.username || "someone");
        systemMsg(`${name} joined`);
        const count = Number(data?.onlineCount ?? 0);
        els.onlineCount.textContent = count;
        els.onlineCountTop.textContent = count;
      });

      socket.on("chat:userLeave", (data)=>{
        const name = escapeHtml(data?.username || "someone");
        systemMsg(`${name} left`);
        const count = Number(data?.onlineCount ?? 0);
        els.onlineCount.textContent = count;
        els.onlineCountTop.textContent = count;
      });

      socket.on("pong", ()=>{
        // optional ping
        // const ms = Date.now() - lastPing;
      });
    }

    function startPing(){
      stopPing();
      pingInterval = setInterval(()=>{
        if(!socket || !isConnected) return;
        lastPing = Date.now();
        socket.emit("ping");
      }, 5000);
    }
    function stopPing(){
      if(pingInterval) clearInterval(pingInterval);
      pingInterval = null;
    }

    /* =========================
       CHAT UI
    ========================== */
    function scrollBottom(){
      els.messages.scrollTop = els.messages.scrollHeight;
    }

    function systemMsg(text){
      const d = document.createElement("div");
      d.className = "sys";
      d.innerHTML = `<i class="fa-solid fa-bolt"></i> ${text}`;
      els.messages.appendChild(d);
      scrollBottom();
      setTimeout(()=> d.remove(), 4500);
    }

    function addMessage(data){
      const isOwn = (data?.username === myUser.username);
      const msg = document.createElement("div");
      msg.className = `msg ${isOwn ? "own" : "other"}`;

      const time = new Date(data?.timestamp || Date.now())
        .toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});

      const role = String(data?.role || "user").toUpperCase();

      // photo handling:
      // - for own messages: always use local stored photo if exists
      // - for other: use data.photo if server sends it
      const photo = isOwn ? myUser.photo : (data?.photo || null);

      msg.innerHTML = `
        <div class="meta">
          <span class="name">${escapeHtml(data?.username || "")}</span>
          <span class="role-badge">${escapeHtml(role)}</span>
          <span>${time}</span>
        </div>
        <div class="bubble">${escapeHtml(data?.message || "").replace(/\n/g,"<br>")}</div>
      `;

      // small avatar next to bubble (optional aesthetic)
      // (kept simple—biar gak bentrok di mobile)
      els.messages.appendChild(msg);
    }

    function addImageMessage(data){
      const isOwn = (data?.username === myUser.username);
      const msg = document.createElement("div");
      msg.className = `msg ${isOwn ? "own" : "other"}`;

      const time = new Date(data?.timestamp || Date.now())
        .toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});

      const role = String(data?.role || "user").toUpperCase();
      const caption = data?.message ? `<div style="margin-bottom:8px">${escapeHtml(data.message).replace(/\n/g,"<br>")}</div>` : "";
      const img = data?.image ? `<img src="${data.image}" data-preview="1" alt="image"/>` : "";

      msg.innerHTML = `
        <div class="meta">
          <span class="name">${escapeHtml(data?.username || "")}</span>
          <span class="role-badge">${escapeHtml(role)}</span>
          <span>${time}</span>
        </div>
        <div class="bubble">
          ${caption}
          ${img}
        </div>
      `;

      els.messages.appendChild(msg);

      const im = msg.querySelector('img[data-preview="1"]');
      if(im){
        im.addEventListener("click", ()=>{
          els.imgModalEl.src = data.image;
          els.imgModal.classList.add("active");
        });
      }
    }

    function renderUserList(users){
      els.userList.innerHTML = "";
      const order = { owner:0, admin:1, user:2 };
      users.slice().sort((a,b)=> (order[a.role]??99)-(order[b.role]??99)).forEach(u=>{
        const item = document.createElement("div");
        item.className = "user-item";

        const name = String(u.username || "");
        const role = String(u.role || "user").toUpperCase();
        const photo = u.photo || null;

        item.innerHTML = `
          <div class="u-ava">
            <img alt="u" />
            <div class="u-in">${escapeHtml(initials(name))}</div>
          </div>
          <div class="u-info">
            <div class="u-name">${escapeHtml(name)}</div>
            <div class="u-role">${escapeHtml(role)}</div>
          </div>
        `;

        const ava = item.querySelector(".u-ava");
        const img = item.querySelector(".u-ava img");
        const inits = item.querySelector(".u-in");

        if(photo){
          img.src = photo;
          img.style.display = "block";
          inits.style.display = "none";
        }else{
          img.style.display = "none";
          inits.style.display = "block";
        }

        els.userList.appendChild(item);
      });
    }

    /* =========================
       SEND + FILE
    ========================== */
    function sendMessage(){
      if(!socket || !isConnected) return;

      const text = String(els.msgInput.value || "").trim();
      if(!text && !currentFile) return;

      if(currentFile){
        socket.emit("chat:image", {
          image: currentFileData,
          filename: currentFile.name,
          message: text,
          username: myUser.username,
          role: myUser.role,
          photo: myUser.photo
        });
        clearFile();
      }else{
        socket.emit("chat:message", {
          message: text,
          username: myUser.username,
          role: myUser.role,
          photo: myUser.photo
        });
      }

      els.msgInput.value = "";
      els.msgInput.style.height = "auto";
    }

    function handleFileSelect(e){
      const f = e.target.files && e.target.files[0];
      if(!f) return;

      const ok = f.type.startsWith("image/") || f.type.startsWith("video/");
      if(!ok) return alert("Hanya boleh image/video");
      if(f.size > 10*1024*1024) return alert("Max 10MB");

      currentFile = f;
      els.filePreview.classList.add("active");
      els.fileName.textContent = f.name;

      const r = new FileReader();
      r.onload = (ev)=> currentFileData = ev.target.result;
      r.readAsDataURL(f);
    }

    function clearFile(){
      currentFile = null;
      currentFileData = null;
      els.filePreview.classList.remove("active");
      els.fileInput.value = "";
    }

    /* =========================
       METEOR BACKGROUND (Canvas)
    ========================== */
    function setupMeteors(){
      const c = els.meteorCanvas;
      const ctx = c.getContext("2d", { alpha:true });

      function resize(){
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        c.width = Math.floor(window.innerWidth * dpr);
        c.height = Math.floor(window.innerHeight * dpr);
        c.style.width = window.innerWidth + "px";
        c.style.height = window.innerHeight + "px";
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize);

      const stars = [];
      const meteors = [];

      function rand(min,max){ return Math.random()*(max-min)+min; }

      const STAR_COUNT = Math.min(220, Math.floor((window.innerWidth*window.innerHeight)/7000));
      for(let i=0;i<STAR_COUNT;i++){
        stars.push({
          x: rand(0, window.innerWidth),
          y: rand(0, window.innerHeight),
          r: rand(.4, 1.4),
          a: rand(.15, .85),
          tw: rand(.002, .008)
        });
      }

      function spawnMeteor(){
        const startX = rand(-200, window.innerWidth*0.85);
        const startY = rand(-120, window.innerHeight*0.35);
        const len = rand(140, 320);
        const speed = rand(2.1, 4.0); // slow-ish
        const angle = rand(0.68, 0.86); // ~ 39-49 deg
        meteors.push({
          x:startX, y:startY,
          vx: Math.cos(angle)*speed,
          vy: Math.sin(angle)*speed,
          len,
          life: rand(180, 320),
          w: rand(1.2, 2.2),
          glow: rand(.25, .55),
        });
        if(meteors.length>18) meteors.shift();
      }

      let tick = 0;

      function draw(){
        tick++;

        ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

        // star field
        for(const s of stars){
          s.a += (Math.random() < 0.5 ? -1 : 1) * s.tw;
          if(s.a<0.08) s.a=0.08;
          if(s.a>0.95) s.a=0.95;

          ctx.beginPath();
          ctx.fillStyle = `rgba(180, 220, 255, ${s.a})`;
          ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
          ctx.fill();
        }

        // spawn meteors
        if(tick % 22 === 0 && Math.random() < 0.65) spawnMeteor(); // banyak tapi tetap smooth

        // meteors
        for(let i=meteors.length-1;i>=0;i--){
          const m = meteors[i];
          m.x += m.vx;
          m.y += m.vy;
          m.life -= 1;

          const dx = -m.vx;
          const dy = -m.vy;
          const mag = Math.hypot(dx,dy) || 1;
          const nx = dx/mag, ny = dy/mag;

          const tx = m.x + nx*m.len;
          const ty = m.y + ny*m.len;

          const grad = ctx.createLinearGradient(m.x, m.y, tx, ty);
          grad.addColorStop(0, `rgba(125, 211, 252, ${0.85*m.glow})`);
          grad.addColorStop(0.25, `rgba(96, 165, 250, ${0.55*m.glow})`);
          grad.addColorStop(1, `rgba(125, 211, 252, 0)`);

          ctx.lineWidth = m.w;
          ctx.strokeStyle = grad;
          ctx.beginPath();
          ctx.moveTo(m.x, m.y);
          ctx.lineTo(tx, ty);
          ctx.stroke();

          // head glow
          ctx.beginPath();
          ctx.fillStyle = `rgba(180, 230, 255, ${0.35*m.glow})`;
          ctx.arc(m.x, m.y, 3.2, 0, Math.PI*2);
          ctx.fill();

          if(m.life <= 0 || m.x > window.innerWidth+500 || m.y > window.innerHeight+500){
            meteors.splice(i,1);
          }
        }

        requestAnimationFrame(draw);
      }
      requestAnimationFrame(draw);
    }

    /* =========================
       INIT
    ========================== */
    function init(){
      setupMeteors();

      // textarea autoresize
      els.msgInput.addEventListener("input", function(){
        this.style.height = "auto";
        this.style.height = this.scrollHeight + "px";
      });

      // UI events
      els.hamburger.addEventListener("click", ()=> sidebarOpen(true));
      els.overlay.addEventListener("click", ()=> sidebarOpen(false));
      document.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          els.imgModal.classList.remove("active");
          sidebarOpen(false);
        }
      });

      els.imgModal.addEventListener("click", ()=> els.imgModal.classList.remove("active"));

      els.attachBtn.addEventListener("click", ()=> els.fileInput.click());
      els.fileInput.addEventListener("change", handleFileSelect);
      els.fileRemove.addEventListener("click", clearFile);

      els.sendBtn.addEventListener("click", sendMessage);
      els.msgInput.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          sendMessage();
        }
      });

      els.msgInput.addEventListener("input", ()=>{
        if(!socket || !isConnected) return;
        if(typingTimeout) clearTimeout(typingTimeout);
        socket.emit("chat:typing", true);
        typingTimeout = setTimeout(()=> socket.emit("chat:typing", false), 900);
      });

      // profile open (avatar click)
      els.meAvatar.addEventListener("click", ()=> openGate("edit"));
      els.btnEdit.addEventListener("click", ()=> openGate("edit"));
      els.btnLogout.addEventListener("click", doLogout);

      // gate actions
      els.gateGo.addEventListener("click", doGateSave);
      els.gateUsername.addEventListener("keydown", (e)=>{ if(e.key==="Enter") doGateSave(); });
      els.gateReset.addEventListener("click", ()=>{
        localStorage.removeItem(KEY_USER);
        localStorage.removeItem(KEY_PHOTO);
        els.gateUsername.value = "";
        els.gatePhoto.value = "";
        els.photoLabel.textContent = "Upload foto profil (opsional)";
        alert("Data login dihapus. Silakan isi lagi.");
      });
      els.gatePhoto.addEventListener("change", ()=>{
        const f = els.gatePhoto.files && els.gatePhoto.files[0];
        if(!f) return;
        els.photoLabel.textContent = `Foto: ${f.name}`;
      });

      // music
      els.musicBtn.addEventListener("click", toggleMusic);
      installAudioUnlock();     // iOS helper
      tryPlayMusic();           // best-effort autoplay

      // load stored profile
      const savedName = (localStorage.getItem(KEY_USER) || "").trim();
      const savedPhoto = (localStorage.getItem(KEY_PHOTO) || "").trim();
      myUser.photo = savedPhoto || null;

      if(isValidUsername(savedName)){
        myUser.username = savedName;
        applyProfileUI();
        setConn("connecting","CONNECTING");
        connectSocket();
      }else{
        myUser.username = null;
        applyProfileUI();
        enableInput(false);
        setConn("disconnected","LOGIN REQUIRED");
        els.welcome.style.display = "flex";
        els.welcome.innerHTML = `<i class="fa-solid fa-user-lock"></i> Please login (username)`;
        openGate("login");
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
